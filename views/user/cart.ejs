<%- include('../../views/partials/user/header') %>

<style>
  
    :root {
       
        --bg-body: #ffffff;
        --bg-surface: #f8f9fa;      
        --text-main: #121212;
        --text-muted: #666666;
        --border-color: #e5e5e5;
        --hover-bg: #f0f0f0;
        
        --brand-gold: #d4af37;       
        --brand-gold-hover: #b5952f;
        --btn-text: #ffffff;
        
        --danger: #dc3545;
        --shadow: 0 4px 15px rgba(0,0,0,0.05);
        --input-bg: #ffffff;
    }

    body.dark-mode {
       
        --bg-body: #0a0a0a;         
        --bg-surface: #171717;       
        --text-main: #ededed;       
        --text-muted: #a3a3a3;       
        --border-color: #2e2e2e;    
        --hover-bg: #262626;         
        
        --brand-gold: #e2c055;       
        --brand-gold-hover: #d4af37;
        --btn-text: #000000;       
        
        --danger: #ff6b6b;           
        --shadow: 0 4px 20px rgba(0,0,0,0.4);
        --input-bg: #0f0f0f;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
        background-color: var(--bg-body) !important;
        color: var(--text-main) !important;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        transition: background-color 0.3s ease, color 0.3s ease;
    }

    .cart-page {
        max-width: 1200px;
        margin: 0 auto;
        padding: 40px 20px;
    }

    .page-header { margin-bottom: 30px; }

    .page-header h1 {
        font-size: 2rem;
        font-weight: 700;
        color: var(--text-main);
        letter-spacing: -0.5px;
    }

    .breadcrumb { font-size: 0.9rem; color: var(--text-muted); margin-bottom: 5px; }
    .breadcrumb a { color: var(--text-muted); text-decoration: none; transition: 0.2s; }
    .breadcrumb a:hover { color: var(--brand-gold); }

    .cart-container {
        display: grid;
        grid-template-columns: 1fr 380px;
        gap: 30px;
        align-items: start;
    }


    .cart-items-section {
        background: var(--bg-surface);
        border-radius: 16px;
        box-shadow: var(--shadow);
        border: 1px solid var(--border-color);
        overflow: hidden; 
    }

    .cart-item {
        display: grid;
        grid-template-columns: 120px 1fr auto;
        gap: 25px;
        padding: 30px;
        border-bottom: 1px solid var(--border-color);
        background: var(--bg-surface);
        transition: background-color 0.2s ease;
    }

    .cart-item:last-child { border-bottom: none; }
    
   
    .cart-item.unavailable-item, 
    .cart-item.out-of-stock-qty-issue {
        background-color: rgba(220, 53, 69, 0.08); 
    }

    
    .product-image-wrapper {
        width: 120px;
        height: 120px;
        border-radius: 12px;
        overflow: hidden;
        background: var(--hover-bg);
        border: 1px solid var(--border-color);
        position: relative;
    }
    .product-image { width: 100%; height: 100%; object-fit: cover; }

    .unavailable-overlay {
        position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0, 0, 0, 0.7);
        backdrop-filter: blur(2px);
        display: flex; align-items: center; justify-content: center;
        color: white; font-weight: 700; font-size: 0.8rem;
        text-align: center; padding: 5px; text-transform: uppercase;
    }

    /* Product Info */
    .product-details { display: flex; flex-direction: column; gap: 6px; }
    
    .product-name {
        font-size: 1.15rem;
        font-weight: 700;
        color: var(--text-main);
    }

    .variant-info { color: var(--text-muted); font-size: 0.9rem; }
    .variant-info strong { color: var(--text-main); }

    
    .stock-info { font-size: 0.85rem; font-weight: 600; display: flex; align-items: center; gap: 6px; }
    .stock-info i { font-size: 1rem; }
    
    .stock-info { color: #2ecc71; } 
    .stock-info.low-stock { color: #f1c40f; } 
    .stock-info.unavailable { color: var(--danger); } 

   
    .price-info { display: flex; align-items: center; gap: 12px; margin-top: 5px; }
    
    .current-price {
        font-size: 1.25rem;
        font-weight: 700;
        color: var(--text-main);
    }
    
    .original-price {
        font-size: 0.95rem;
        color: var(--text-muted);
        text-decoration: line-through;
    }
    
    .quantity-control {
        display: flex; align-items: center; gap: 0;
        margin-top: 15px;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        width: fit-content;
        background: var(--input-bg);
        overflow: hidden;
    }

    .quantity-control button {
        width: 36px; height: 36px;
        background: transparent;
        border: none;
        color: var(--text-main);
        cursor: pointer;
        font-size: 1.1rem;
        transition: 0.2s;
    }
    .quantity-control button:hover:not(:disabled) { background: var(--hover-bg); color: var(--brand-gold); }
    .quantity-control button:disabled { opacity: 0.3; cursor: not-allowed; }

    .quantity-control input {
        width: 45px; text-align: center;
        border: none;
        background: transparent;
        color: var(--text-main);
        font-weight: 600;
        font-size: 1rem;
        -moz-appearance: textfield;
    }
   
    .quantity-control input::-webkit-outer-spin-button,
    .quantity-control input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }

   
    .item-actions {
        display: flex; flex-direction: column;
        align-items: flex-end; justify-content: space-between;
        height: 100%;
    }

    .item-total {
        font-size: 1.3rem; font-weight: 700;
        color: var(--brand-gold); 
    }

    .action-buttons { display: flex; flex-direction: column; gap: 10px; align-items: flex-end; }

    .remove-button, .wishlist-button {
        background: transparent; border: none;
        cursor: pointer;
        font-size: 0.85rem; font-weight: 500;
        display: flex; align-items: center; gap: 6px;
        transition: 0.2s; padding: 5px 0;
    }

    .remove-button { color: var(--text-muted); }
    .remove-button:hover { color: var(--danger); }
    
    .wishlist-button { color: var(--brand-gold); }
    .wishlist-button:hover { text-decoration: underline; }

    
    .cart-summary {
        background: var(--bg-surface);
        border-radius: 16px;
        padding: 30px;
        box-shadow: var(--shadow);
        border: 1px solid var(--border-color);
        position: sticky; top: 100px;
    }

    .cart-summary h3 {
        font-size: 1.4rem; font-weight: 700;
        color: var(--text-main); margin-bottom: 25px;
        padding-bottom: 15px; border-bottom: 1px solid var(--border-color);
    }

    .summary-row {
        display: flex; justify-content: space-between;
        margin-bottom: 15px; font-size: 1rem;
    }

    .summary-label { color: var(--text-muted); }
    .summary-value { color: var(--text-main); font-weight: 600; }

    .summary-row:last-of-type {
        margin-top: 20px; padding-top: 20px;
        border-top: 2px dashed var(--border-color);
        font-size: 1.3rem;
    }
    
    .summary-row:last-of-type .summary-value { color: var(--brand-gold); }

    
    .checkout-button {
        width: 100%;
        padding: 16px;
        background-color: var(--brand-gold);
        color: var(--btn-text);
        border: none;
        border-radius: 8px;
        font-size: 1.1rem; font-weight: 700;
        cursor: pointer;
        margin-top: 25px;
        transition: all 0.3s ease;
        text-transform: uppercase; letter-spacing: 1px;
        box-shadow: 0 4px 15px rgba(212, 175, 55, 0.3); 
    }

    .checkout-button:hover:not(:disabled) {
        background-color: var(--brand-gold-hover);
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(212, 175, 55, 0.4);
    }
    .checkout-button:disabled { background-color: var(--border-color); color: var(--text-muted); box-shadow: none; cursor: not-allowed; }

    
    .unavailable-notice, .blocked-notice {
        padding: 15px; border-radius: 8px; margin-bottom: 20px; font-size: 0.9rem;
    }
    .unavailable-notice { background: rgba(241, 196, 15, 0.15); color: #f1c40f; border: 1px solid rgba(241, 196, 15, 0.3); }
    .blocked-notice { background: rgba(220, 53, 69, 0.15); color: var(--danger); border: 1px solid rgba(220, 53, 69, 0.3); }
    
    .blocked-notice strong { color: var(--danger); }
    .blocked-notice i { color: var(--danger); }

    
    .empty-state {
        text-align: center; padding: 80px 20px;
        background: var(--bg-surface);
        border-radius: 16px; border: 1px solid var(--border-color);
    }
    .empty-state i { font-size: 80px; color: var(--border-color); margin-bottom: 20px; }
    .empty-state h2 { color: var(--text-main); margin-bottom: 10px; }
    
    .shop-button {
        background: var(--text-main); color: var(--bg-body);
        padding: 12px 30px; border-radius: 30px;
        font-weight: 600; text-decoration: none;
        display: inline-block; transition: 0.3s;
    }
    .shop-button:hover { background: var(--brand-gold); color: black; transform: translateY(-2px); }


    @media (max-width: 992px) {
        .cart-container { grid-template-columns: 1fr; }
        .cart-summary { position: static; margin-top: 20px; }
    }

    @media (max-width: 576px) {
        .cart-item {
            grid-template-columns: 90px 1fr;
            grid-template-areas: "img details" "img actions";
            padding: 20px;
        }
        .product-image-wrapper { grid-area: img; width: 90px; height: 90px; }
        .product-details { grid-area: details; }
        .item-actions { 
            grid-area: actions; 
            flex-direction: row; 
            align-items: center; 
            margin-top: 10px; 
            width: 100%;
        }
        .item-total { font-size: 1.1rem; }
    }
</style>

<div class="cart-page">
  <div class="page-header">
    <div class="breadcrumb">
      <a href="/">Home</a> / <span>Cart</span>
    </div>
    <h1><i class="fas fa-shopping-cart"></i> Cart</h1>
  </div>

  <% if (cartItems && cartItems.length > 0) { %>
  <div class="cart-container">
    <div class="cart-items-section">
      <%
      cartItems.forEach(item => {
      const isOutOfStock = item.isOutOfStock;
      const isBlocked = item.isBlocked;
      const isUnavailable = isOutOfStock || isBlocked;
      const maxQtyPerOrder = 5;
      const availableQty = item.availableQty;
      %>
      <div class="cart-item <%= isUnavailable ? 'unavailable-item' : '' %>"
        data-product-id="<%= item.productId._id %>"
        data-variant-size="<%= item.variant.size %>"
        data-unavailable="<%= isUnavailable %>"
        data-out-of-stock="<%= isOutOfStock %>"
        data-blocked="<%= isBlocked %>"
        data-block-reason="<%= item.blockReason || '' %>"
        data-product-name="<%= item.productId.productName || 'Unknown Product' %>">

        <!-- Product Image -->
        <div class="product-image-wrapper">
          <% if (item.productId && item.productId.images &&
          item.productId.images.length > 0) { %>
          <img src="<%= item.productId.images[0] %>"
            alt="<%= item.productId.productName %>" class="product-image">
          <% } else { %>
          <img src="https://via.placeholder.com/120x120?text=No+Image"
            alt="No Image" class="product-image">
          <% } %>

          <% if (isBlocked) { %>
          <div class="unavailable-overlay">
            <% if (item.blockReason && item.blockReason.includes('Brand')) { %>
            BRAND BLOCKED
            <% } else if (item.blockReason &&
            item.blockReason.includes('Category')) { %> CATEGORY BLOCKED
            <% } else { %> PRODUCT BLOCKED <% } %>
          </div>
          <% } else if (isOutOfStock) { %>
          <div class="unavailable-overlay">OUT OF STOCK</div>
          <% } %>
        </div>

        <!-- Product Details -->
        <div class="product-details">
          <h3 class="product-name"><%= item.productId.productName ||
            'Unknown Product' %></h3>

          <div class="product-meta">
            <% if (item.variant.size) { %>
            <span class="variant-info"><strong>Variant:</strong> <%=
              item.variant.size %> ml</span>
            <% } %>
          </div>

          <% if (isBlocked) { %>
          <span class="stock-info unavailable">
            <i class="fas fa-ban"></i>
            <% if (item.blockReason && item.blockReason.includes('Product')) {
            %>
            Product Blocked by Admin
            <% } else if (item.blockReason &&
            item.blockReason.includes('Brand')) { %>
            Brand Blocked by Admin
            <% } else if (item.blockReason &&
            item.blockReason.includes('Category')) { %>
            Category Blocked by Admin
            <% } else { %>
            Temporarily Blocked
            <% } %>
          </span>
          <% } else if (isOutOfStock) { %>
          <span class="stock-info unavailable">
            <i class="fas fa-times-circle"></i> Out of Stock
          </span>
          <% } else if (item.productId.stock <= 5) { %>
          <span class="stock-info low-stock">
            <i class="fas fa-exclamation-triangle"></i> Only <%=
            item.productId.stock %> left
          </span>
          <% } else { %>
          <span class="stock-info">
            <i class="fas fa-check-circle"></i> In Stock
          </span>
          <% } %>

          <div class="price-info">
            <span class="current-price">₹<%= (item.variant.salePrice ||
              item.price).toLocaleString() %></span>
            <% if (item.variant.regularPrice && item.variant.salePrice <
            item.variant.regularPrice) { %>
            <span class="original-price">₹<%=
              item.variant.regularPrice.toLocaleString() %></span>
            <% } %>
          </div>

          <div class="quantity-control">
            <button
              <%=isUnavailable || item.quantity <=1 ? 'disabled' : '' %>
              id="minus-btn-<%= item.productId._id %>-<%= item.variant.size %>"
              onclick="changeQuantity('<%= item.productId._id %>', '<%=
              item.variant.size %>', -1, <%= availableQty %>, <%= item.quantity
              %>)">
              −
            </button>
            <input
              id="qty-<%= item.productId._id %>-<%= item.variant.size %>"
              type="number"
              value="<%= item.quantity %>"
              min="1"
              max="<%= availableQty %>"
              readonly
              <%=isUnavailable ? 'disabled' : '' %>>
            <button
              <%=isUnavailable || item.quantity>= availableQty ? 'disabled' : ''
              %>
              id="plus-btn-<%= item.productId._id %>-<%= item.variant.size %>"
              onclick="changeQuantity('<%= item.productId._id %>', '<%=
              item.variant.size %>', 1, <%= availableQty %>, <%= item.quantity
              %>)">
              +
            </button>
          </div>

          <div data-stock-message style="display: none;"></div>

          <% if (!isUnavailable && item.quantity >= maxQtyPerOrder) { %>
          <small style="color: #ffc107; font-size: 0.8rem;">
            <i class="fas fa-info-circle"></i> Maximum <%= maxQtyPerOrder %>
            items per order
          </small>
          <% } %>
        </div>

        <!-- Item Actions -->
        <div class="item-actions">
          <div class="item-total"
            id="subtotal-<%= item.productId._id %>-<%= item.variant.size %>">
            ₹<%= ((item.variant.salePrice || item.price) *
            item.quantity).toLocaleString() %>
          </div>

          <div class="action-buttons">
            <button class="wishlist-button"
              onclick="moveToWishlist('<%= item.productId._id %>', '<%= item.variant.size %>')">
              <i class="fas fa-heart"></i> Wishlist
            </button>

            <button class="remove-button"
              onclick="removeFromCart('<%= item.productId._id %>', '<%= item.variant.size %>')">
              <i class="fas fa-trash"></i> Remove
            </button>
          </div>

        </div>
      </div>
      <% }); %>
    </div>

    <!-- Cart Summary -->
    <div class="cart-summary">
      <h3>Cart Total</h3>

      <% if (outOfStockCount > 0) { %>
      <div class="unavailable-notice">
        <i class="fas fa-exclamation-triangle"></i>
        <strong><%= outOfStockCount %></strong> product<%= outOfStockCount > 1 ?
        's are' : ' is' %> out of stock
      </div>
      <% } %>

      <% if (blockedCount > 0 && blockedProducts && blockedProducts.length > 0)
      { %>
      <div class="blocked-notice">
        <div style="display: flex; align-items: flex-start; gap: 10px;">
          <i class="fas fa-ban" style="margin-top: 2px; flex-shrink: 0;"></i>
          <div style="flex: 1;">
            <strong style="display: block; margin-bottom: 8px;">
              <strong><%= blockedCount %></strong> product<%= blockedCount > 1 ?
              's are' : ' is' %> temporarily blocked by admin
            </strong>
            <div style="font-size: 0.85rem; line-height: 1.6;">
              <% blockedProducts.forEach((product, index) => { %>
              <div style="margin-bottom: 5px;">
                • <%= product.reason %>
              </div>
              <% }); %>
            </div>
            <div
              style="margin-top: 10px; font-size: 0.85rem; color: #dc3545; font-weight: 500;">
              ⚠️ Please remove these items before proceeding to checkout
            </div>
          </div>
        </div>
      </div>
      <% } %>

      <div class="summary-row">
        <span class="summary-label">Subtotal:</span>
        <span class="summary-value" id="cart-subtotal">₹<%=
          totalPrice.toLocaleString() %></span>
      </div>

      <div class="summary-row">
        <span class="summary-label">Shipping:</span>
        <span class="summary-value">₹49</span>
      </div>

      <div class="summary-row">
        <span class="summary-label">Total:</span>
        <span class="summary-value" id="cart-total">₹<%= (totalPrice +
          49).toLocaleString() %></span>
      </div>

      <button id="checkout-button" class="checkout-button"
        onclick="proceedToCheckout()">
        Proceed to checkout
      </button>
    </div>
  </div>

  <% } else { %>
  <div class="empty-state">
    <i class="fas fa-shopping-cart"></i>
    <h2>Your Cart is Empty</h2>
    <p>Add some amazing products to your cart!</p>
    <a href="/shopPage" class="shop-button">
      Start Shopping
    </a>
  </div>
  <% } %>
</div>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
  const MAX_QTY_PER_ORDER = 5;

  
  async function validateAllCartStock() {
    const cartItems = document.querySelectorAll('.cart-item');
    let hasStockIssues = false;

    console.log('Validating ' + cartItems.length + ' items...');

    for (const item of cartItems) {

      if (item.getAttribute('data-blocked') === 'true') {
    
    const stockMessage = item.querySelector('[data-stock-message]');
    if (stockMessage) stockMessage.style.display = 'none';
    item.classList.remove('out-of-stock-qty-issue');
    continue; 
  }
      const productId = item.getAttribute('data-product-id');
      const variantSize = item.getAttribute('data-variant-size');
      
      console.log('Checking:', { productId, variantSize });

      if (!productId || !variantSize) {
        console.warn('Missing productId or variantSize');
        continue;
      }

      const quantityInput = document.getElementById(`qty-${productId}-${variantSize}`);
      const currentQty = parseInt(quantityInput?.value) || 0;

      if (currentQty <= 0) continue;

      try {
        const response = await fetch('/cart/validate-stock', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            productId: productId, 
            variantSize: Number(variantSize), 
            quantity: currentQty 
          })
        });

        const data = await response.json();
        console.log('Stock response:', data);

        const stockMessage = item.querySelector('[data-stock-message]');

        if (!data.isValid) {
          hasStockIssues = true;
          
          item.setAttribute('data-out-of-stock-qty', 'true');
          item.classList.add('out-of-stock-qty-issue');

          if (stockMessage) {
            stockMessage.style.display = 'block';
            stockMessage.innerHTML = `⚠️ Out of Stock - You have ${currentQty} items, but only ${data.stock} available. Please reduce quantity.`;
            stockMessage.classList.add('stock-warning');
          }
        } else {
          item.setAttribute('data-out-of-stock-qty', 'false');
          item.classList.remove('out-of-stock-qty-issue');

          if (stockMessage) {
            stockMessage.style.display = 'none';
            stockMessage.innerHTML = '';
            stockMessage.classList.remove('stock-warning');
          }
        }
      } catch (error) {
        console.error('Stock validation error:', error);
      }
    }

    const checkoutBtn = document.getElementById('checkout-button');
    if (checkoutBtn) {
      checkoutBtn.disabled = hasStockIssues;
      checkoutBtn.style.opacity = hasStockIssues ? '0.5' : '1';
      checkoutBtn.style.cursor = hasStockIssues ? 'not-allowed' : 'pointer';
    }

    console.log('Validation complete. Has issues:', hasStockIssues);
  }

  document.addEventListener('DOMContentLoaded', () => {
    console.log('DOM loaded, starting validation...');
    validateAllCartStock();
  });

  function changeQuantity(productId, variantSize, change, maxAvailable, currentQty) {
    const input = document.getElementById(`qty-${productId}-${variantSize}`);
    const plusBtn = document.getElementById(`plus-btn-${productId}-${variantSize}`);
    const minusBtn = document.getElementById(`minus-btn-${productId}-${variantSize}`);
    
    if (!input) return;
    
    let newQty = parseInt(input.value) + change;

    if (newQty < 1) {
      Swal.fire({
        icon: 'warning',
        title: 'Minimum Quantity',
        text: 'Quantity cannot be less than 1.',
        confirmButtonColor: '#dc3545'
      });
      return;
    }

    if (newQty > maxAvailable) {
      const limitType = maxAvailable === MAX_QTY_PER_ORDER ? 'order limit (max 5 per order)' : 'available stock';
      Swal.fire({
        icon: 'warning',
        title: 'Quantity Limit Reached',
        text: `Cannot add more than ${maxAvailable} items due to ${limitType}.`,
        confirmButtonColor: '#dc3545'
      });
      return;
    }

    input.value = newQty;
    
    if (minusBtn) {
      minusBtn.disabled = newQty <= 1;
    }
    if (plusBtn) {
      plusBtn.disabled = newQty >= maxAvailable;
    }
    
    updateCart(productId, variantSize);
  }

  function updateCart(productId, variantSize) {
    const quantity = parseInt(document.getElementById(`qty-${productId}-${variantSize}`).value);

    Swal.fire({
      title: 'Updating...',
      allowOutsideClick: false,
      didOpen: () => Swal.showLoading()
    });

    fetch('/cart/update', {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ productId, variantSize, quantity })
    })
    .then(res => res.json())
    .then(data => {
      Swal.close();

      if (data.success) {
        const subtotalEl = document.getElementById(`subtotal-${productId}-${variantSize}`);
        if (subtotalEl) {
          subtotalEl.textContent = `₹${data.updatedItem.subtotal.toLocaleString()}`;
        }

        const subtotalContainer = document.getElementById('cart-subtotal');
        const totalContainer = document.getElementById('cart-total');

        
         if (subtotalContainer && totalContainer) {
  subtotalContainer.textContent = `₹${data.cartTotal.toLocaleString()}`;
  const totalWithShipping = data.cartTotal + 49;
  totalContainer.textContent = `₹${totalWithShipping.toLocaleString()}`;
}

        Swal.fire({
          icon: 'success',
          title: 'Updated',
          text: 'Cart updated successfully!',
          timer: 1000,
          showConfirmButton: false
        });

        setTimeout(() => validateAllCartStock(), 500);

      } else {
        Swal.fire({
          icon: 'error',
          title: 'Error',
          text: data.message || 'Failed to update cart',
          confirmButtonColor: '#dc3545'
        });
      }
    })
    .catch(err => {
      console.error('Update cart error:', err);
      Swal.fire({
        icon: 'error',
        title: 'Server Error',
        text: 'Failed to update cart. Please try again.',
        confirmButtonColor: '#dc3545'
      });
    });
  }

  function removeFromCart(productId, variantSize) {
    Swal.fire({
      title: 'Remove Item?',
      text: 'Are you sure you want to remove this item from cart?',
      icon: 'warning',
      showCancelButton: true,
      confirmButtonColor: '#dc3545',
      cancelButtonColor: '#6c757d',
      confirmButtonText: 'Yes, Remove',
      cancelButtonText: 'Cancel'
    }).then((result) => {
      if (result.isConfirmed) {
        fetch(`/cart/remove/${productId}?variantSize=${variantSize}`, {
          method: 'DELETE',
          headers: { 'Content-Type': 'application/json' }
        })
        .then(res => res.json())
        .then(data => {
          if (data.success) {
            Swal.fire({
              icon: 'success',
              title: 'Removed',
              text: 'Item removed from cart',
              timer: 1500,
              showConfirmButton: false
            }).then(() => {
              location.reload();
            });
          } else {
            Swal.fire({
              icon: 'error',
              title: 'Error',
              text: data.message || 'Failed to remove item',
              confirmButtonColor: '#dc3545'
            });
          }
        })
        .catch(err => {
          console.error('Remove from cart error:', err);
          Swal.fire({
            icon: 'error',
            title: 'Server Error',
            text: 'Failed to remove item. Please try again.',
            confirmButtonColor: '#dc3545'
          });
        });
      }
    });
  }

  function moveToWishlist(productId, variantSize) {
    Swal.fire({
      title: 'Move to Wishlist?',
      text: 'This item is out of stock. Would you like to save it to your wishlist?',
      icon: 'question',
      showCancelButton: true,
      confirmButtonColor: '#007bff',
      cancelButtonColor: '#6c757d',
      confirmButtonText: 'Yes, Move to Wishlist',
      cancelButtonText: 'Cancel'
    }).then((result) => {
      if (result.isConfirmed) {
        fetch('/wishlist/add', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ productId })
        })
        .then(res => res.json())
        .then(data => {
          if (data.success) {
            return fetch(`/cart/remove/${productId}?variantSize=${variantSize}`, {
              method: 'DELETE',
              headers: { 'Content-Type': 'application/json' }
            });
          } else {
            throw new Error(data.message || 'Failed to add to wishlist');
          }
        })
        .then(res => res.json())
        .then(data => {
          if (data.success) {
            Swal.fire({
              icon: 'success',
              title: 'Moved to Wishlist',
              text: 'Item moved to your wishlist successfully',
              timer: 1500,
              showConfirmButton: false
            }).then(() => {
              location.reload();
            });
          }
        })
        .catch(err => {
          console.error('Move to wishlist error:', err);
          Swal.fire({
            icon: 'error',
            title: 'Error',
            text: err.message || 'Failed to move to wishlist',
            confirmButtonColor: '#dc3545'
          });
        });
      }
    });
  }

  async function proceedToCheckout() {
  
  const unavailableItems = document.querySelectorAll('.cart-item[data-unavailable="true"]');
  
  if (unavailableItems.length > 0) {
    let htmlMessage = 'Please remove the following items before proceeding to checkout:<br><br>';
    const outOfStockList = [];
    const blockedList = [];

    unavailableItems.forEach(item => {
      if (item.dataset.blocked === 'true') {
        blockedList.push(item.dataset.blockReason);
      } else {
        outOfStockList.push(`Product "${item.dataset.productName}" is out of stock`);
      }
    });

    if (outOfStockList.length > 0) {
      htmlMessage += '<strong>Out of Stock Items:</strong><br>' + outOfStockList.join('<br>') + '<br><br>';
    }

    if (blockedList.length > 0) {
      htmlMessage += '<strong>Blocked Items:</strong><br>' + blockedList.join('<br>') + '<br><br>';
    }

    Swal.fire({
      icon: 'warning',
      title: 'Unavailable Items in Cart',
      html: htmlMessage,
      confirmButtonColor: '#dc3545',
      confirmButtonText: 'Got it'
    });
    return;
  }
 
  try {
    Swal.fire({
      title: 'Validating...',
      allowOutsideClick: false,
      didOpen: () => Swal.showLoading()
    });

    const response = await fetch('/cart/validate-checkout', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' }
    });

    const data = await response.json();
    Swal.close();

    if (!data.isValid) {
      let htmlMessage = '<strong>Out of Stock Items:</strong><br>';
      
      if (data.outOfStockItems && data.outOfStockItems.length > 0) {
        data.outOfStockItems.forEach(item => {
          htmlMessage += `<div style="margin: 8px 0; padding: 8px; background: #f8d7da; border-radius: 4px;">
            <strong>${item.productName}</strong><br>
            You have: ${item.requestedQty}, Available: ${item.availableStock}
          </div>`;
        });
      }

      Swal.fire({
        icon: 'error',
        title: 'Cannot Proceed - Out of Stock',
        html: htmlMessage,
        confirmButtonColor: '#dc3545',
        confirmButtonText: 'Reduce Quantity'
      });
      return;
    }
  
    window.location.href = '/checkout';

  } catch (error) {
    console.error('Checkout validation error:', error);
    Swal.fire({
      icon: 'error',
      title: 'Error',
      text: 'Failed to validate cart. Please try again.',
      confirmButtonColor: '#dc3545'
    });
  }
}

  document.addEventListener('DOMContentLoaded', () => {
    const unavailableItems = document.querySelectorAll('.cart-item[data-unavailable="true"]');
    const checkoutButton = document.getElementById('checkout-button');
    
    if (unavailableItems.length > 0 && checkoutButton) {
      checkoutButton.disabled = true;
    }
  });
</script>

<%- include('../../views/partials/user/footer') %>