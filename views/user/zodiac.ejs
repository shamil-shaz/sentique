<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Sentique - Zodiac Signature Perfumes</title>
  <style>
    :root {
      --primary-gold: #d4af37;
      --dark-purple: #1a0a2e;
      --card-bg: #1a1a1a;
      --text-light: #ffffff;
      --text-muted: #aaaaaa;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: 'Georgia', serif;
      color: var(--text-light);
      background: #0a0a0a;
      overflow-x: hidden;
      -webkit-font-smoothing: antialiased;
    }

    .header-section {
      position: relative;
      z-index: 1000;
      background: #fff;
      box-shadow: 0 2px 10px rgba(0,0,0,.1);
    }

    .hero-section {
      position: relative;
      min-height: 100vh;
      background: linear-gradient(180deg, #1a0a2e 0%, #0f0517 50%, #1a1030 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
    }

    .particles-container { position: absolute; width: 100%; height: 100%; overflow: hidden; pointer-events: none; }
    .zodiac-particle { position: absolute; font-size: 22px; color: var(--primary-gold); opacity: 0; animation: floatParticle 18s infinite ease-in-out; }
    @keyframes floatParticle {
      0% { opacity: 0; transform: translateY(110vh) rotate(0deg) scale(.4); }
      10% { opacity: .7; }
      90% { opacity: .7; }
      100% { opacity: 0; transform: translateY(-110vh) rotate(360deg) scale(1); }
    }

    .star { position: absolute; width: 2px; height: 2px; background: var(--primary-gold); border-radius: 50%; animation: twinkle 3s infinite; }
    @keyframes twinkle { 0%, 100% { opacity: .3; } 50% { opacity: 1; } }

    .constellation { position: absolute; width: 100%; height: 100%; opacity: .22; pointer-events: none; }

    .carousel-wrapper { perspective: 1500px; width: 100%; max-width: 700px; height: 500px; position: relative; z-index: 10; margin: 0 auto; }
    .carousel-3d { width: 100%; height: 100%; position: relative; transform-style: preserve-3d; animation: autoRotate 40s linear infinite; }
    .carousel-3d:hover { animation-play-state: paused; }
    @keyframes autoRotate { from { transform: rotateY(0); } to { transform: rotateY(360deg); } }
    .carousel-item { position: absolute; width: 200px; height: 300px; left: 50%; top: 50%; transform-style: preserve-3d; transition: all .6s cubic-bezier(.4,0,.2,1); }
    .carousel-item:hover { transform: scale(1.15) translateZ(50px) !important; }

    .perfume-card-3d {
      width: 100%;
      height: 100%;
      background: linear-gradient(145deg, rgba(40,40,40,.9), rgba(20,20,20,.9));
      border-radius: 20px;
      border: 2px solid rgba(212,175,55,.3);
      box-shadow: 0 20px 60px rgba(0,0,0,.7);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 30px;
      position: relative;
      overflow: hidden;
      backdrop-filter: blur(8px);
    }
    .perfume-card-3d::before {
      content: '';
      position: absolute;
      inset: 0;
      background: radial-gradient(circle at 50% 50%, rgba(212,175,55,.18), transparent 70%);
      animation: pulseGlow 4s infinite alternate;
    }
    @keyframes pulseGlow { 0% { opacity: .3; transform: scale(1); } 100% { opacity: .8; transform: scale(1.08); } }
    .perfume-card-3d img {
      width: 100%;
      height: 100%;
      object-fit: contain;
      object-position: center;
      filter: drop-shadow(0 10px 30px rgba(212,175,55,.4));
      transition: transform .6s;
    }

    .hero-content { position: absolute; bottom: 10px; text-align: center; z-index: 11; width: 100%; }
    .brand-title { font-size: 72px; font-weight: 300; letter-spacing: 12px; background: linear-gradient(135deg, #fff 0, #d4af37 50%, #fff 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 8px; text-transform: uppercase; }
    .brand-tagline { font-size: 20px; font-style: italic; color: var(--primary-gold); letter-spacing: 4px; text-transform: lowercase; }

    .products-section {
      background: #0a0a0a;
      position: relative;
      z-index: 5;
      padding: 24px 40px 80px 40px;
    }
    .section-header { text-align: center; padding: 40px 20px 18px; max-width: 1000px; margin: 0 auto; }
    .section-title { font-size: 40px; font-weight: 300; margin-bottom: 8px; letter-spacing: 2px; color: var(--text-light); }
    .section-description { font-size: 15px; color: var(--text-muted); max-width: 820px; margin: 0 auto; }

    .site-wrapper { max-width: 1400px; margin: 20px auto; padding: 0 15px; }
    .layout { display: flex; gap: 30px; align-items: flex-start; }
    .filters {
      width: 280px;
      background: var(--card-bg);
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
      overflow: hidden;
      border: 1px solid rgba(212,175,55,.18);
      height: fit-content;
      position: sticky;
      top: 20px;
    }
    .filter-header {
      background: linear-gradient(135deg, var(--dark-purple), #0f0517);
      color: var(--text-light);
      padding: 20px 24px;
      border-bottom: 1px solid rgba(212,175,55,.18);
    }
    .filter-header h4 {
      font-size: 18px;
      font-weight: 600;
      margin: 0;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .filter-content {
      padding: 24px;
      max-height: 70vh;
      overflow-y: auto;
    }
    .filter-content::-webkit-scrollbar { width: 4px; }
    .filter-content::-webkit-scrollbar-track { background: #1f1f1f; }
    .filter-content::-webkit-scrollbar-thumb { background: var(--primary-gold); border-radius: 4px; }
    .filter-section { margin-bottom: 28px; }
    .filter-section:last-child { margin-bottom: 0; }
    .filter-section h5 {
      font-size: 14px;
      font-weight: 600;
      color: var(--text-light);
      margin-bottom: 16px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      display: flex;
      align-items: center;
      gap: 8px;
      padding-bottom: 8px;
      border-bottom: 2px solid #1f1f1f;
    }
    .filter-section h5::before {
      content: '';
      width: 4px;
      height: 16px;
      background: var(--primary-gold);
      border-radius: 2px;
    }
    .filter-options { display: flex; flex-direction: column; gap: 2px; }
    .filter-option { position: relative; }
    .filter-option label {
      display: flex;
      align-items: center;
      cursor: pointer;
      font-size: 14px;
      color: var(--text-muted);
      padding: 12px 16px;
      border-radius: 8px;
      transition: all 0.2s ease;
      position: relative;
      user-select: none;
      margin: 0;
      background: transparent;
    }
    .filter-option label:hover {
      background-color: rgba(212,175,55,.1);
      color: var(--text-light);
      transform: translateX(2px);
    }
    .filter-option input[type="checkbox"],
    .filter-option input[type="radio"] {
      width: 18px;
      height: 18px;
      margin-right: 12px;
      cursor: pointer;
      position: relative;
      appearance: none;
      border: 2px solid var(--primary-gold);
      border-radius: 4px;
      background: transparent;
      transition: all 0.2s ease;
      flex-shrink: 0;
    }
    .filter-option input[type="radio"] { border-radius: 50%; }
    .filter-option input[type="checkbox"]:checked,
    .filter-option input[type="radio"]:checked {
      background: var(--primary-gold);
      border-color: var(--primary-gold);
      transform: scale(1.1);
    }
    .filter-option input[type="checkbox"]:checked::after {
      content: '✓';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: #000;
      font-size: 12px;
      font-weight: bold;
    }
    .filter-option input[type="radio"]:checked::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 8px;
      height: 8px;
      background: #000;
      border-radius: 50%;
    }
    .price-range-section {
      background: rgba(212,175,55,.05);
      border-radius: 8px;
      padding: 16px;
      margin-top: 8px;
    }
    .price-range-section .filter-option label {
      padding: 8px 12px;
      font-size: 13px;
      color: var(--text-muted);
    }
    .price-range-section .filter-option label:hover {
      background: rgba(212,175,55,.2);
    }
    .filter-actions {
      padding: 20px 24px;
      border-top: 1px solid rgba(212,175,55,.18);
      background: #1f1f1f;
      display: flex;
      gap: 12px;
    }
    .btn {
      padding: 12px 20px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      border: none;
      transition: all 0.2s ease;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      flex: 1;
    }
    .btn-primary {
      background: linear-gradient(135deg, var(--primary-gold), #f4d03f);
      color: #000;
      box-shadow: 0 2px 8px rgba(212,175,55,0.3);
    }
    .btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(212,175,55,0.4);
    }
    .btn-primary:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    .btn-secondary {
      background: transparent;
      color: var(--primary-gold);
      border: 1px solid var(--primary-gold);
    }
    .btn-secondary:hover {
      background: rgba(212,175,55,.1);
      border-color: var(--primary-gold);
      transform: translateY(-1px);
    }
    .filters-toggle {
      display: none;
      width: 100%;
      text-align: left;
      margin-bottom: 12px;
      background: linear-gradient(135deg, var(--primary-gold), #f4d03f);
      color: #000;
      border: none;
      padding: 12px 16px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.2s ease;
    }
    .filters-toggle:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(212,175,55,0.3);
    }
    .filter-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 999;
    }
    .filter-overlay.show { display: block; }
    .shop-search-bar {
      margin-bottom: 10px;
      margin-top: 10px;
      display: flex;
      justify-content: center;
    }
    .shop-search-form {
      width: 100%;
      max-width: 400px;
      position: relative;
    }
    .shop-search-input {
      width: 100%;
      padding: 12px 40px 12px 16px;
      border-radius: 8px;
      border: 1px solid var(--primary-gold);
      font-size: 14px;
      box-sizing: border-box;
      background: rgba(26,26,26,.85);
      color: var(--text-light);
      transition: all 0.2s ease;
    }
    .shop-search-input:focus {
      outline: none;
      border-color: var(--primary-gold);
      box-shadow: 0 0 0 3px rgba(212,175,55,0.1);
    }
    .shop-search-btn {
      position: absolute;
      right: 8px;
      top: 50%;
      transform: translateY(-50%);
      border: none;
      background: none;
      cursor: pointer;
      padding: 4px;
    }
    .shop-search-btn i {
      font-size: 16px;
      color: var(--primary-gold);
    }

    .products-container { max-width: 1400px; margin: 0 auto; padding: 0 20px; }
    .products-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 24px;
      align-items: start;
    }
    .product-card {
      background: linear-gradient(145deg, #1f1f1f, #0d0d0d);
      border-radius: 22px;
      border: 1px solid rgba(212,175,55,.12);
      overflow: hidden;
      display: flex;
      flex-direction: column;
      transition: transform .35s;
      position: relative;
      height: 100%;
    }
    .product-card:hover { transform: translateY(-10px); box-shadow: 0 22px 45px rgba(0,0,0,.6); }
    .product-image-wrapper {
      height: 280px;
      background: linear-gradient(145deg, #222, #111);
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      overflow: hidden;
      padding: 20px;
    }
    .product-image-wrapper a {
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .product-image-wrapper img {
      max-width: 100%;
      max-height: 100%;
      width: auto;
      height: auto;
      object-fit: contain;
      object-position: center;
      transition: transform .45s;
    }
    .product-card:hover .product-image-wrapper img { transform: scale(1.06); }
    .product-info {
      padding: 16px 18px;
      display: flex;
      flex-direction: column;
      gap: 6px;
      flex: 1;
    }
    .product-category {
      font-size: 11px;
      color: var(--text-light);
      text-transform: uppercase;
      letter-spacing: 1.6px;
      font-weight: 700;
    }
    .product-name {
      font-size: 16px;
      color: var(--primary-gold);
      line-height: 1.3;
      min-height: 40px;
      font-weight: 500;
    }
    .product-meta {
      font-size: 13px;
      color: var(--text-muted);
      margin-bottom: 4px;
    }
    .product-pricing {
      display: flex;
      gap: 10px;
      align-items: center;
      margin-top: auto;
      flex-wrap: wrap;
    }
    .sale-price {
      font-size: 18px;
      color: #d45e37;
      font-weight: 800;
    }
    .regular-price {
      font-size: 13px;
      color: var(--text-muted);
      text-decoration: line-through;
    }
    .discount-badge {
      background: #ff4444;
      color: #fff;
      padding: 3px 7px;
      border-radius: 10px;
      font-weight: 800;
      font-size: 11px;
    }
    .empty-state { text-align: center; padding: 60px; color: var(--text-muted); grid-column: 1/-1; }

    @media (max-width: 1280px) {
      .products-grid { grid-template-columns: repeat(3, 1fr); gap: 20px; }
      .brand-title { font-size: 62px; }
      .products-section { padding: 24px 30px 80px 30px; }
    }
    @media (max-width: 900px) {
      .products-grid { grid-template-columns: repeat(2, 1fr); gap: 18px; }
      .brand-title { font-size: 48px; letter-spacing: 8px; }
      .product-image-wrapper { height: 240px; padding: 16px; }
      .products-section { padding: 24px 20px 80px 20px; }
    }
    @media (max-width: 767px) {
      .layout { flex-direction: column; gap: 16px; }
      .filters {
        position: fixed;
        top: 0;
        left: -100%;
        width: 85%;
        max-width: 320px;
        height: 100vh;
        background: var(--card-bg);
        box-shadow: 4px 0 20px rgba(0,0,0,0.15);
        border-radius: 0;
        transition: left 0.3s ease;
        z-index: 1000;
        border-right: 1px solid rgba(212,175,55,.18);
      }
      .filters.show { left: 0; }
      .filters-toggle { display: block; }
      .products-grid { grid-template-columns: 1fr; gap: 16px; }
      .filter-content { max-height: calc(100vh - 140px); }
      .carousel-wrapper { display: none; }
      .products-section { padding: 24px 15px 80px 15px; }
    }
    @media (max-width: 480px) {
      .shop-search-form { max-width: 100%; }
      .section-title { font-size: 28px; }
      .product-image-wrapper { height: 220px; padding: 14px; }
    }
    .btn-primary:active { transform: scale(0.98); }
  </style>
</head>
<body>
  <!-- Header -->
  <div class="header-section">
    <%- include("../partials/user/header.ejs") %>
  </div>

  <!-- Hero -->
  <section class="hero-section" aria-hidden="false">
    <div class="particles-container" id="particlesContainer"></div>
    <canvas class="constellation" id="constellation"></canvas>
    <div class="carousel-wrapper" aria-hidden="true">
      <div class="carousel-3d" id="carousel3d"></div>
    </div>
    <div class="hero-content" role="banner">
      <h1 class="brand-title">SENTIQUE</h1>
      <p class="brand-tagline">scent your signature</p>
    </div>
  </section>

  <!-- Products Section -->
  <section class="products-section" aria-labelledby="zodiac-heading">
    <div class="section-header">
      <h2 id="zodiac-heading" class="section-title">Signature Fragrances</h2>
      <p class="section-description">Discover our exclusive collection of premium perfumes. Use filters to narrow the results.</p>
    </div>

    <!-- Search Bar -->
    <div class="shop-search-bar">
      <form class="shop-search-form">
        <input type="text" id="searchInput" class="shop-search-input" placeholder="Search perfumes by name..." value="<%= search ? search : '' %>">
        <button type="submit" class="shop-search-btn"><i class="fa fa-search"></i></button>
      </form>
    </div>

    <!-- Filter Sidebar and Products -->
    <div class="site-wrapper">
      <button id="toggleFilters" class="filters-toggle">
        <i class="fa fa-filter"></i> Filters
      </button>
      <div id="filterOverlay" class="filter-overlay"></div>
      <div class="layout">
        <!-- Filter Sidebar -->
        <aside id="filters" class="filters">
          <div class="filter-header">
            <h4><i class="fa fa-filter"></i> Filters</h4>
          </div>
          <div class="filter-content">
            <form id="filterForm">
              <!-- Category Filter -->
              <div class="filter-section">
                <h5><i class="fa fa-tags"></i> Category</h5>
                <div class="filter-options">
                  <% if (categories && categories.length > 0) { %>
                    <% categories.forEach(cat => { %>
                      <div class="filter-option">
                        <label>
                          <input type="checkbox" name="category" value="<%= cat._id %>">
                          <%= cat.name %>
                        </label>
                      </div>
                    <% }) %>
                  <% } else { %>
                    <p>No categories available</p>
                  <% } %>
                </div>
              </div>
              <!-- Price Filter -->
              <div class="filter-section">
                <h5><i class="fa fa-rupee-sign"></i> Price Range</h5>
                <div class="price-range-section">
                  <div class="filter-options">
                    <div class="filter-option">
                      <label>
                        <input type="radio" name="price" value="0-2000">
                        Under ₹2,000
                      </label>
                    </div>
                    <div class="filter-option">
                      <label>
                        <input type="radio" name="price" value="2000-3000">
                        ₹2,000 - ₹3,000
                      </label>
                    </div>
                    <div class="filter-option">
                      <label>
                        <input type="radio" name="price" value="3000-4000">
                        ₹3,000 - ₹4,000
                      </label>
                    </div>
                    <div class="filter-option">
                      <label>
                        <input type="radio" name="price" value="4000-5000">
                        ₹4,000 - ₹5,000
                      </label>
                    </div>
                    <div class="filter-option">
                      <label>
                        <input type="radio" name="price" value="5000+">
                        Above ₹5,000
                      </label>
                    </div>
                    <div class="filter-option">
                      <label>
                        <input type="radio" name="price" value="" checked>
                        All Prices
                      </label>
                    </div>
                  </div>
                </div>
              </div>
              <!-- Sort Filter -->
              <div class="filter-section">
                <h5><i class="fa fa-sort"></i> Sort By</h5>
                <div class="filter-options">
                  <div class="filter-option">
                    <label>
                      <input type="radio" name="sort" value="featured" checked>
                      Featured
                    </label>
                  </div>
                  <div class="filter-option">
                    <label>
                      <input type="radio" name="sort" value="price-low">
                      Price: Low to High
                    </label>
                  </div>
                  <div class="filter-option">
                    <label>
                      <input type="radio" name="sort" value="price-high">
                      Price: High to Low
                    </label>
                  </div>
                  <div class="filter-option">
                    <label>
                      <input type="radio" name="sort" value="name">
                      Name: A to Z
                    </label>
                  </div>
                  <div class="filter-option">
                    <label>
                      <input type="radio" name="sort" value="newest">
                      Newest First
                    </label>
                  </div>
                </div>
              </div>
            </form>
          </div>
          <div class="filter-actions">
            <button type="button" class="btn btn-secondary" onclick="clearFilters()">Clear</button>
            <button type="button" class="btn btn-primary" id="applyFiltersBtn">Apply</button>
          </div>
        </aside>

        <!-- Products Section -->
        <section class="shop-section">
          <div class="container">
            <!-- Products Grid -->
            <div class="products-container">
              <div id="productsGrid" class="products-grid" role="list">
                <% if (products && products.length > 0) { %>
                  <% products.forEach(product => { %>
                    <article class="product-card" data-id="<%= product._id %>">
                      <div class="product-image-wrapper">
                        <a href="/productDetails?id=<%= product._id %>">
                          <img src="<%= (product.images && product.images.length > 0) ? (typeof product.images[0] === 'string' ? product.images[0] : product.images[0].url) : 'https://via.placeholder.com/400x400/1a1a1a/d4af37?text=No+Image' %>" alt="<%= product.productName || 'Product' %>"/>
                        </a>
                      </div>
                      <div class="product-info">
                        <div class="product-category"><%= product.category ? product.category.name : 'Perfume' %></div>
                        <div class="product-name"><%= product.productName %></div>
                        <div class="product-meta"><strong>Brand:</strong> <%= product.brand ? product.brand.brandName : 'Sentique' %></div>
                        <%
                          let salePrice = 0, regularPrice = 0;
                          if (product.variants && product.variants.length > 0) {
                            salePrice = Math.min(...product.variants.map(v => v.salePrice || v.regularPrice || 0));
                            regularPrice = Math.max(...product.variants.map(v => v.regularPrice || 0));
                          } else {
                            salePrice = product.salePrice || product.price || 0;
                            regularPrice = product.price || 0;
                          }
                          let discount = regularPrice > salePrice ? Math.round(((regularPrice - salePrice) / regularPrice) * 100) : 0;
                        %>
                        <div class="product-pricing">
                          <div class="sale-price">₹<%= salePrice.toLocaleString('en-IN') %></div>
                          <% if (discount > 0) { %>
                            <div class="regular-price">₹<%= regularPrice.toLocaleString('en-IN') %></div>
                            <div class="discount-badge"><%= discount %>% OFF</div>
                          <% } %>
                        </div>
                      </div>
                    </article>
                  <% }) %>
                <% } else { %>
                  <div class="empty-state" id="noProductsNotice">
                    <p style="font-size:42px;opacity:.25;margin-bottom:10px;">🔍</p>
                    <h3>No products found</h3>
                    <p>We couldn't find any Sentique products right now.</p>
                  </div>
                <% } %>
              </div>
            </div>
          </div>
        </section>
      </div>
    </div>
  </section>

  <!-- Footer -->
  <%- include("../partials/user/footer.ejs") %>

  <script>
    const initialProducts = <%- JSON.stringify(products || []) %>;

    window.addEventListener("DOMContentLoaded", () => {
      document.querySelectorAll(".product-card").forEach((card, index) => {
        card.style.opacity = "0";
        card.style.transform = "translateY(20px)";
        setTimeout(() => {
          card.style.transition = "all 0.6s ease";
          card.style.opacity = "1";
          card.style.transform = "translateY(0)";
        }, index * 150);
      });
    });

    // ---------- Particles ----------
    (function createParticles() {
      const container = document.getElementById('particlesContainer');
      if (!container) return;
      const zodiac = ['♈','♉','♊','♋','♌','♍','♎','♏','♐','♑','♒','♓','✦','✧','⋆','❋'];
      for (let i = 0; i < 40; i++) {
        const el = document.createElement('div');
        el.className = 'zodiac-particle';
        el.textContent = zodiac[Math.floor(Math.random() * zodiac.length)];
        el.style.left = Math.random() * 100 + '%';
        el.style.top = Math.random() * 100 + '%';
        el.style.fontSize = (14 + Math.random() * 30) + 'px';
        el.style.animationDelay = (Math.random() * 12) + 's';
        el.style.animationDuration = (12 + Math.random() * 12) + 's';
        container.appendChild(el);
      }
    })();

    // ---------- Constellation ----------
    (function drawConstellation() {
      const canvas = document.getElementById('constellation');
      if (!canvas) return;
      const ctx = canvas.getContext('2d');
      function resize() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
      resize();
      window.addEventListener('resize', resize);
      const pts = Array.from({ length: 60 }).map(() => ({ x: Math.random() * canvas.width, y: Math.random() * canvas.height }));
      function anim() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.strokeStyle = 'rgba(212,175,55,0.12)';
        ctx.lineWidth = 1;
        for (let i = 0; i < pts.length; i++) {
          for (let j = i + 1; j < pts.length; j++) {
            const dx = pts[i].x - pts[j].x;
            const dy = pts[i].y - pts[j].y;
            const d = Math.hypot(dx, dy);
            if (d < 140) {
              ctx.beginPath(); ctx.moveTo(pts[i].x, pts[i].y); ctx.lineTo(pts[j].x, pts[j].y); ctx.stroke();
            }
          }
        }
        requestAnimationFrame(anim);
      }
      anim();
    })();

    // ---------- 3D Carousel ----------
    (function generate3DCarousel() {
      const carousel = document.getElementById('carousel3d');
      if (!carousel) return;
      const products = initialProducts || [];
      const items = (products.length ? Math.min(products.length, 12) : 8);
      const radius = 350;
      const angleStep = 360 / items;
      for (let i = 0; i < items; i++) {
        const angle = angleStep * i;
        const item = document.createElement('div');
        item.className = 'carousel-item';
        item.style.transform = `translate(-50%,-50%) rotateY(${angle}deg) translateZ(${radius}px)`;
        const prod = products[i] || {};
        const img = (prod.images && prod.images.length > 0) ? (typeof prod.images[0] === 'string' ? prod.images[0] : prod.images[0].url) : `https://via.placeholder.com/200x300/2a2a2a/d4af37?text=Perfume+${i+1}`;
        item.innerHTML = `<div class="perfume-card-3d"><img src="${img}" alt="${prod.productName || 'Perfume'}"></div>`;
        carousel.appendChild(item);
      }
    })();

    // ---------- Product Filters ----------
    const productsGrid = document.getElementById('productsGrid');
    const searchInput = document.getElementById('searchInput');
    const filterForm = document.getElementById('filterForm');
    const applyFiltersBtn = document.getElementById('applyFiltersBtn');
    const toggleFiltersBtn = document.getElementById('toggleFilters');
    const filterOverlay = document.getElementById('filterOverlay');

    function renderProducts(products) {
      productsGrid.innerHTML = '';
      if (!products || products.length === 0) {
        const empty = document.createElement('div');
        empty.className = 'empty-state';
        empty.innerHTML = `
          <p style="font-size:42px;opacity:.25;margin-bottom:10px;">🔍</p>
          <h3>No products found</h3>
          <p>We couldn't find any Sentique products right now.</p>
        `;
        productsGrid.appendChild(empty);
        return;
      }

      products.forEach(product => {
        const article = document.createElement('article');
        article.className = 'product-card';
        article.setAttribute('data-id', product._id);

        // Image
        const imgSrc = (product.images && product.images.length > 0)
          ? (typeof product.images[0] === 'string' ? product.images[0] : (product.images[0].url || ''))
          : 'https://via.placeholder.com/400x400/1a1a1a/d4af37?text=No+Image';

        // Pricing
        let salePrice = 0, regularPrice = 0;
        if (product.variants && product.variants.length > 0) {
          salePrice = Math.min(...product.variants.map(v => v.salePrice || v.regularPrice || 0));
          regularPrice = Math.max(...product.variants.map(v => v.regularPrice || 0));
        } else {
          salePrice = product.salePrice || product.price || 0;
          regularPrice = product.price || 0;
        }
        const discount = regularPrice > salePrice ? Math.round(((regularPrice - salePrice) / regularPrice) * 100) : 0;

        article.innerHTML = `
          <div class="product-image-wrapper">
            <a href="/productDetails?id=${product._id}">
              <img src="${imgSrc}" alt="${product.productName || 'Product'}"/>
            </a>
          </div>
          <div class="product-info">
            <div class="product-category">${product.category ? product.category.name : 'Perfume'}</div>
            <div class="product-name">${product.productName || 'Unnamed'}</div>
            <div class="product-meta"><strong>Brand:</strong> ${product.brand ? product.brand.brandName : 'Sentique'}</div>
            <div class="product-pricing">
              <span class="sale-price">₹${salePrice.toLocaleString('en-IN')}</span>
              ${discount > 0 ? `<span class="regular-price">₹${regularPrice.toLocaleString('en-IN')}</span>
              <span class="discount-badge">${discount}% OFF</span>` : ''}
            </div>
          </div>
        `;

        productsGrid.appendChild(article);
      });

      // Animate appearance
      document.querySelectorAll(".product-card").forEach((card, index) => {
        card.style.opacity = "0";
        card.style.transform = "translateY(20px)";
        setTimeout(() => {
          card.style.transition = "all 0.6s ease";
          card.style.opacity = "1";
          card.style.transform = "translateY(0)";
        }, index * 100);
      });
    }

    function buildQuery() {
      let qs = '?';

      // Search
      const search = searchInput.value.trim();
      if (search) qs += `search=${encodeURIComponent(search)}&`;

      // Categories (multiple)
      const selectedCats = Array.from(filterForm.querySelectorAll('input[name="category"]:checked')).map(input => input.value);
      if (selectedCats.length > 0) qs += `category=${encodeURIComponent(selectedCats.join(','))}&`;

      // Price
      const priceRadio = filterForm.querySelector('input[name="price"]:checked');
      const price = priceRadio ? priceRadio.value : '';
      if (price) qs += `price=${encodeURIComponent(price)}&`;

      // Sort
      const sortRadio = filterForm.querySelector('input[name="sort"]:checked');
      let sort = sortRadio ? sortRadio.value : 'newest';
      if (sort === 'featured') sort = 'newest';
      qs += `sort=${encodeURIComponent(sort)}`;

      return qs;
    }

    async function fetchAndRender() {
      try {
        productsGrid.innerHTML = `<div class="empty-state"><p>Loading...</p></div>`;
        const qs = buildQuery();
        const res = await fetch('/api/zodiac-products' + qs);
        const data = await res.json();
        if (data.success) {
          renderProducts(data.products || []);
        } else {
          renderProducts([]);
        }
      } catch (err) {
        console.error(err);
        renderProducts([]);
      }
    }

    function clearFilters() {
      searchInput.value = '';
      filterForm.querySelectorAll('input[type="checkbox"]').forEach(input => input.checked = false);
      filterForm.querySelector('input[name="price"][value=""]').checked = true;
      filterForm.querySelector('input[name="sort"][value="featured"]').checked = true;
      fetchAndRender();
    }

    // Events
    applyFiltersBtn.addEventListener('click', () => {
      fetchAndRender();
      // Close filters on mobile after apply
      document.getElementById('filters').classList.remove('show');
      filterOverlay.classList.remove('show');
    });

    document.querySelector('.shop-search-form').addEventListener('submit', (e) => {
      e.preventDefault();
      fetchAndRender();
    });

    toggleFiltersBtn.addEventListener('click', () => {
      const filters = document.getElementById('filters');
      filters.classList.toggle('show');
      filterOverlay.classList.toggle('show');
    });

    filterOverlay.addEventListener('click', () => {
      document.getElementById('filters').classList.remove('show');
      filterOverlay.classList.remove('show');
    });

    // ---------- Initial Load ----------
    renderProducts(initialProducts);
  </script>
</body>
</html>