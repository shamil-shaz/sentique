 <!DOCTYPE html>
<html>
  <head>
    <link
      href="https://fonts.googleapis.com/css?family=Poppins:600&display=swap"
      rel="stylesheet">
    <link
      href="https://fonts.googleapis.com/css?family=Inter:400,500,600&display=swap"
      rel="stylesheet">
    <script
      src="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.all.min.js"></script>
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>

    <style>
      body {
        background: #f9f9fa;
        font-family: 'Inter', sans-serif;
        line-height: 1.5;
      }

      .payment-failure-wrapper {
        margin: 0;
        padding: 20px 0;
        width: 100%;
        min-height: calc(100vh - 200px);
        display: flex;
        align-items: center;
        justify-content: center;
        background: linear-gradient(135deg, #2d1b2e 0%, #1a1625 100%);
        position: relative;
        overflow: hidden;
      }

      .bg-decoration {
        position: absolute;
        width: 100%;
        height: 100%;
        overflow: hidden;
        z-index: 0;
        top: 0;
        left: 0;
      }

      .circle {
        position: absolute;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.08);
        animation: pulse 4s ease-in-out infinite;
      }

      .circle-1 {
        width: 350px;
        height: 350px;
        top: -120px;
        left: -120px;
        animation-delay: 0s;
        background: rgba(239, 68, 68, 0.15);
      }

      .circle-2 {
        width: 250px;
        height: 250px;
        bottom: -80px;
        right: -80px;
        animation-delay: 1.5s;
        background: rgba(239, 68, 68, 0.1);
      }

      .circle-3 {
        width: 180px;
        height: 180px;
        top: 40%;
        right: 8%;
        animation-delay: 2.5s;
        background: rgba(239, 68, 68, 0.12);
      }

      @keyframes pulse {
        0%, 100% {
          transform: scale(1);
          opacity: 0.6;
        }
        50% {
          transform: scale(1.15);
          opacity: 0.3;
        }
      }

      @keyframes shake {
        0%, 100% { transform: translateX(0) rotate(0deg); }
        10%, 30%, 50%, 70%, 90% { transform: translateX(-5px) rotate(-1deg); }
        20%, 40%, 60%, 80% { transform: translateX(5px) rotate(1deg); }
      }

      .payment-container {
        position: relative;
        z-index: 1;
        width: 100%;
        max-width: 700px;
        padding: 0 20px;
      }

      .payment-failure-card {
        background: #fff;
        border-radius: 24px;
        box-shadow: 0 8px 50px rgba(0, 0, 0, 0.15);
        padding: 40px 60px;
        display: flex;
        flex-direction: column;
        align-items: center;
        margin: 0 auto;
        animation: cardEntry 0.8s cubic-bezier(0.61, 1.44, 0.55, 0.97) both;
        border-top: 4px solid #ef4444;
      }

      @keyframes cardEntry {
        from {
          opacity: 0;
          transform: translateY(40px) scale(0.97);
        }
        to {
          opacity: 1;
          transform: translateY(0) scale(1);
        }
      }

      .order-status-graphic {
        position: relative;
        width: 100px;
        height: 100px;
        margin-bottom: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .error-icon {
        width: 100px;
        height: 100px;
        background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 50px;
        animation: shake 0.5s, fadeIn 1s 0.2s both;
        box-shadow: 0 4px 20px rgba(239, 68, 68, 0.2);
      }

      .order-status-title {
        margin-top: 12px;
        font-size: 1.6rem;
        font-family: 'Poppins', sans-serif;
        font-weight: 600;
        margin-bottom: 8px;
        color: #18191f;
        text-align: center;
        letter-spacing: 0.01em;
        animation: fadeIn 1s 0.3s both;
      }

      .order-status-subtitle {
        font-size: 1rem;
        color: #6b7280;
        margin-bottom: 12px;
        font-weight: 400;
        text-align: center;
        letter-spacing: 0.02em;
        animation: fadeIn 1.1s 0.4s both;
      }

      .error-reason {
        background: #fef2f2;
        border-left: 4px solid #ef4444;
        border-radius: 8px;
        padding: 16px;
        margin-bottom: 24px;
        text-align: center;
        animation: fadeIn 1.1s 0.5s both;
      }

      .error-reason-title {
        font-size: 0.85rem;
        font-weight: 600;
        color: #991b1b;
        margin-bottom: 4px;
        text-transform: uppercase;
        letter-spacing: 0.05em;
      }

      .error-reason-text {
        font-size: 0.95rem;
        color: #7f1d1d;
        font-weight: 400;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(12px);
        }
        to {
          opacity: 1;
          transform: none;
        }
      }

      .order-details-box {
        width: 100%;
        background: #f9fafb;
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 28px;
        border: 1px solid #e5e7eb;
        animation: fadeIn 1.1s 0.5s both;
      }

      .order-details-title {
        font-weight: 600;
        color: #18191f;
        margin-bottom: 14px;
        font-size: 0.9rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
      }

      .detail-row {
        display: flex;
        justify-content: space-between;
        font-size: 0.9rem;
        margin-bottom: 10px;
        padding-bottom: 10px;
        border-bottom: 1px solid #e5e7eb;
      }

      .detail-row:last-child {
        margin-bottom: 0;
        padding-bottom: 0;
        border-bottom: none;
      }

      .detail-label {
        color: #6b7280;
        font-weight: 500;
      }

      .detail-value {
        color: #1a1d1f;
        font-weight: 500;
        font-family: 'Inter', sans-serif;
        word-break: break-all;
      }

      .troubleshooting-box {
        width: 100%;
        background: #eff6ff;
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 28px;
        border-left: 4px solid #3b82f6;
        animation: fadeIn 1.1s 0.6s both;
      }

      .troubleshooting-title {
        font-weight: 600;
        color: #1e40af;
        margin-bottom: 12px;
        font-size: 0.9rem;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .troubleshooting-list {
        list-style: none;
        padding: 0;
        margin: 0;
      }

      .troubleshooting-item {
        font-size: 0.85rem;
        color: #1e40af;
        margin-bottom: 8px;
        padding-left: 20px;
        position: relative;
        line-height: 1.4;
      }

      .troubleshooting-item:before {
        content: "âœ“";
        position: absolute;
        left: 0;
        font-weight: bold;
        color: #3b82f6;
      }

      .troubleshooting-item:last-child {
        margin-bottom: 0;
      }

      .payment-action-buttons {
        display: flex;
        gap: 14px;
        width: 100%;
        justify-content: center;
        margin-bottom: 16px;
        animation: fadeIn 1.1s 0.75s both;
        flex-wrap: wrap;
      }

      .payment-btn {
        padding: 12px 24px;
        border: none;
        border-radius: 10px;
        cursor: pointer;
        font-size: 0.95rem;
        font-weight: 500;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        min-width: 45%;
        display: inline-flex;
        justify-content: center;
        align-items: center;
      }

      .payment-btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }

      .payment-btn-tertiary {
        background: #10b981;
        color: #fff;
        box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
      }

      .payment-btn-tertiary:hover:not(:disabled) {
        background: #059669;
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(16, 185, 129, 0.4);
      }

      .payment-btn-primary {
        background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        color: #fff;
        box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
      }

      .payment-btn-primary:hover:not(:disabled) {
        background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(239, 68, 68, 0.4);
      }

      .order-status-footer {
        color: #6b7280;
        font-size: 0.85rem;
        text-align: center;
        font-weight: 400;
      }

      .support-link {
        color: #3b82f6;
        text-decoration: none;
        font-weight: 600;
        transition: color 0.2s;
      }

      .support-link:hover {
        color: #2563eb;
        text-decoration: underline;
      }

      @media (max-width: 500px) {
        .payment-failure-card {
          width: 92vw;
          padding: 24px 5vw;
        }

        .order-details-box,
        .troubleshooting-box {
          padding: 16px;
        }

        .order-status-title {
          font-size: 1.4rem;
        }

        .error-icon {
          width: 80px;
          height: 80px;
          font-size: 40px;
        }

        .payment-btn {
          min-width: 100%;
        }

        .payment-action-buttons {
          flex-direction: column;
          gap: 10px;
        }
      }
    </style>
  </head>
  <body>
    <div class="payment-failure-wrapper">
      <div class="payment-container">
        <div class="payment-failure-card">
          <div style="display:flex;flex-direction:column;align-items:center;">
            <div class="error-icon">âœ•</div>
            <h2
              style="margin-top:12px;font-family:'Poppins';font-size:1.6rem;">Payment
              Failed</h2>
            <div style="color:#6b7280;margin-bottom:16px;">Your payment could
              not be processed</div>
          </div>

          <div class="error-reason"
            style="background:#fef2f2;border-left:4px solid #ef4444;border-radius:8px;padding:12px;margin-bottom:16px;">
            <div style="font-weight:600;color:#991b1b;margin-bottom:4px;">âš 
              Error Type</div>
            <div id="errorReasonText" style="color:#7f1d1d;">Transaction
              declined by your bank</div>
          </div>

          <div class="order-details-box">
            <div
              style="font-weight:600;margin-bottom:12px;text-transform:uppercase;">Transaction
              Details</div>

            <div class="detail-row">
              <span class="detail-label">Order ID</span>
              <span class="detail-value" id="orderIdValue">N/A</span>
            </div>

            <div class="detail-row">
              <span class="detail-label">Transaction ID</span>
              <span class="detail-value" id="transactionIdValue">N/A</span>
            </div>

            <div class="detail-row">
              <span class="detail-label">Date & Time</span>
              <span class="detail-value" id="dateTimeValue">Loading...</span>
            </div>

            <div class="detail-row">
              <span class="detail-label">Payment Method</span>
              <span class="detail-value" id="paymentMethodValue">Online
                Payment</span>
            </div>

            <div class="detail-row">
              <span class="detail-label">Attempted Amount</span>
              <span class="detail-value" id="amountValue">â‚¹0</span>
            </div>

            <div class="detail-row">
              <span class="detail-label">Status</span>
              <span class="detail-value"
                style="color:#dc2626;font-weight:600;">Failed</span>
            </div>
          </div>

          <div style="margin-bottom:18px;">
            <div style="font-weight:600;color:#1e40af;margin-bottom:8px;">ðŸ’¡ How
              to Fix This</div>
            <ul style="margin:0;padding-left:18px;color:#1e40af;">
              <li>Verify your card details (number, expiry, CVV)</li>
              <li>Check if you have sufficient balance</li>
              <li>Try another payment method</li>
              <li>Contact your bank for restrictions</li>
              <li>Clear browser cache and try again</li>
            </ul>
          </div>

          <div class="payment-action-buttons">
            <button class="payment-btn payment-btn-tertiary"
              onclick="continueShopping()" id="continueShoppingBtn">Continue
              Shopping</button>
            <button class="payment-btn payment-btn-primary"
              onclick="retryPayment()" id="retryPaymentBtn">Retry
              Payment</button>
          </div>

          <div
            style="margin-top:14px;text-align:center;color:#6b7280;font-size:0.9rem;">
            Need help? <a href="/support"
              style="color:#3b82f6;font-weight:600;">Contact Support</a>
          </div>
        </div>
      </div>
    </div>

    <script>
   
    const serverOrder = <%- JSON.stringify(order || {}) %>;
  </script>

    <script>
    
    function getQueryParam(param) {
      try {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get(param) || '';
      } catch (e) {
        return '';
      }
    }

   
    function normalizeAmountText(txt) {
      if (!txt) return 'â‚¹0';
      txt = String(txt).trim();
      if (!txt.startsWith('â‚¹')) return 'â‚¹' + txt;
      return txt;
    }

    
    document.addEventListener('DOMContentLoaded', function () {
      try {
       
        const qError = getQueryParam('errorReason');
        const qTransaction = getQueryParam('transactionId') || getQueryParam('transaction_id') || '';
        const qPaymentMethod = getQueryParam('paymentMethod') || getQueryParam('payment_method') || '';
        const qAmount = getQueryParam('amount');
        const qOrderId = getQueryParam('orderId');

       
        const orderId = serverOrder.orderId || qOrderId || 'N/A';
        const transactionId = serverOrder.transactionId || qTransaction || 'N/A';
        const paymentMethod = serverOrder.paymentMethod || qPaymentMethod || 'Online Payment';
        const errorReason = serverOrder.errorReason || qError || 'Transaction declined by your bank';
        const amount = serverOrder.amount || (qAmount ? decodeURIComponent(qAmount) : null) || 'â‚¹0';
        const dateTime = serverOrder.dateTime || new Date().toLocaleString('en-IN');

       
        document.getElementById('orderIdValue').textContent = orderId;
        document.getElementById('transactionIdValue').textContent = transactionId;
        document.getElementById('paymentMethodValue').textContent = paymentMethod;
        document.getElementById('errorReasonText').textContent = decodeURIComponent(errorReason);
        document.getElementById('amountValue').textContent = normalizeAmountText(decodeURIComponent(amount));
        document.getElementById('dateTimeValue').textContent = dateTime;

        console.log('ðŸ“¥ orderFailure page loaded with:', { orderId, transactionId, amount });
      } catch (err) {
        console.error('Error populating failure page:', err);
      }
    });

  
    function continueShopping() {
      const btn = document.getElementById('continueShoppingBtn');
      btn.disabled = true;
      btn.textContent = 'Redirecting...';
      sessionStorage.clear();
      setTimeout(() => (window.location.href = '/shopPage'), 300);
    }

    // Ensure retryPayment is global (onclick will find it)
    window.retryPayment = async function () {
      console.log('ðŸ”„ retryPayment clicked');

      // Prefer serverOrder.orderId if available, else query param, else sessionStorage
      const orderId = (serverOrder && serverOrder.orderId) || getQueryParam('orderId') || sessionStorage.getItem('retryOrderId') || 'N/A';
      if (!orderId || orderId === 'N/A') {
        return Swal.fire({ icon:'error', title:'Error', text:'Order ID not found. Please go to Orders and try again.', confirmButtonColor:'#ef4444' });
      }

      const retryBtn = document.getElementById('retryPaymentBtn');
      retryBtn.disabled = true;
      retryBtn.textContent = 'Processing...';

      // Read amount from DOM (server-rendered)
      const amountTextRaw = document.getElementById('amountValue')?.textContent || '';
      console.log('ðŸ’° Found amount text:', amountTextRaw);

      // Parse amount robustly: remove â‚¹, commas, spaces. Accept both "1,470" and "1470"
      const numeric = parseFloat(String(amountTextRaw).replace(/[â‚¹,\s]/g, ''));
      const amount = Number.isFinite(numeric) ? numeric : 0;

      if (!amount || amount <= 0) {
        console.warn('âš  Invalid amount read from page:', amountTextRaw);
        Swal.fire({
          icon: 'error',
          title: 'Invalid Amount',
          text: 'Amount not found or invalid. Please refresh the page and try again.',
          confirmButtonColor: '#ef4444'
        });
        retryBtn.disabled = false;
        retryBtn.textContent = 'Retry Payment';
        return;
      }

      // call handler (amount is in rupees; back-end createRazorpayOrder will convert)
      await handleRazorpayPaymentRetry(orderId, amount);
    };

    // Main retry logic (opens Razorpay)
    async function handleRazorpayPaymentRetry(orderId, amount) {
      try {
        console.log('ðŸ” handleRazorpayPaymentRetry', { orderId, amount });

        // Auth check
        const authResp = await fetch('/payment/check-auth', { method:'GET', credentials:'include' });
        const auth = await authResp.json();
        if (!auth.isAuthenticated) {
          return window.location.href = '/login';
        }

        Swal.fire({ title:'Processing...', html:'Creating payment order', allowOutsideClick:false, didOpen:()=>Swal.showLoading() });

        // Request Razorpay order from backend
        const createResp = await fetch('/payment/create-razorpayOrder', {
          method:'POST',
          headers:{ 'Content-Type':'application/json' },
          credentials:'include',
          body: JSON.stringify({ amount: Number(amount), currency:'INR', orderId })
        });

        const createJson = await createResp.json();
        if (!createResp.ok || !createJson.success) {
          console.error('create-razorpayOrder failed:', createJson);
          throw new Error(createJson.message || 'Failed to create payment order');
        }

        Swal.close();

        if (typeof Razorpay === 'undefined') throw new Error('Razorpay script not loaded');

        const options = {
          key: createJson.keyId,
          amount: createJson.amount,
          currency: createJson.currency,
          name: 'Sentique',
          description: 'Payment Retry',
          order_id: createJson.orderId,
          handler: async (response) => {
            console.log(' Razorpay success handler', response);
            await verifyRazorpayPayment(response.razorpay_order_id, response.razorpay_payment_id, response.razorpay_signature, orderId);
          },
          theme: { color:'#22c55e' },
          modal: {
            ondismiss: () => {
              Swal.fire({ icon:'info', title:'Payment Cancelled', text:'Payment cancelled. Your order is still saved â€” retry later from orders page.', confirmButtonColor:'#22c55e' });
            }
          }
        };

        const rzp = new Razorpay(options);

        // Handle failed event â€” record and redirect with amount & reason
        rzp.on('payment.failed', async (response) => {
          console.error(' Razorpay payment.failed', response.error);
          try {
            const failResp = await fetch('/payment/payment-failure', {
              method:'POST',
              headers:{ 'Content-Type':'application/json' },
              credentials:'include',
              body: JSON.stringify({
                razorpay_order_id: response.error.metadata.order_id,
                error_description: response.error.description,
                error_code: response.error.code
              })
            });
            const failJson = await failResp.json();
            const failOrderId = failJson.orderId || response.error.metadata.order_id || orderId;
            const failAmount = document.getElementById('amountValue')?.textContent || `â‚¹${amount}`;
            const encodedReason = encodeURIComponent(failJson.errorMessage || response.error.description || 'Payment failed');

            sessionStorage.setItem('retryOrderId', failOrderId);

            // Redirect back to failure page with full details
            window.location.href = `/orderFailure?orderId=${failOrderId}&amount=${encodeURIComponent(failAmount)}&errorReason=${encodedReason}&paymentMethod=Online%20Payment`;
            return;
          } catch (err) {
            console.error('Error recording failure:', err);
            Swal.fire({ icon:'error', title:'Payment Failed', text: response.error.description || 'Payment failed', confirmButtonColor:'#ef4444' });
          }
        });

        // open modal
        rzp.open();

      } catch (err) {
        Swal.close();
        console.error(' handleRazorpayPaymentRetry error', err);
        Swal.fire({ icon:'error', title:'Error', text: err.message || 'Failed to initiate retry payment', confirmButtonColor:'#ef4444' });
        document.getElementById('retryPaymentBtn').disabled = false;
        document.getElementById('retryPaymentBtn').textContent = 'Retry Payment';
      }
    }

    // Verify payment backend
    async function verifyRazorpayPayment(razorpayOrderId, razorpayPaymentId, razorpaySignature, retryOrderId) {
      Swal.fire({ title:'Verifying Payment...', html:'Please wait while we verify your payment', allowOutsideClick:false, didOpen:()=>Swal.showLoading() });
      try {
        const payload = { razorpay_order_id: razorpayOrderId, razorpay_payment_id: razorpayPaymentId, razorpay_signature: razorpaySignature, orderId: retryOrderId };
        const resp = await fetch('/payment/verify-razorpay-payment', {
          method:'POST',
          headers:{ 'Content-Type':'application/json' },
          credentials:'include',
          body: JSON.stringify(payload)
        });
        const json = await resp.json();
        if (!json.success) throw new Error(json.message || 'Verification failed');

        Swal.fire({ icon:'success', title:'Payment Successful!', html:`<p>Order ID: <strong>${json.orderId}</strong></p>`, confirmButtonText:'View Order', confirmButtonColor:'#22c55e' })
          .then(() => window.location.href = `/orderSuccess?orderId=${json.orderId}`);
      } catch (err) {
        Swal.close();
        console.error(' verifyRazorpayPayment error', err);
        Swal.fire({ icon:'error', title:'Verification Failed', text: err.message || 'Could not verify payment', confirmButtonColor:'#ef4444' })
          .then(() => window.location.href = `/orders`);
      }
    }
  </script>
  </body>
</html>