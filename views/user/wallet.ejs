<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Wallet | Premium Dashboard</title>

  <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">

  <style>
    /* =========================================
       1. VARIABLES & THEME
       ========================================= */
    :root {
      --font-main: 'Plus Jakarta Sans', sans-serif;

      /* Gold Theme */
      --gold-primary: #e5c14a;
      --gold-gradient: linear-gradient(135deg, #e5c14a 0%, #f0d978 100%);
      --gold-glow: rgba(229, 193, 74, 0.3);

      /* Light Mode Colors */
      --bg-body: #f4f6f9;
      --bg-card: #ffffff;
      --text-main: #0f172a;
      --text-muted: #64748b;
      --border-color: #e2e8f0;
      --row-hover: #f8fafc;
      
      /* Status */
      --success-text: #16a34a; --success-bg: rgba(22, 163, 74, 0.1);
      --danger-text: #dc2626;  --danger-bg: rgba(220, 38, 38, 0.1);
      
      /* Shadows */
      --shadow-sm: 0 1px 3px rgba(0,0,0,0.05);
      --shadow-md: 0 4px 6px -1px rgba(0,0,0,0.05);
    }

    /* DARK MODE */
    body.dark-mode {
      --bg-body: #0a0a0a;
      --bg-card: #141414;
      --text-main: #ffffff;
      --text-muted: #a1a1aa;
      --border-color: #27272a;
      --row-hover: #1f1f1f;
    }

    /* =========================================
       2. RESET & LAYOUT
       ========================================= */
    * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    
    body {
      font-family: var(--font-main);
      background: var(--bg-body);
      color: var(--text-main);
      transition: background 0.3s ease, color 0.3s ease;
      padding-bottom: 40px;
    }

    .wallet-container {
      max-width: 1280px;
      margin: 0 auto;
      padding: 30px 20px;
    }

    /* Use main-content class to match sidebar expectations */
    .main-content {
      display: grid;
      grid-template-columns: 280px 1fr;
      gap: 30px;
      align-items: start;
    }

    /* =========================================
       3. HEADER & BUTTONS
       ========================================= */
    .page-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 25px;
      flex-wrap: wrap;
      gap: 15px;
    }

    .header-text h1 { font-size: 26px; font-weight: 800; letter-spacing: -0.5px; }
    .breadcrumb { font-size: 13px; color: var(--text-muted); margin-bottom: 4px; }

    .btn-gold {
      background: var(--gold-gradient);
      color: #000;
      padding: 12px 24px;
      border-radius: 50px;
      font-weight: 700;
      font-size: 14px;
      border: none;
      box-shadow: 0 4px 15px var(--gold-glow);
      display: flex; align-items: center; gap: 8px;
      transition: transform 0.2s;
      cursor: pointer;
    }
    .btn-gold:active { transform: scale(0.96); }

    /* =========================================
       4. STATS CARDS
       ========================================= */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      padding: 20px;
      border-radius: 16px;
      box-shadow: var(--shadow-sm);
    }

    .stat-label { font-size: 12px; font-weight: 700; text-transform: uppercase; color: var(--text-muted); }
    .stat-value { font-size: 24px; font-weight: 800; margin-top: 5px; color: var(--text-main); }
    
    /* Balance Card Highlight */
    .stat-card.dark { background: #111; border-color: #222; }
    .stat-card.dark .stat-value { 
        background: var(--gold-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; 
        font-size: 28px;
    }

    /* =========================================
       5. TABLE (Desktop) & CARDS (Mobile)
       ========================================= */
    .transactions-box {
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: 20px;
      overflow: hidden;
      box-shadow: var(--shadow-md);
    }

    .box-header {
      padding: 18px 24px;
      border-bottom: 1px solid var(--border-color);
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 10px;
    }

    .filter-group { display: flex; gap: 5px; background: var(--row-hover); padding: 4px; border-radius: 10px; }
    .filter-btn {
      padding: 6px 14px; border: none; background: transparent; 
      font-size: 12px; font-weight: 600; color: var(--text-muted); border-radius: 8px; cursor: pointer;
    }
    .filter-btn.active { background: var(--bg-card); color: var(--text-main); box-shadow: 0 2px 4px rgba(0,0,0,0.05); }

    /* TABLE STYLING */
    .table-wrapper { width: 100%; }
    table { width: 100%; border-collapse: collapse; }
    
    th {
      text-align: left; padding: 16px 24px; font-size: 11px; font-weight: 700;
      text-transform: uppercase; color: var(--text-muted); background: var(--row-hover);
      border-bottom: 1px solid var(--border-color);
    }
    
    td {
      padding: 18px 24px; border-bottom: 1px solid var(--border-color);
      font-size: 14px; vertical-align: middle;
    }

    /* --- RESPONSIVE MAGIC (The Fix) --- */
    @media (max-width: 768px) {
      .table-wrapper { padding: 15px; background: var(--bg-body); }
      
      /* Hide standard headers */
      thead { display: none; }
      
      table, tbody, tr, td { display: block; width: 100%; }
      
      tr {
        background: var(--bg-card);
        margin-bottom: 15px;
        border-radius: 12px;
        border: 1px solid var(--border-color);
        box-shadow: var(--shadow-sm);
        padding: 15px;
        /* FLEX CONTAINER FOR THE ROW */
        display: flex; 
        flex-wrap: wrap;
        align-items: center;
      }
      
      /* Reset TD styles for mobile */
      td {
        padding: 0;
        border: none;
        margin-bottom: 0;
      }

      /* Order Elements Logic */
      /* 1. Description (Top Left) */
      td:nth-child(3) { 
        width: 60%; 
        order: 1; 
        font-weight: 700; 
        font-size: 15px; 
        margin-bottom: 8px;
      }
      
      /* 2. Amount (Top Right) */
      td:nth-child(5) { 
        width: 40%; 
        order: 2; 
        text-align: right; 
        font-size: 16px; 
        margin-bottom: 8px;
      }

      /* 3. Date (Bottom Left) */
      td:nth-child(4) { 
        width: 60%; 
        order: 3; 
        font-size: 12px; 
        color: var(--text-muted); 
      }
      
      /* 4. Status (Bottom Right) */
      td:nth-child(6) { 
        width: 40%; 
        order: 4; 
        text-align: right; 
      }

      /* Hide Serial No & Type Badge on mobile to prevent misalignment */
      td:nth-child(1), td:nth-child(2) { display: none; }
    }

    /* Badges & Text Colors */
    .badge { padding: 5px 10px; border-radius: 20px; font-size: 11px; font-weight: 700; text-transform: uppercase; display: inline-block; }
    .badge.credit { background: var(--success-bg); color: var(--success-text); }
    .badge.debit { background: var(--danger-bg); color: var(--danger-text); }
    .badge.failed { background: var(--row-hover); color: var(--text-muted); }

    .amt-credit { color: #16a34a; font-weight: 700; }
    .amt-debit { color: #dc2626; font-weight: 700; }
    .amt-failed { color: var(--text-muted); text-decoration: line-through; }

    /* =========================================
       6. PAGINATION
       ========================================= */
    .pagination { padding: 15px; display: flex; justify-content: center; gap: 5px; border-top: 1px solid var(--border-color); }
    .page-btn {
      width: 32px; height: 32px; border-radius: 8px; border: 1px solid var(--border-color);
      background: var(--bg-card); color: var(--text-muted); display: flex; align-items: center; justify-content: center;
      cursor: pointer; font-size: 12px;
    }
    .page-btn.active { background: var(--gold-gradient); color: #000; border: none; font-weight: 700; }

    /* =========================================
       7. MODAL (Responsive)
       ========================================= */
    .modal {
      display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 1000;
      align-items: center; justify-content: center; padding: 15px; backdrop-filter: blur(5px);
    }
    .modal.show { display: flex; }
    
    .modal-content {
      background: var(--bg-card); width: 100%; max-width: 400px; padding: 25px;
      border-radius: 20px; border: 1px solid var(--border-color); box-shadow: 0 10px 40px rgba(0,0,0,0.2);
    }

    .modal input {
      width: 100%; padding: 15px; border: 2px solid var(--border-color); border-radius: 12px;
      background: var(--bg-body); font-size: 20px; font-weight: 700; color: var(--text-main);
      text-align: center; margin: 15px 0; outline: none;
    }
    .modal input:focus { border-color: var(--gold-primary); }

    .quick-chips { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 20px; }
    .chip {
      padding: 10px; background: var(--bg-body); border: 1px solid var(--border-color);
      border-radius: 8px; font-size: 12px; font-weight: 600; color: var(--text-muted); cursor: pointer;
    }
    .chip.active { background: var(--gold-gradient); color: #000; border: none; }

    .modal-btns { display: flex; gap: 10px; }
    .btn-full { flex: 1; padding: 12px; border-radius: 50px; font-weight: 600; cursor: pointer; font-size: 14px; }
    .btn-close { background: var(--bg-body); color: var(--text-muted); border: 1px solid var(--border-color); }
    .btn-pay { background: var(--gold-gradient); color: #000; border: none; }

    /* =========================================
       RESPONSIVE - Adjust for Tablet
       ========================================= */
    @media (max-width: 1024px) {
      .main-content { 
        grid-template-columns: 240px 1fr; 
      }
    }

    @media (max-width: 480px) {
      .stats-grid { grid-template-columns: 1fr; }
      .page-header { flex-direction: column; align-items: flex-start; }
      .btn-gold { width: 100%; justify-content: center; }
    }
  </style>
</head>

<body>
  <%- include('../../views/partials/user/header') %>

  <div class="wallet-container">
    
    <!-- Use main-content class that sidebar expects -->
    <div class="main-content">
      
      <!-- Your sidebar partial (includes its own toggle button and script) -->
      <%- include("../partials/user/profile-sidebar.ejs", { user: user, activePage: 'wallet' }) %>

      <!-- MAIN CONTENT -->
      <div class="content-section">
        
        <div class="page-header">
          <div class="header-text">
            <div class="breadcrumb">Home / Wallet</div>
            <h1>My Wallet</h1>
          </div>
          <button class="btn-gold" onclick="openAddMoneyModal()">+ Add Money</button>
        </div>

        <div class="stats-grid">
          <div class="stat-card dark">
            <div class="stat-label">Available Balance</div>
            <div class="stat-value" id="walletBalance">₹0.00</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Total Credits</div>
            <div class="stat-value" style="color:#16a34a" id="totalCredits">₹0.00</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Total Debits</div>
            <div class="stat-value" style="color:#dc2626" id="totalDebits">₹0.00</div>
          </div>
        </div>

        <div class="transactions-box">
          <div class="box-header">
            <h2 style="font-size:18px; font-weight:700;">Transactions</h2>
            <div class="filter-group">
              <button class="filter-btn active" onclick="filterTransactions('all', event)">All</button>
              <button class="filter-btn" onclick="filterTransactions('credit', event)">In</button>
              <button class="filter-btn" onclick="filterTransactions('debit', event)">Out</button>
            </div>
          </div>

          <div class="table-wrapper">
            <table>
              <thead>
                <tr>
                  <th style="width: 50px;">#</th>
                  <th style="width: 80px;">Type</th>
                  <th>Description</th>
                  <th style="width: 150px;">Date</th>
                  <th style="width: 120px;">Amount</th>
                  <th style="width: 100px;">Status</th>
                </tr>
              </thead>
              <tbody id="transactionBody">
                <tr><td colspan="6" style="text-align:center; padding:30px; color:var(--text-muted)">Loading...</td></tr>
              </tbody>
            </table>
          </div>

          <div class="pagination" id="paginationContainer"></div>
        </div>
      </div>
    </div>
  </div>

  <div id="addMoneyModal" class="modal">
    <div class="modal-content">
      <h3 style="font-size:18px; font-weight:800; margin-bottom:5px">Add Funds</h3>
      <p style="font-size:12px; color:var(--text-muted)">Secured by Razorpay</p>
      
      <input type="number" id="amountInput" placeholder="₹ Enter Amount" />
      
      <div class="quick-chips">
        <button class="chip" onclick="setQuickAmount(100, event)">₹100</button>
        <button class="chip" onclick="setQuickAmount(500, event)">₹500</button>
        <button class="chip" onclick="setQuickAmount(1000, event)">₹1000</button>
        <button class="chip" onclick="setQuickAmount(2000, event)">₹2000</button>
        <button class="chip" onclick="setQuickAmount(5000, event)">₹5000</button>
        <button class="chip" onclick="setQuickAmount(10000, event)">₹10k</button>
      </div>
      
      <div class="modal-btns">
        <button class="btn-full btn-close" onclick="closeAddMoneyModal()">Cancel</button>
        <button class="btn-full btn-pay" onclick="proceedToPayment()">Pay Now</button>
      </div>
    </div>
  </div>

  <%- include('../../views/partials/user/footer') %>

  <script>
    let currentPage = 1, totalPages = 1, currentFilter = "all";

    document.addEventListener("DOMContentLoaded", () => {
      loadWalletData();
      loadTransactions(1);
    });

    async function loadWalletData() {
      try {
        const res = await fetch("/api/wallet/data");
        const data = await res.json();
        document.getElementById("walletBalance").textContent = "₹" + parseFloat(data.balance||0).toFixed(2);
        document.getElementById("totalCredits").textContent = "₹" + parseFloat(data.totalCredits||0).toFixed(2);
        document.getElementById("totalDebits").textContent = "₹" + parseFloat(data.totalDebits||0).toFixed(2);
      } catch (e) { console.error(e); }
    }

    function filterTransactions(type, e) {
      currentFilter = type; currentPage = 1;
      document.querySelectorAll(".filter-btn").forEach(b => b.classList.remove("active"));
      e.target.classList.add("active");
      loadTransactions(1);
    }

    async function loadTransactions(page) {
      try {
        const res = await fetch(`/api/wallet/transactions?page=${page}&filter=${currentFilter}`);
        const data = await res.json();
        totalPages = data.totalPages || 1; currentPage = page;
        renderTransactions(data.transactions || []);
        renderPagination();
      } catch (e) { console.error(e); }
    }

    function renderTransactions(transactions) {
      const tbody = document.getElementById("transactionBody");
      if (!transactions.length) {
        tbody.innerHTML = `<tr><td colspan="6" style="text-align:center; padding:30px; color:var(--text-muted)">No transactions</td></tr>`;
        return;
      }
      
      tbody.innerHTML = transactions.map(t => {
        const isCredit = t.type === 'credit';
        const isFailed = t.type === 'failed';
        const amtClass = isCredit ? 'amt-credit' : isFailed ? 'amt-failed' : 'amt-debit';
        const badgeClass = isCredit ? 'credit' : isFailed ? 'failed' : 'debit';
        const sign = isCredit ? '+' : isFailed ? '' : '-';
        
        let desc = t.description;
        if(desc === "Add Money") desc = "Wallet Top-up";
        if(desc === "Purchase") desc = "Purchase";
        let sub = t.details || t.productName || "";
        if(sub === "null" || !sub) sub = "";

        return `
          <tr>
            <td>${t.serialNo}</td>
            <td><span class="badge ${badgeClass}" style="opacity:0.8">${t.type}</span></td>
            <td>
              <div style="font-weight:600; color:var(--text-main)">${desc}</div>
              <div style="font-size:12px; color:var(--text-muted)">${sub}</div>
            </td>
            <td>
              <div style="font-weight:500">${t.date}</div>
              <div style="font-size:11px; color:var(--text-muted)">${t.time}</div>
            </td>
            <td class="${amtClass}">${sign}₹${t.amount}</td>
            <td><span class="badge ${badgeClass}">${isCredit ? 'Success' : isFailed ? 'Failed' : 'Debited'}</span></td>
          </tr>
        `;
      }).join('');
    }

    function renderPagination() {
      const div = document.getElementById("paginationContainer");
      div.innerHTML = "";
      if (totalPages <= 1) return;
      
      const btn = (p, t, a) => `<button class="page-btn ${a?'active':''}" onclick="loadTransactions(${p})">${t}</button>`;
      
      if(currentPage > 1) div.innerHTML += btn(currentPage-1, "←", false);
      for(let i=1; i<=totalPages; i++) {
        if(i==1 || i==totalPages || Math.abs(i-currentPage)<=1) div.innerHTML += btn(i, i, i===currentPage);
      }
      if(currentPage < totalPages) div.innerHTML += btn(currentPage+1, "→", false);
    }

    function openAddMoneyModal() { document.getElementById("addMoneyModal").classList.add("show"); document.body.style.overflow="hidden"; }
    function closeAddMoneyModal() { 
        document.getElementById("addMoneyModal").classList.remove("show"); document.body.style.overflow=""; 
        document.getElementById("amountInput").value = "";
        document.querySelectorAll(".chip").forEach(c => c.classList.remove("active"));
    }
    function setQuickAmount(v, e) {
        document.getElementById("amountInput").value = v;
        document.querySelectorAll(".chip").forEach(c => c.classList.remove("active"));
        if(e) e.target.classList.add("active");
    }

    async function proceedToPayment() {
      const amount = parseFloat(document.getElementById("amountInput").value);
      if(!amount || amount < 10) return Swal.fire("Error", "Min Amount ₹10", "error");

      try {
        const res = await fetch("/api/wallet/create-add-money-order", {
            method: "POST", headers: {"Content-Type":"application/json"}, body: JSON.stringify({amount})
        });
        const order = await res.json();
        if(!order.success) throw new Error(order.message);

        const rzp = new Razorpay({
            key: order.keyId, amount: order.amount, currency: order.currency,
            name: "Wallet Top-up", order_id: order.orderId,
            theme: { color: "#e5c14a" },
            handler: async (resp) => {
                await fetch("/api/wallet/verify-add-money-payment", {
                    method: "POST", headers: {"Content-Type":"application/json"},
                    body: JSON.stringify({...resp, amount})
                });
                Swal.fire("Success", "Added!", "success");
                loadWalletData(); loadTransactions(1); closeAddMoneyModal();
            }
        });
        rzp.open();
      } catch(e) { Swal.fire("Error", e.message, "error"); }
    }
    window.onclick = e => { if(e.target.id === 'addMoneyModal') closeAddMoneyModal(); }
  </script>
</body>
</html>