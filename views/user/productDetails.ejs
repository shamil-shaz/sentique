<%- include('../../views/partials/user/header') %>

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= product.productName %> - Sentique</title>

    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
      rel="stylesheet">
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet">
    <link
      href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css"
      rel="stylesheet">

    <style>
:root {
  --bg-body: #ffffff; --bg-card: #ffffff; --bg-input: #f8f8f8;
  --text-main: #1a1a1a; --text-muted: #666666; --border: #e0e0e0;
  --accent-color: #1a1a1a; --accent-text: #ffffff;
  --stock-green: #27ae60; --stock-red: #c0392b;
}
body.dark-mode {
  --bg-body: #0a0a0a; --bg-card: #141414; --bg-input: #1a1a1a;
  --text-main: #e0e0e0; --text-muted: #999999; --border: #333333;
  --accent-color: #e2c055; --accent-text: #000000;
  --stock-green: #4ade80; --stock-red: #ef4444;
}
* { margin: 0; padding: 0; box-sizing: border-box; }
body { background-color: var(--bg-body); color: var(--text-main); font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; font-size: 14px; line-height: 1.6; transition: background 0.3s, color 0.3s; overflow-x: hidden; }
img { max-width: 100%; height: auto; display: block; }
a { text-decoration: none; color: inherit; transition: all 0.2s; }
ul { list-style: none; padding: 0; margin: 0; }
button { font-family: inherit; cursor: pointer; border: none; outline: none; }
input, textarea { font-family: inherit; }
::-webkit-scrollbar { width: 8px; height: 8px; }
::-webkit-scrollbar-track { background: var(--bg-body); }
::-webkit-scrollbar-thumb { background: #666; border-radius: 4px; }
::-webkit-scrollbar-thumb:hover { background: #555; }
body.dark-mode ::-webkit-scrollbar-thumb { background: #444; }
.main-container { max-width: 1200px; margin: 0 auto; padding: 0 20px; width: 100%; }
.breadcrumb-nav { padding: 20px 0; font-size: 13px; color: var(--text-muted); border-bottom: 1px solid var(--border); margin-bottom: 30px; }
.breadcrumb-nav a { transition: color 0.2s; }
.breadcrumb-nav a:hover { color: var(--accent-color); }
.breadcrumb-nav strong { color: var(--text-main); font-weight: 600; }
.product-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 40px; margin-bottom: 60px; align-items: start; }
.gallery-section { display: flex; gap: 15px; height: 500px; width: 100%; }
.thumbnails { display: flex; flex-direction: column; gap: 10px; width: 70px; overflow-y: auto; flex-shrink: 0; }
.thumbnail { width: 70px; height: 70px; border: 2px solid var(--border); cursor: pointer; opacity: 0.6; transition: all 0.3s; border-radius: 4px; overflow: hidden; flex-shrink: 0; }
.thumbnail.active { opacity: 1; border-color: var(--accent-color); box-shadow: 0 0 0 1px var(--accent-color); }
.thumbnail:hover { opacity: 1; border-color: var(--accent-color); }
.thumbnail img { width: 100%; height: 100%; object-fit: cover; }
.main-image { flex: 1; background: var(--bg-card); border: 1px solid var(--border); border-radius: 4px; display: flex; align-items: center; justify-content: center; overflow: hidden; cursor: zoom-in; position: relative; min-height: 400px; }
.main-image img { max-width: 90%; max-height: 90%; object-fit: contain; transition: transform 0.3s; }
.main-image.zoomed { cursor: zoom-out; }
.main-image.zoomed img { transform: scale(2); }
.product-info { padding-top: 0; width: 100%; }
.brand-tag { color: var(--text-muted); font-size: 11px; font-weight: 700; letter-spacing: 1.5px; text-transform: uppercase; margin-bottom: 8px; display: inline-block; }
body.dark-mode .brand-tag { color: var(--accent-color); }
.product-title { font-size: 28px; font-weight: 600; margin-bottom: 12px; line-height: 1.3; color: var(--text-main); }
.rating-wrap { display: flex; align-items: center; gap: 10px; font-size: 13px; margin-bottom: 18px; color: var(--text-muted); }
.stars { color: #f1c40f; font-size: 14px; line-height: 1; display: flex; gap: 2px; }
body.dark-mode .stars { color: var(--accent-color); }
.stars i { font-size: 14px; }
.price-wrap { display: flex; align-items: baseline; gap: 12px; margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid var(--border); flex-wrap: wrap; }
.current-price { font-size: 32px; color: var(--accent-color); font-weight: 700; line-height: 1; }
.old-price { text-decoration: line-through; color: var(--text-muted); font-size: 18px; }
.discount-tag { background: var(--stock-red); color: #fff; font-size: 11px; font-weight: 700; padding: 4px 8px; border-radius: 4px; line-height: 1; }
.description { color: var(--text-muted); font-size: 14px; line-height: 1.6; margin-bottom: 24px; }
.option-title { font-size: 12px; font-weight: 600; text-transform: uppercase; color: var(--text-main); margin-bottom: 10px; display: block; letter-spacing: 0.5px; }
.options-grid { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 10px; }
.size-btn { background: var(--bg-body); border: 2px solid var(--border); color: var(--text-main); padding: 10px 20px; font-size: 13px; cursor: pointer; min-width: 70px; transition: all 0.2s; border-radius: 4px; font-weight: 500; text-align: center; }
.size-btn:hover:not(:disabled) { border-color: var(--accent-color); color: var(--accent-color); transform: translateY(-2px); box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
.size-btn.active { background: var(--accent-color); color: var(--accent-text); border-color: var(--accent-color); font-weight: 600; transform: translateY(-2px); box-shadow: 0 2px 8px rgba(0,0,0,0.15); }
body.dark-mode .size-btn.active { color: #000; }
.size-btn:disabled { opacity: 0.3; cursor: not-allowed; text-decoration: line-through; transform: none !important; }
.stock-text { font-size: 13px; margin-top: 8px; font-weight: 500; min-height: 22px; line-height: 1.4; }
.stock-green { color: var(--stock-green); }
.stock-low { color: #e67e22; }
.stock-out { color: var(--stock-red); }
.action-row { display: flex; gap: 12px; margin-top: 30px; align-items: stretch; width: 100%; }
.qty-wrap { display: flex; align-items: stretch; border: 2px solid var(--border); width: 120px; height: 48px; background: var(--bg-body); border-radius: 4px; overflow: hidden; flex-shrink: 0; }
.qty-btn { width: 36px; background: transparent; border: none; color: var(--text-main); cursor: pointer; font-size: 14px; display: flex; align-items: center; justify-content: center; padding: 0; transition: all 0.2s; flex-shrink: 0; }
.qty-btn:hover:not(:disabled) { background: var(--bg-input); color: var(--accent-color); }
.qty-btn:active { background: var(--border); transform: scale(0.95); }
.qty-btn:disabled { opacity: 0.5; cursor: not-allowed; }
.qty-input { flex: 1; background: transparent; border: none; border-left: 2px solid var(--border); border-right: 2px solid var(--border); color: var(--text-main); text-align: center; font-size: 16px; font-weight: 600; padding: 0; width: 100%; min-width: 0; }
.qty-input:focus { outline: none; background: var(--bg-input); }
.add-btn { flex: 1; background: var(--accent-color); color: var(--accent-text); border: none; font-weight: 600; font-size: 13px; text-transform: uppercase; letter-spacing: 1px; cursor: pointer; transition: all 0.3s; height: 48px; border-radius: 4px; min-width: 0; position: relative; overflow: hidden; }
body.dark-mode .add-btn { color: #000; }
.add-btn:hover:not(:disabled) { opacity: 0.9; transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
.add-btn:active { transform: translateY(0); }
.add-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none !important; }
.wish-btn { width: 48px; height: 48px; background: var(--bg-body); border: 2px solid var(--border); border-radius: 4px; color: var(--text-main); cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 18px; transition: all 0.3s; flex-shrink: 0; }
.wish-btn:hover { border-color: var(--stock-red); color: var(--stock-red); transform: scale(1.08); background: rgba(192, 57, 43, 0.05); }
.wish-btn:active { transform: scale(0.95); }
.wish-btn.added { background: var(--stock-red); border-color: var(--stock-red); color: #fff; animation: heartBeat 0.3s; }
@keyframes heartBeat { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.2); } }
.tab-nav { display: flex; gap: 40px; border-bottom: 2px solid var(--border); margin: 60px 0 30px; overflow-x: auto; }
.tab-link { background: transparent; border: none; padding: 14px 0; color: var(--text-muted); font-size: 15px; font-weight: 600; cursor: pointer; border-bottom: 3px solid transparent; margin-bottom: -2px; transition: all 0.3s; white-space: nowrap; }
.tab-link:hover { color: var(--text-main); }
.tab-link.active { color: var(--accent-color); border-color: var(--accent-color); }
.tab-content { display: none; padding: 20px 0; }
.tab-content.active { display: block; animation: fadeIn 0.4s; }
@keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
.review-split { display: grid; grid-template-columns: 300px 1fr; gap: 40px; }
.rating-box { padding: 25px; background: var(--bg-card); border: 1px solid var(--border); border-radius: 8px; position: sticky; top: 20px; }
.total-score { font-size: 52px; font-weight: 700; color: var(--text-main); line-height: 1; margin-bottom: 8px; }
.bar-line { display: flex; align-items: center; gap: 10px; font-size: 12px; margin-bottom: 10px; color: var(--text-muted); }
.progress-bg { flex: 1; height: 8px; background: var(--bg-input); border-radius: 4px; overflow: hidden; }
.progress-fill { height: 100%; background: #f1c40f; transition: width 0.3s; }
body.dark-mode .progress-fill { background: var(--accent-color); }
.review-item { padding: 24px 0; border-bottom: 1px solid var(--border); }
.review-item:last-child { border-bottom: none; }
.rev-head { display: flex; justify-content: space-between; margin-bottom: 10px; flex-wrap: wrap; gap: 10px; }
.rev-name { font-weight: 700; font-size: 15px; color: var(--text-main); }
.rev-date { font-size: 12px; color: var(--text-muted); margin-left: 10px; }
.rev-stars { font-size: 14px; color: #f1c40f; }
body.dark-mode .rev-stars { color: var(--accent-color); }
.rev-text { font-size: 14px; color: var(--text-muted); line-height: 1.7; }
.write-rev { background: var(--bg-card); padding: 24px; margin-top: 24px; border: 1px solid var(--border); border-radius: 8px; }
.write-rev h5 { font-size: 16px; margin-bottom: 16px; font-weight: 600; color: var(--text-main); }
.stars-input { display: flex; flex-direction: row-reverse; justify-content: flex-end; gap: 8px; margin-bottom: 16px; }
.s-inp { display: none; }
.s-lbl { font-size: 24px; color: #ddd; cursor: pointer; transition: all 0.2s; }
.s-inp:checked ~ .s-lbl, .s-lbl:hover, .s-lbl:hover ~ .s-lbl { color: #f1c40f; transform: scale(1.1); }
body.dark-mode .s-inp:checked ~ .s-lbl, body.dark-mode .s-lbl:hover, body.dark-mode .s-lbl:hover ~ .s-lbl { color: var(--accent-color); }
.rev-input { width: 100%; background: var(--bg-input); border: 2px solid var(--border); color: var(--text-main); padding: 12px 16px; font-size: 14px; margin: 0 0 16px 0; font-family: inherit; border-radius: 6px; transition: all 0.2s; resize: vertical; }
.rev-input:focus { outline: none; border-color: var(--accent-color); background: var(--bg-body); }
.rev-input::placeholder { color: var(--text-muted); opacity: 0.6; }
.section-head { font-size: 26px; font-weight: 700; text-align: center; margin: 60px 0 40px; color: var(--text-main); }
.related-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 24px; margin-bottom: 60px; }
.mini-card { display: block; background: var(--bg-card); border: 1px solid var(--border); transition: all 0.3s; text-decoration: none; border-radius: 8px; overflow: hidden; position: relative; }
.mini-card:hover { border-color: var(--accent-color); transform: translateY(-6px); box-shadow: 0 8px 20px rgba(0,0,0,0.1); }
body.dark-mode .mini-card:hover { box-shadow: 0 8px 24px rgba(226, 192, 85, 0.2); }
.mc-img-box { height: 280px; overflow: hidden; position: relative; background: #fafafa; }
body.dark-mode .mc-img-box { background: #1a1a1a; }
.mc-discount-badge { position: absolute; top: 12px; right: 12px; background: var(--stock-red); color: #fff; padding: 6px 10px; border-radius: 4px; font-size: 11px; font-weight: 700; z-index: 2; box-shadow: 0 2px 8px rgba(0,0,0,0.2); }
.mc-img { width: 100%; height: 100%; object-fit: cover; transition: transform 0.4s; }
.mini-card:hover .mc-img { transform: scale(1.08); }
.mc-details { padding: 18px; text-align: center; }
.mc-brand { font-size: 11px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1.2px; margin-bottom: 6px; font-weight: 600; }
body.dark-mode .mc-brand { color: var(--accent-color); }
.mc-name { font-size: 15px; color: var(--text-main); margin-bottom: 8px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-weight: 600; }
.mc-price-wrap { display: flex; align-items: center; justify-content: center; gap: 8px; }
.mc-price { font-size: 18px; color: var(--accent-color); font-weight: 700; }
.mc-old-price { font-size: 14px; color: var(--text-muted); text-decoration: line-through; }

@media (max-width: 1024px) {
  .main-container { padding: 0 16px; }
  .product-grid { gap: 30px; }
  .related-grid { grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 20px; }
}
@media (max-width: 768px) {
  .product-grid { grid-template-columns: 1fr; gap: 30px; }
  .gallery-section { height: auto; flex-direction: column-reverse; gap: 12px; }
  .thumbnails { flex-direction: row; width: 100%; height: auto; overflow-x: auto; gap: 8px; }
  .thumbnail { width: 60px; height: 60px; }
  .main-image { min-height: 350px; }
  .product-title { font-size: 24px; }
  .current-price { font-size: 28px; }
  .review-split { grid-template-columns: 1fr; gap: 30px; }
  .rating-box { position: static; }
  .related-grid { grid-template-columns: repeat(2, 1fr); gap: 16px; }
  .mc-img-box { height: 200px; }
  .tab-nav { gap: 24px; }
  .tab-link { font-size: 14px; padding: 12px 0; }
}
@media (max-width: 480px) {
  .main-container { padding: 0 12px; }
  .breadcrumb-nav { font-size: 12px; padding: 16px 0; margin-bottom: 20px; }
  .product-grid { gap: 24px; margin-bottom: 40px; }
  .main-image { min-height: 300px; }
  .product-title { font-size: 20px; margin-bottom: 10px; }
  .brand-tag { font-size: 10px; }
  .rating-wrap { font-size: 12px; margin-bottom: 14px; }
  .stars { font-size: 12px; }
  .current-price { font-size: 24px; }
  .old-price { font-size: 14px; }
  .description { font-size: 13px; margin-bottom: 20px; }
  .option-title { font-size: 11px; }
  .size-btn { padding: 8px 14px; font-size: 12px; min-width: 60px; }
  .action-row { gap: 10px; margin-top: 24px; }
  .qty-wrap { width: 100px; height: 44px; }
  .qty-btn { width: 32px; font-size: 13px; }
  .qty-input { font-size: 15px; }
  .add-btn { height: 44px; font-size: 12px; letter-spacing: 0.5px; }
  .wish-btn { width: 44px; height: 44px; font-size: 16px; }
  .tab-nav { gap: 20px; margin: 40px 0 20px; }
  .tab-link { font-size: 13px; padding: 10px 0; }
  .section-head { font-size: 20px; margin: 40px 0 24px; }
  .related-grid { gap: 12px; }
  .mc-img-box { height: 180px; }
  .mc-details { padding: 12px; }
  .mc-brand { font-size: 10px; }
  .mc-name { font-size: 13px; margin-bottom: 6px; }
  .mc-price { font-size: 15px; }
  .write-rev { padding: 18px; }
  .write-rev h5 { font-size: 14px; }
  .rev-input { font-size: 13px; padding: 10px 12px; }
  .s-lbl { font-size: 20px; }
}
@media (max-width: 320px) {
  .action-row { flex-wrap: wrap; }
  .qty-wrap { width: calc(50% - 5px); }
  .add-btn { width: calc(50% - 5px); flex: none; }
  .wish-btn { width: 100%; margin-top: 10px; }
  .related-grid { grid-template-columns: 1fr; }
}

body.dark-mode #maxLimitMsg {
  color:#f59e0b;
}

.limit-warning {
  margin-top:8px;
  font-size:13px;
  font-weight:500;
  color:#eab308;
  display:flex;
  align-items:center;
  gap:6px;
}
body.dark-mode .limit-warning {
  color:#f59e0b;
}


  </style>
  </head>

  <body>

    <div class="main-container">
      <nav class="breadcrumb-nav">
        <a href="/">Home</a> / <a href="/shopPage">Shop</a> /

        <strong><%= product.productName %></strong>
      </nav>
    </div>

    <div class="main-container">
      <div class="product-grid">

        <div class="gallery-section">
          <div class="thumbnails">
            <% product.images.forEach((img, i) => { %>
            <div class="thumbnail <%= i === 0 ? 'active' : '' %>"
              onclick="changeImage(this, '<%= img %>')">
              <img src="<%= img %>" alt="thumb">
            </div>
            <% }) %>
          </div>
          <div class="main-image" id="zoomBox">
            <img id="mainImage" src="<%= product.images[0] %>"
              alt="<%= product.productName %>">
          </div>
        </div>

        <div class="product-info">
          <span class="brand-tag">
            <% if(product.brand) { %><%= product.brand.brandName %><% } else {
            %>SENTIQUE<% } %>
          </span>

          <h1 class="product-title"><%= product.productName %></h1>

          <div class="rating-wrap">
            <div class="stars">
              <%
              const full = Math.floor(parseFloat(averageRating || 0));
              const half = (averageRating % 1) > 0;
              for(let i=0; i<5; i++) {
              if(i < full) { %><i class="fas fa-star"></i><% }
              else if(i===full && half) { %><i
                class="fas fa-star-half-alt"></i><% }
              else { %><i class="far fa-star"></i><% }
              }
              %>
            </div>
            <span><%= totalReviews > 0 ? `(${totalReviews} Reviews)` :
              'No reviews yet' %></span>
          </div>

          <div class="price-wrap">
            <span class="current-price" id="currentPrice">
             <%
const firstAvailableVariant = product.variants.find(v => v.stock > 0) || product.variants[0];
%>

<span class="current-price" id="currentPrice">
  ₹<%= firstAvailableVariant.salePrice.toFixed(2) %>
</span>

<% if(firstAvailableVariant.regularPrice > firstAvailableVariant.salePrice) { %>
<span class="old-price" id="regularPrice">
  ₹<%= firstAvailableVariant.regularPrice.toFixed(2) %>
</span>
<span class="discount-tag" id="discountTag">
  <%= Math.round(((firstAvailableVariant.regularPrice - firstAvailableVariant.salePrice) / firstAvailableVariant.regularPrice) * 100) %>% OFF
</span>
<% } %>

            </span>
            <% if(product.variants[0]?.regularPrice >
            product.variants[0]?.salePrice) { %>
            <span class="old-price" id="regularPrice">₹<%=
              product.variants[0]?.regularPrice.toFixed(2) %></span>
            <span class="discount-tag" id="discountTag">
              <%= Math.round(((product.variants[0]?.regularPrice -
              product.variants[0]?.salePrice) /
              product.variants[0]?.regularPrice) * 100) %>% OFF
            </span>
            <% } %>
          </div>

          <p class="description"><%= product.description %></p>

          <div style="margin-bottom: 25px;">
           <label class="option-title">Select Volume</label>
<div class="options-grid">
<% product.variants.forEach((variant, i) => { %>

  <button
    class="size-btn <%= i === 0 ? 'active' : '' %>"
    data-size="<%= variant.size %>"
    data-sale="<%= variant.salePrice %>"
    data-regular="<%= variant.regularPrice %>"
    data-stock="<%= variant.stock %>"
    <%= variant.stock === 0 ? 'disabled' : '' %>
    onclick="selectVariant(this)">
    <%= variant.size %> ML
  </button>

<% }) %>
</div>

            <div id="stockDisplay" class="stock-text"></div>
          </div>

          <div class="action-row">
            <div class="qty-wrap">

              <button class="qty-btn" type="button" onclick="changeQty(-1)"><i
                  class="fas fa-minus"></i></button>
              <input type="text" id="quantity" class="qty-input" value="1"
                readonly>
              <button class="qty-btn" type="button" onclick="changeQty(1)"><i
                  class="fas fa-plus"></i></button>
            </div>

            <button class="add-btn" id="addToCartBtn">Add to Cart</button>

            <button class="wish-btn" id="wishlistBtn">
              <i class="far fa-heart"></i>
            </button>

          </div>
          <div id="maxLimitMsg" style="
  display:none;
  font-size:13px;
  color:#eab308;
  margin-top:8px;
  font-weight:500;
  
  align-items:center;
  gap:6px;
">
            <i class="fas fa-info-circle"></i>
            Maximum 5 items per order
          </div>
        </div>
      </div>

      <div class="tab-nav">
        <button class="tab-link active"
          onclick="switchTab('desc', this)">Description</button>
        <button class="tab-link" onclick="switchTab('rev', this)">Reviews (<%=
          totalReviews %>)</button>
      </div>

      <div id="desc" class="tab-content active">
        <div
          style="color: var(--text-muted); font-size: 15px; max-width: 800px; line-height: 1.7;">
          <%= product.longDescription || product.Longdescription ||
          product.description %>
        </div>
      </div>

      <div id="rev" class="tab-content">
        <div class="review-split">
          <div>
            <% if(totalReviews > 0) { %>
            <div class="rating-box">
              <div class="total-score"><%= parseFloat(averageRating).toFixed(1)
                %></div>
              <div
                style="font-size: 12px; color: var(--text-muted); margin-bottom: 15px;">Average
                Rating</div>
              <% [5,4,3,2,1].forEach(star => { %>
              <div class="bar-line">
                <span style="width:10px;"><%= star %></span> <i
                  class="fas fa-star" style="font-size:10px;"></i>
                <div class="progress-bg"><div class="progress-fill"
                    style="width: <%= ratingPercentage[star] || 0 %>%;"></div></div>
                <span style="width:20px; text-align:right;"><%=
                  ratingDistribution[star] || 0 %></span>
              </div>
              <% }) %>
            </div>
            <% } %>

            <% if(user && !userHasReviewed) { %>
            <div class="write-rev">
              <h5>Write a Review</h5>
              <form id="reviewForm">
                <div class="stars-input">
                  <input type="radio" id="s5" name="rating" value="5"
                    class="s-inp" hidden required><label for="s5"
                    class="s-lbl">★</label>
                  <input type="radio" id="s4" name="rating" value="4"
                    class="s-inp" hidden required><label for="s4"
                    class="s-lbl">★</label>
                  <input type="radio" id="s3" name="rating" value="3"
                    class="s-inp" hidden required><label for="s3"
                    class="s-lbl">★</label>
                  <input type="radio" id="s2" name="rating" value="2"
                    class="s-inp" hidden required><label for="s2"
                    class="s-lbl">★</label>
                  <input type="radio" id="s1" name="rating" value="1"
                    class="s-inp" hidden required><label for="s1"
                    class="s-lbl">★</label>
                </div>
                <textarea id="reviewComment" class="rev-input" rows="4"
                  placeholder="Share your thoughts..." required></textarea>
                <button type="submit" class="add-btn"
                  style="margin-top:10px;">Submit Review</button>
              </form>
            </div>
            <% } %>
          </div>

          <div>
            <% if(reviews && reviews.length > 0) { %>
            <% reviews.forEach(review => { %>
            <div class="review-item">
              <div class="rev-head">
                <div>
  <span class="rev-name">
  <%= (review.userId && review.userId.name) ? review.userId.name : "Customer" %>
</span>


                  <span class="rev-date"><%= new
                    Date(review.createdAt).toLocaleDateString() %></span>
                </div>
                <div class="rev-stars">
                  <% for(let i=0; i<5; i++) { %><%= i < review.rating ? '★' :
                  '☆' %><% } %>
                </div>
              </div>
              <div class="rev-text"><%= review.comment %></div>
            </div>
            <% }) %>
            <% } else { %>
            <p style="color: var(--text-muted); font-style: italic;">No reviews
              yet. Be the first to review!</p>
            <% } %>
          </div>
        </div>
      </div>

      <h2 class="section-head">You May Also Like</h2>
      <div class="related-grid">
        <% if(relatedProducts && relatedProducts.length > 0) { %>
     <% relatedProducts.forEach(prod => { 
    
    if (!prod || !prod.variants || prod.variants.length === 0) return;

  
    const bestVariant = prod.variants.find(v => v.stock > 0) || prod.variants[0];
    
    
    if (!bestVariant) return; 

    const relSale = bestVariant.salePrice || 0;
    const relReg = bestVariant.regularPrice || 0;

    const hasDiscount = relReg > relSale && relSale > 0;
    const discount = hasDiscount ? Math.round(((relReg - relSale) / relReg) * 100) : 0;
%>
        <a href="/productDetails?id=<%= prod._id %>" class="mini-card">
          <div class="mc-img-box">
            <% if(hasDiscount) { %>
            <div class="mc-discount-badge"><%= discount %>% OFF</div>
            <% } %>
            <img src="<%= prod.images[0] %>" class="mc-img"
              alt="<%= prod.productName %>">
          </div>
          <div class="mc-details">
           <div class="mc-brand">
    <%= (prod.brand && prod.brand.brandName) ? prod.brand.brandName : 'SENTIQUE' %>
</div>
            <div class="mc-name"><%= prod.productName %></div>
            <div class="mc-price-wrap">
              <div class="mc-price">₹<%= relSale.toFixed(2) %></div>
              <% if(hasDiscount) { %>
              <div class="mc-old-price">₹<%= relReg.toFixed(2) %></div>
              <% } %>
            </div>
          </div>
        </a>
        <% }) %>
        <% } %>
      </div>
    </div>

    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script
      src="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.js"></script>

    <script>
    const productId = '<%= product._id %>';
    let currentVariant = null;
    let cartItemQuantity = 0;

    // ====== VARIANT & STOCK LOGIC ======
    function selectVariant(btn) {
      document.querySelectorAll('.size-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      
      const stock = parseInt(btn.dataset.stock);
      const sale = parseFloat(btn.dataset.sale);
      const regular = parseFloat(btn.dataset.regular);
      const size = btn.dataset.size;
      
      currentVariant = { size, sale, regular, stock };
      
      // Update price display
      document.getElementById('currentPrice').textContent = `₹${sale.toFixed(2)}`;
      
      const priceWrap = document.querySelector('.price-wrap');
      if (regular > sale && sale > 0) {
        const discount = Math.round(((regular - sale) / regular) * 100);
        priceWrap.innerHTML = `
          <span class="current-price" id="currentPrice">₹${sale.toFixed(2)}</span>
          <span class="old-price" id="regularPrice">₹${regular.toFixed(2)}</span>
          <span class="discount-tag" id="discountTag">${discount}% OFF</span>
        `;
      } else {
        priceWrap.innerHTML = `<span class="current-price" id="currentPrice">₹${sale.toFixed(2)}</span>`;
      }
      
      const stockDisplay = document.getElementById('stockDisplay');
      if (stock === 0) {
        stockDisplay.innerHTML = '<span class="stock-out">Out of Stock</span>';
      } else if (stock < 10) {
        stockDisplay.innerHTML = `<span class="stock-low">Hurry! Only ${stock} left in stock</span>`;
      } else {
        stockDisplay.innerHTML = `<span class="stock-green">In Stock (${stock} available)</span>`;
      }
      
      document.getElementById('quantity').value = 1;
      document.getElementById('maxLimitMsg').style.display = 'none';

      checkCartQuantityForVariant(Number(size));
updateQuantityButtonStates();

    }


   async function checkCartQuantityForVariant(variantSize) {
  try {
    const response = await fetch('/cart/check', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ productId, variantSize })
    });

    const data = await response.json();
    cartItemQuantity = data.quantity || 0;

    updateQuantityButtonStates(); // <= only here!

  } catch (error) {
    console.error('Error checking cart:', error);
    cartItemQuantity = 0;
    updateQuantityButtonStates(); // <= still update UI
  }
}


    // Images
    function changeImage(thumb, src) {
      document.querySelectorAll('.thumbnail').forEach(t => t.classList.remove('active'));
      thumb.classList.add('active');
      document.getElementById('mainImage').src = src;
    }

    // Zoom
    const zoomBox = document.getElementById('zoomBox');
    const mainImage = document.getElementById('mainImage');
    let isZoomed = false;

    zoomBox.addEventListener('click', () => {
      isZoomed = !isZoomed;
      if(isZoomed) zoomBox.classList.add('zoomed');
      else zoomBox.classList.remove('zoomed');
    });

    zoomBox.addEventListener('mousemove', (e) => {
      if (!isZoomed) return;
      const rect = zoomBox.getBoundingClientRect();
      const x = ((e.clientX - rect.left) / rect.width) * 100;
      const y = ((e.clientY - rect.top) / rect.height) * 100;
      mainImage.style.transformOrigin = `${x}% ${y}%`;
    });

   function changeQty(n) {
  const el = document.getElementById('quantity');
  let v = parseInt(el.value) + n;

  const maxAllowed = Math.min(5, currentVariant.stock) - cartItemQuantity;

  v = Math.max(1, Math.min(maxAllowed, v));
  el.value = v;

  updateQuantityButtonStates();
}


    function updateQuantityButtonStates() {
  const quantityInput = document.getElementById('quantity');
  const currentValue = parseInt(quantityInput.value) || 1;
  const qtyBtns = document.querySelectorAll('.qty-btn');
  const addToCartBtn = document.getElementById('addToCartBtn');
  const maxLimitMsg = document.getElementById('maxLimitMsg');

  const maxAllowed = Math.min(5, currentVariant.stock) - cartItemQuantity;

  // Show limit msg
  if (maxAllowed <= 0) {
    maxLimitMsg.style.display = 'block';
  } else {
    maxLimitMsg.style.display = 'none';
  }

  // disable minus
  qtyBtns[0].disabled = currentValue <= 1;

  // disable plus
  qtyBtns[1].disabled = currentValue >= maxAllowed || maxAllowed <= 0;

  // disable add to cart
  addToCartBtn.disabled = maxAllowed <= 0 || currentVariant.stock === 0;
}


    // Cart
    document.getElementById('addToCartBtn').addEventListener('click', async () => {
  if (!currentVariant || currentVariant.stock === 0) {
    showToast('warning', 'Please select an available variant');
    return;
  }

  const quantity = parseInt(document.getElementById('quantity').value) || 1;
  const totalQuantity = cartItemQuantity + quantity;

  // CLIENT-SIDE LIMIT CHECK (before backend)
  if (cartItemQuantity >= 5) {
    showToast('warning', `Maximum 5 items allowed. You already have 5 in cart.`);
    return; // <-- stop here
  }

  if (totalQuantity > 5) {
    const remaining = 5 - cartItemQuantity;
    showToast('warning', `You can add only ${remaining} more.`);
    return; // <-- stop here
  }

  try {
    const response = await fetch('/cart/add', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ productId, quantity, variantSize: currentVariant.size })
    });

    const data = await response.json();

    if (response.status === 401) {
      loginRedirectAlert();
      return;
    }

    if (data.success) {
      cartItemQuantity = data.currentQuantity || (cartItemQuantity + quantity);
      updateQuantityButtonStates();
      showToast('success', `Added to cart! Total: ${cartItemQuantity}/5`);
    } else {
      showToast('warning', data.message || 'Cannot add more items');
    }
  } catch (error) {
    showToast('error', 'Failed to add to cart');
  }
});

function showToast(icon, title) {
  const Toast = Swal.mixin({
    toast: true,
    position: 'top-end',
    showConfirmButton: false,
    timer: 2500,
    timerProgressBar: true,
    background: document.body.classList.contains('dark-mode') ? '#1e1e1e' : '#fff',
    color: document.body.classList.contains('dark-mode') ? '#fff' : '#000'
  });
  Toast.fire({ icon, title });
}

function loginRedirectAlert() {
  Swal.fire({
    icon: 'warning',
    title: 'Login Required',
    text: 'Please login to add items to cart',
    confirmButtonColor: '#e74c3c',
    confirmButtonText: 'Go to Login'
  }).then(r => {
    if (r.isConfirmed) window.location.href = '/login';
  });
}


    // Wishlist
    document.getElementById('wishlistBtn').addEventListener('click', async function() {
      try {
        const response = await fetch('/wishlist/add', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ productId })
        });

        const data = await response.json();

        if (response.status === 401 || data.requiresLogin) {
          Swal.fire({
            icon: 'warning', title: 'Login Required', text: 'Please login to add items to wishlist',
            confirmButtonColor: '#e74c3c', confirmButtonText: 'Go to Login',
            background: document.body.classList.contains('dark-mode') ? '#1e1e1e' : '#fff',
            color: document.body.classList.contains('dark-mode') ? '#fff' : '#000'
          }).then((result) => {
            if (result.isConfirmed) window.location.href = '/login';
          });
          return;
        }
        
        if (data.success) {
          this.classList.add('added');
          this.querySelector('i').classList.remove('far');
          this.querySelector('i').classList.add('fas');
          const Toast = Swal.mixin({
            toast: true, position: 'top-end', showConfirmButton: false, timer: 2000, timerProgressBar: true,
            background: document.body.classList.contains('dark-mode') ? '#1e1e1e' : '#fff',
            color: document.body.classList.contains('dark-mode') ? '#fff' : '#000'
          });
          Toast.fire({ icon: 'success', title: 'Added to wishlist!' });
        } else {
          const Toast = Swal.mixin({
            toast: true, position: 'top-end', showConfirmButton: false, timer: 2000, timerProgressBar: true,
            background: document.body.classList.contains('dark-mode') ? '#1e1e1e' : '#fff',
            color: document.body.classList.contains('dark-mode') ? '#fff' : '#000'
          });
          Toast.fire({ icon: 'info', title: data.message || 'Already in wishlist' });
        }
      } catch (error) {
        console.error('Wishlist error:', error);
        const Toast = Swal.mixin({
          toast: true, position: 'top-end', showConfirmButton: false, timer: 3000, timerProgressBar: true,
          background: document.body.classList.contains('dark-mode') ? '#1e1e1e' : '#fff',
          color: document.body.classList.contains('dark-mode') ? '#fff' : '#000'
        });
        Toast.fire({ icon: 'error', title: 'Failed to add to wishlist' });
      }
    });

    // Tabs
    function switchTab(id, btn) {
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
      document.querySelectorAll('.tab-link').forEach(l => l.classList.remove('active'));
      document.getElementById(id).classList.add('active');
      btn.classList.add('active');
    }

    // Reviews
    document.getElementById('reviewForm')?.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const rating = document.querySelector('input[name="rating"]:checked')?.value;
      const comment = document.getElementById('reviewComment').value.trim();
      
      // Validation
      if (!rating) {
        const Toast = Swal.mixin({
          toast: true, position: 'top-end', showConfirmButton: false, timer: 3000, timerProgressBar: true,
          background: document.body.classList.contains('dark-mode') ? '#1e1e1e' : '#fff',
          color: document.body.classList.contains('dark-mode') ? '#fff' : '#000'
        });
        Toast.fire({ icon: 'warning', title: 'Please select a rating' });
        return;
      }

      if (!comment || comment.length < 5) {
        const Toast = Swal.mixin({
          toast: true, position: 'top-end', showConfirmButton: false, timer: 3000, timerProgressBar: true,
          background: document.body.classList.contains('dark-mode') ? '#1e1e1e' : '#fff',
          color: document.body.classList.contains('dark-mode') ? '#fff' : '#000'
        });
        Toast.fire({ icon: 'warning', title: 'Review must be at least 5 characters' });
        return;
      }

      if (comment.length > 500) {
        const Toast = Swal.mixin({
          toast: true, position: 'top-end', showConfirmButton: false, timer: 3000, timerProgressBar: true,
          background: document.body.classList.contains('dark-mode') ? '#1e1e1e' : '#fff',
          color: document.body.classList.contains('dark-mode') ? '#fff' : '#000'
        });
        Toast.fire({ icon: 'warning', title: 'Review cannot exceed 500 characters' });
        return;
      }

      try {
        const response = await fetch('/product/review', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ productId, rating: parseInt(rating), comment })
        });

        const data = await response.json();

        // Handle login required
        if (response.status === 401) {
          Swal.fire({
            icon: 'warning',
            title: 'Login Required',
            text: data.message || 'Please login to write a review',
            confirmButtonColor: '#e74c3c',
            confirmButtonText: 'Go to Login',
            background: document.body.classList.contains('dark-mode') ? '#1e1e1e' : '#fff',
            color: document.body.classList.contains('dark-mode') ? '#fff' : '#000'
          }).then((result) => {
            if (result.isConfirmed) window.location.href = '/login';
          });
          return;
        }

        if (data.success) {
          const Toast = Swal.mixin({
            toast: true, position: 'top-end', showConfirmButton: false, timer: 2000, timerProgressBar: true,
            background: document.body.classList.contains('dark-mode') ? '#1e1e1e' : '#fff',
            color: document.body.classList.contains('dark-mode') ? '#fff' : '#000'
          });
          Toast.fire({ icon: 'success', title: 'Review posted successfully!' });
          setTimeout(() => location.reload(), 2000);
        } else {
          const Toast = Swal.mixin({
            toast: true, position: 'top-end', showConfirmButton: false, timer: 3000, timerProgressBar: true,
            background: document.body.classList.contains('dark-mode') ? '#1e1e1e' : '#fff',
            color: document.body.classList.contains('dark-mode') ? '#fff' : '#000'
          });
          Toast.fire({ icon: 'error', title: data.message || 'Failed to post review' });
        }
      } catch (error) {
        console.error('Review error:', error);
        const Toast = Swal.mixin({
          toast: true, position: 'top-end', showConfirmButton: false, timer: 3000, timerProgressBar: true,
          background: document.body.classList.contains('dark-mode') ? '#1e1e1e' : '#fff',
          color: document.body.classList.contains('dark-mode') ? '#fff' : '#000'
        });
        Toast.fire({ icon: 'error', title: 'Network error. Please try again.' });
      }
    });

    window.addEventListener('DOMContentLoaded', () => {
      const btn = document.querySelector('.size-btn:not([disabled])');
      if(btn) selectVariant(btn);
    });
  </script>

  </body>
</html>