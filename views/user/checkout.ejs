
<%- include('../../views/partials/user/header') %>


<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Checkout</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
  <link rel='stylesheet' href='https://fonts.googleapis.com/css?family=Roboto:400,500,700&display=swap'>
 
  <script src='https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js'></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="/js/checkout.js" defer></script>
  <script src="https://checkout.razorpay.com/v1/checkout.js"></script>

<style>

:root {
 
  --bg-body: #ffffff;
  --bg-card: #ffffff;
  --bg-section: #f9fafb;
  --bg-input: #ffffff;
  --bg-hover: #f3f4f6;
  
  --text-primary: #1f2937;
  --text-secondary: #4b5563;
  --text-muted: #6b7280;
  --text-label: #22c55e;
  
  --border-color: #e5e5e5;
  --border-light: #d1d5db;
  
  --accent-color: #22c55e;
  --accent-hover: #16a34a;
  --accent-light: #f0fdf4;
  
  --error-color: #ef4444;
  --error-bg: #fee2e2;
  --error-light: #fecaca;
  
  --shadow-sm: 0 1px 3px rgba(0,0,0,0.1);
  --shadow-md: 0 4px 8px rgba(0,0,0,0.15);
  --shadow-lg: 0 10px 30px rgba(0,0,0,0.2);
  
  --scrollbar-track: #f3f4f6;
  --scrollbar-thumb: #d1d5db;
}

body.dark-mode {
  
  

  --bg-body: #0a0a0a;       
  --bg-card: #171717;       
  --bg-section: #121212;    
  --bg-input: #0f0f0f;     
  --bg-hover: #262626;      
  
  /* Text */
  --text-primary: #ededed;  
  --text-secondary: #a3a3a3;
  --text-muted: #737373;    
  
 
  --text-label: #22c55e;    
  --accent-color: #22c55e;  
  --accent-hover: #16a34a; 
  --accent-light: rgba(34, 197, 94, 0.15); 
  
  /* Borders */
  --border-color: #2e2e2e;
  --border-light: #404040;
  
  /* States */
  --error-color: #ff6b6b;
  --error-bg: rgba(255, 107, 107, 0.1);
  --error-light: rgba(255, 107, 107, 0.2);
  
  --shadow-sm: 0 2px 4px rgba(0,0,0,0.2);
  --shadow-md: 0 4px 20px rgba(0,0,0,0.4);
  --shadow-lg: 0 10px 40px rgba(0,0,0,0.6);
  
  --scrollbar-track: #0a0a0a;
  --scrollbar-thumb: #2e2e2e;
}



/* Force Buttons to be GOLD Gradient in Dark Mode */
body.dark-mode .place-order-btn,
body.dark-mode .apply-btn,
body.dark-mode .add-address-btn,
body.dark-mode .btn-submit,
body.dark-mode .use-btn,
body.dark-mode .action-button {
    background: linear-gradient(135deg, #d4af37 0%, #e2c055 100%);
    color: #000000 !important;
    font-weight: 700;
    box-shadow: 0 4px 15px rgba(226, 192, 85, 0.15);
    border: none;
}

body.dark-mode .place-order-btn:hover, 
body.dark-mode .apply-btn:hover,
body.dark-mode .action-button:hover {
    background: linear-gradient(135deg, #e2c055 0%, #d4af37 100%);
    transform: translateY(-1px);
}

/* Force "Home/Office" Icons to be GOLD */
body.dark-mode .type-icon {
    background: linear-gradient(135deg, #262626 0%, #171717 100%);
    border: 1px solid #e2c055;
    color: #e2c055 !important;
}

/* Force Security/Header Icons to be GOLD */
body.dark-mode .security-badge svg,
body.dark-mode .section-header svg {
    stroke: #e2c055 !important;
}



/* =========================================
   3. MAIN LAYOUT STYLES
   ========================================= */
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  background: var(--bg-body) !important;
  min-height: 100vh;
  color: var(--text-primary) !important;
  transition: background-color 0.3s ease, color 0.3s ease;
}

/* Breadcrumbs */
.breadcrumbs {
  max-width: 1400px;
  margin: 20px auto;
  padding: 0 32px;
  font-size: 14px;
  color: var(--text-muted);
}
.breadcrumbs a {
  color: var(--accent-color);
  text-decoration: none;
}
.breadcrumbs span {
  color: var(--text-primary);
}
.breadcrumbs a:hover {
  text-decoration: underline;
}

/* Checkout Container */
.checkout-container {
  max-width: 1400px;
  margin: 0 auto;
  padding: 40px 32px;
}
.checkout-grid {
  display: grid;
  grid-template-columns: 1.8fr 1fr;
  gap: 36px;
}

/* Section Cards */
.section-card {
  background: var(--bg-card);
  border-radius: 8px;
  overflow: hidden;
  box-shadow: var(--shadow-sm);
  border: 1px solid var(--border-color);
  margin-bottom: 20px;
  transition: box-shadow 0.3s ease;
}
.section-card:hover {
  box-shadow: var(--shadow-md);
}

.section-header {
  background: var(--bg-section);
  padding: 16px 24px;
  display: flex;
  align-items: center;
  gap: 12px;
  border-bottom: 1px solid var(--border-color);
}
.section-header h2 {
  color: var(--text-primary);
  font-size: 20px;
  font-weight: 600;
  letter-spacing: -0.025em;
}
.section-header svg {
  width: 24px;
  height: 24px;
  stroke: var(--accent-color);
}

.section-body {
  padding: 24px;
  max-height: 500px;
  overflow-y: auto;
}
.section-body::-webkit-scrollbar { width: 6px; }
.section-body::-webkit-scrollbar-track { background: var(--scrollbar-track); border-radius: 10px; }
.section-body::-webkit-scrollbar-thumb { background: var(--scrollbar-thumb); border-radius: 10px; }
.section-body.no-scroll { max-height: none; overflow-y: visible; }

/* Addresses Grid */
.addresses-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
  gap: 16px;
}
.address-option {
  background: var(--bg-card);
  border-radius: 8px;
  padding: 20px;
  box-shadow: var(--shadow-sm);
  transition: box-shadow 0.3s ease, border-color 0.3s ease;
  position: relative;
  border: 1px solid var(--border-color);
  cursor: pointer;
}
.address-option:hover {
  box-shadow: var(--shadow-md);
  border-color: var(--border-light);
}
.address-option.selected {
  border-color: var(--accent-color);
  box-shadow: 0 2px 6px var(--accent-light);
}
.address-option.default::before {
  content: 'DEFAULT';
  position: absolute;
  top: 12px;
  right: 48px;
  background: var(--accent-color);
  color: #ffffff;
  padding: 4px 12px;
  border-radius: 9999px;
  font-size: 10px;
  font-weight: 600;
  letter-spacing: 0.5px;
}

.address-header {
  display: flex;
  align-items: center;
  gap: 12px;
  margin-bottom: 16px;
}
.type-icon {
  width: 40px;
  height: 40px;
  background: var(--accent-color);
  border-radius: 8px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 20px;
  color: #ffffff;
  transition: background 0.3s ease;
}
.type-info h4 {
  font-size: 16px;
  font-weight: 600;
  color: var(--text-primary);
  margin-bottom: 4px;
}
.type-info p {
  font-size: 12px;
  color: var(--text-label);
  font-weight: 600;
}

.address-details {
  padding: 12px;
  background: var(--bg-section);
  border-radius: 6px;
  border-left: 4px solid var(--accent-color);
}
.detail-row {
  display: flex;
  align-items: flex-start;
  gap: 12px;
  margin-bottom: 12px;
  padding: 8px;
  border-radius: 6px;
  transition: background 0.3s ease;
  background: var(--bg-card);
}
.detail-row:hover { background: var(--bg-hover); }
.detail-row:last-child { margin-bottom: 0; }
.detail-icon {
  font-size: 18px;
  width: 22px;
  flex-shrink: 0;
  margin-top: 2px;
}
.detail-text { flex: 1; }
.detail-label {
  font-size: 11px;
  color: var(--text-label);
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.8px;
  margin-bottom: 4px;
}
.detail-value {
  font-size: 14px;
  color: var(--text-primary);
  font-weight: 500;
  line-height: 1.5;
}

/* Radio Indicator */
.radio-indicator {
  width: 20px;
  height: 20px;
  border-radius: 50%;
  border: 2px solid var(--border-light);
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.3s ease;
  position: absolute;
  top: 16px;
  right: 16px;
  background: var(--bg-card);
}
.address-option.selected .radio-indicator,
.payment-option.selected .radio-indicator {
  border-color: var(--accent-color);
  background: var(--accent-color);
}
.radio-indicator::after {
  content: '‚úì';
  color: #ffffff;
  font-size: 12px;
  font-weight: 700;
  opacity: 0;
  transform: scale(0);
  transition: all 0.3s ease;
}
.address-option.selected .radio-indicator::after,
.payment-option.selected .radio-indicator::after {
  opacity: 1;
  transform: scale(1);
}

/* Address Actions */
.address-actions {
  display: flex;
  justify-content: flex-end;
  gap: 8px;
  margin-top: 12px;
  padding-top: 12px;
  border-top: 1px solid var(--border-color);
}
.edit-btn, .delete-btn {
  padding: 6px 16px;
  border-radius: 6px;
  font-size: 12px;
  font-weight: 600;
  cursor: pointer;
  transition: background 0.3s ease;
  border: none;
}
.edit-btn { background: var(--text-muted); color: #ffffff; }
.edit-btn:hover { background: var(--text-secondary); }
.delete-btn { background: var(--error-color); color: #ffffff; }
.delete-btn:hover { background: #dc2626; }

.add-address-btn {
  width: 100%;
  padding: 12px 20px;
  border-radius: 6px;
  background: var(--accent-color);
  color: #ffffff;
  font-weight: 600;
  font-size: 14px;
  border: none;
  cursor: pointer;
  transition: background 0.3s ease;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  margin-top: 20px;
}
.add-address-btn:hover { background: var(--accent-hover); }

/* Payment Options */
.payment-option {
  padding: 16px;
  border-radius: 6px;
  border: 1px solid var(--border-color);
  background: var(--bg-section);
  cursor: pointer;
  transition: all 0.3s ease;
  margin-bottom: 12px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  position: relative;
}
.payment-option:hover {
  border-color: var(--border-light);
  box-shadow: var(--shadow-sm);
}
.payment-option.selected {
  background: var(--accent-light);
  border-color: var(--accent-color);
}
.payment-info {
  display: flex;
  align-items: center;
  gap: 12px;
}
.payment-icon { font-size: 24px; }
.payment-label {
  font-size: 15px;
  font-weight: 600;
  color: var(--text-primary);
}

.selected-payment-info {
  background: var(--accent-light);
  border: 1px solid var(--accent-color);
  border-radius: 6px;
  padding: 12px 16px;
  margin-top: 12px;
  display: flex;
  align-items: center;
  gap: 10px;
  font-weight: 600;
  color: #065f46;
}
body.dark-mode .selected-payment-info {
  color: var(--accent-color);
}

.selected-payment-info .payment-icon { font-size: 20px; }

.security-badge {
  background: var(--bg-section);
  border-radius: 6px;
  padding: 16px;
  box-shadow: var(--shadow-sm);
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  color: var(--text-secondary);
  font-weight: 600;
  font-size: 13px;
  border: 1px solid var(--border-color);
}
.security-badge svg {
  width: 20px;
  height: 20px;
  stroke: var(--accent-color);
}

/* Cart & Summary */
.summary-sticky {
  position: sticky;
  top: 20px;
}
.cart-items {
  max-height: 400px;
  overflow-y: auto;
  margin-bottom: 16px;
  padding-right: 6px;
}
.cart-items::-webkit-scrollbar { width: 6px; }
.cart-items::-webkit-scrollbar-track { background: var(--scrollbar-track); border-radius: 10px; }
.cart-items::-webkit-scrollbar-thumb { background: var(--scrollbar-thumb); border-radius: 10px; }

.cart-item {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 12px;
  border-radius: 6px;
  background: var(--bg-section);
  margin-bottom: 10px;
  transition: background 0.3s ease;
  border: 1px solid var(--border-color);
}
.cart-item:hover { background: var(--bg-hover); }
.cart-item.out-of-stock-item {
  opacity: 0.7;
  background: var(--error-bg);
  border-color: var(--error-color);
}

.item-image {
  width: 60px;
  height: 60px;
  border-radius: 6px;
  object-fit: cover;
}
.item-details { flex: 1; }
.item-name {
  font-weight: 600;
  color: var(--text-primary);
  margin-bottom: 4px;
  font-size: 14px;
}
.item-subtitle {
  font-size: 12px;
  color: var(--text-muted);
  font-weight: 500;
}
.item-price {
  font-weight: 600;
  color: var(--accent-color);
  font-size: 15px;
}
.out-of-stock {
  color: var(--error-color);
  font-weight: 600;
  font-size: 11px;
  margin-top: 4px;
  background: var(--error-bg);
  padding: 4px 10px;
  border-radius: 4px;
  display: inline-block;
}

/* Coupons */
.coupon-section { margin-bottom: 16px; }
.coupon-input-group {
  display: flex;
  gap: 8px;
  margin-bottom: 8px;
}
.coupon-input-wrapper {
  flex: 1;
  position: relative;
}
.coupon-input-wrapper svg {
  position: absolute;
  left: 12px;
  top: 50%;
  transform: translateY(-50%);
  width: 18px;
  height: 18px;
  stroke: #9ca3af;
}
.coupon-input {
  width: 100%;
  padding: 10px 12px 10px 36px;
  border-radius: 6px;
  border: 1px solid var(--border-light);
  font-size: 13px;
  transition: all 0.3s ease;
  background: var(--bg-input);
  color: var(--text-primary);
  font-weight: 500;
}
.coupon-input:focus {
  outline: none;
  border-color: var(--accent-color);
  box-shadow: 0 0 0 3px var(--accent-light);
}
.apply-btn {
  padding: 10px 18px;
  border-radius: 6px;
  background: var(--accent-color);
  color: #ffffff;
  font-weight: 600;
  font-size: 13px;
  border: none;
  cursor: pointer;
  transition: background 0.3s ease;
}
.apply-btn:hover { background: var(--accent-hover); }
.coupon-success {
  color: var(--accent-color);
  font-size: 12px;
  font-weight: 600;
  display: none;
  align-items: center;
  gap: 6px;
}
.coupon-success.show { display: flex; }

/* Pricing */
.price-breakup {
  border-top: 1px solid var(--border-color);
  padding-top: 16px;
}
.price-row {
  display: flex;
  justify-content: space-between;
  margin-bottom: 12px;
  color: var(--text-secondary);
  font-size: 14px;
  font-weight: 500;
}
.price-row span:last-child { font-weight: 600; }
.price-row.free { color: var(--accent-color); }
.price-row.discount { color: var(--accent-color); display: none; }
.price-row.discount.show { display: flex; }

.total-row {
  border-top: 1px solid var(--border-color);
  padding-top: 12px;
  display: flex;
  justify-content: space-between;
  font-size: 18px;
  font-weight: 700;
  color: var(--text-primary);
}
.total-amount { color: var(--accent-color); }

.place-order-btn {
  width: 100%;
  padding: 12px 20px;
  border-radius: 6px;
  background: var(--accent-color);
  color: #ffffff;
  font-weight: 600;
  font-size: 16px;
  border: none;
  cursor: pointer;
  transition: background 0.3s ease, transform 0.3s ease;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
}
.place-order-btn:hover { background: var(--accent-hover); }
.place-order-btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
  background: var(--border-light);
}
.place-order-btn:active { transform: scale(0.96); }
.terms-text {
  text-align: center;
  font-size: 11px;
  color: var(--text-muted);
  margin-top: 12px;
  font-weight: 500;
}

/* Modals */
.modal {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.5);
  z-index: 5000;
  align-items: center;
  justify-content: center;
}
.modal.show { display: flex; }
.modal-content {
  background: var(--bg-card);
  border-radius: 8px;
  width: 90%;
  max-width: 600px;
  max-height: 90vh;
  overflow-y: auto;
  padding: 24px;
  box-shadow: var(--shadow-lg);
  position: relative;
  z-index: 6000;
}
.modal-content::-webkit-scrollbar { width: 6px; }
.modal-content::-webkit-scrollbar-track { background: var(--scrollbar-track); border-radius: 10px; }
.modal-content::-webkit-scrollbar-thumb { background: var(--scrollbar-thumb); border-radius: 10px; }

.modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
  padding-bottom: 12px;
  border-bottom: 1px solid var(--border-color);
}
.modal-header h2 {
  font-size: 20px;
  font-weight: 700;
  color: var(--accent-color);
}
.close-btn {
  background: var(--bg-section);
  border: 1px solid var(--border-color);
  font-size: 24px;
  cursor: pointer;
  color: var(--text-muted);
  transition: background 0.3s ease;
  width: 36px;
  height: 36px;
  border-radius: 6px;
  display: flex;
  align-items: center;
  justify-content: center;
}
.close-btn:hover {
  background: var(--error-color);
  color: #ffffff;
  border-color: var(--error-color);
}

.form-group {
  margin-bottom: 16px;
  position: relative;
}
.form-row {
  display: flex;
  gap: 16px;
}
.form-row .form-group { flex: 1; }
.form-label {
  font-size: 12px;
  font-weight: 600;
  color: var(--text-label);
  margin-bottom: 6px;
  display: block;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}
.form-input, .form-select, .form-textarea {
  width: 100%;
  padding: 10px;
  border-radius: 6px;
  border: 1px solid var(--border-light);
  font-size: 13px;
  transition: all 0.3s ease;
  background: var(--bg-input);
  color: var(--text-primary);
  font-weight: 500;
}
.form-input:focus, .form-select:focus, .form-textarea:focus {
  outline: none;
  border-color: var(--accent-color);
  box-shadow: 0 0 0 3px var(--accent-light);
}
.form-input.error-field, .form-select.error-field, .form-textarea.error-field {
  border-color: var(--error-color) !important;
  background-color: var(--error-bg) !important;
}
.form-textarea { resize: vertical; min-height: 80px; }

.checkbox-group {
  display: flex;
  align-items: center;
  gap: 8px;
}
.checkbox-group input[type="checkbox"] {
  width: 18px;
  height: 18px;
  cursor: pointer;
  accent-color: var(--accent-color);
}
.checkbox-group label {
  font-size: 13px;
  color: var(--text-primary);
  font-weight: 500;
  cursor: pointer;
}

.modal-actions {
  display: flex;
  justify-content: flex-end;
  gap: 12px;
  margin-top: 20px;
  padding-top: 12px;
  border-top: 1px solid var(--border-color);
}
.modal-btn {
  padding: 10px 24px;
  border-radius: 6px;
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  transition: background 0.3s ease;
  border: none;
  min-width: 120px;
  text-align: center;
}
.btn-cancel {
  background: var(--bg-hover);
  color: var(--text-primary);
}
.btn-cancel:hover { background: var(--border-light); }
.btn-submit {
  background: var(--accent-color);
  color: #ffffff;
}
.btn-submit:hover:not(:disabled) { background: var(--accent-hover); }
.btn-submit:disabled { opacity: 0.5; cursor: not-allowed; }

.error-message {
  color: var(--error-color);
  font-size: 11px;
  margin-top: 4px;
  display: none;
  font-weight: 500;
}
.error-message.show { display: block; }

.empty-state {
  text-align: center;
  padding: 40px 20px;
  color: var(--text-muted);
}
.empty-state h3 {
  font-size: 20px;
  font-weight: 600;
  color: var(--text-primary);
  margin-bottom: 8px;
}
.empty-icon { font-size: 60px; margin-bottom: 16px; }
.empty-state p { font-size: 14px; }

/* TRUCK ANIMATION (Swal2) */
.swal2-order-animation {
  -webkit-appearance: none;
  -moz-appearance: none;
  appearance: none;
  border: 0;
  background: #010101;
  position: relative;
  height: 63px;
  width: 100%;
  max-width: 250px;
  margin: 20px auto;
  padding: 0;
  outline: none;
  border-radius: 85px;
  -webkit-mask-image: -webkit-radial-gradient(white, black);
  -webkit-tap-highlight-color: transparent;
  overflow: hidden;
  transition: transform 0.3s ease;
  font-family: Roboto, Arial;
}
.swal2-order-animation span {
  --o: 1;
  position: absolute;
  left: 0;
  right: 0;
  text-align: center;
  top: 19px;
  line-height: 24px;
  color: #ffffff;
  font-size: 16px;
  font-weight: 500;
  opacity: var(--o);
  transition: opacity 0.3s ease;
}
.swal2-order-animation span.default { transition-delay: 0.3s; }
.swal2-order-animation span.success { --offset: 16px; --o: 0; }
.swal2-order-animation span.success svg {
  width: 12px;
  height: 10px;
  display: inline-block;
  vertical-align: top;
  fill: none;
  margin: 7px 0 0 4px;
  stroke: #ffffff;
  stroke-width: 2;
  stroke-linecap: round;
  stroke-linejoin: round;
  stroke-dasharray: 16px;
  stroke-dashoffset: var(--offset);
  transition: stroke-dashoffset 0.3s ease;
}
.swal2-order-animation:active { transform: scale(0.96); }
.swal2-order-animation .lines {
  opacity: 0;
  position: absolute;
  height: 3px;
  background: #ffffff;
  border-radius: 2px;
  width: 6px;
  top: 30px;
  left: 100%;
  box-shadow: 15px 0 0 #ffffff, 30px 0 0 #ffffff, 45px 0 0 #ffffff, 60px 0 0 #ffffff, 75px 0 0 #ffffff, 90px 0 0 #ffffff, 105px 0 0 #ffffff, 120px 0 0 #ffffff, 135px 0 0 #ffffff, 150px 0 0 #ffffff, 165px 0 0 #ffffff, 180px 0 0 #ffffff, 195px 0 0 #ffffff, 210px 0 0 #ffffff, 225px 0 0 #ffffff, 240px 0 0 #ffffff, 255px 0 0 #ffffff, 270px 0 0 #ffffff, 285px 0 0 #ffffff, 300px 0 0 #ffffff, 315px 0 0 #ffffff, 330px 0 0 #ffffff;
}
.swal2-order-animation .back,
.swal2-order-animation .box {
  --start: #ffffff;
  --stop: #CDD9ED;
  border-radius: 2px;
  background: linear-gradient(var(--start), var(--stop));
  position: absolute;
}
.swal2-order-animation .truck {
  width: 60px;
  height: 41px;
  left: 100%;
  z-index: 1;
  top: 11px;
  position: absolute;
  transform: translateX(24px);
}
.swal2-order-animation .truck:before, .swal2-order-animation .truck:after {
  --r: -90deg;
  content: "";
  height: 2px;
  width: 20px;
  right: 58px;
  position: absolute;
  display: block;
  background: #ffffff;
  border-radius: 1px;
  transform-origin: 100% 50%;
  transform: rotate(var(--r));
}
.swal2-order-animation .truck:before { top: 4px; }
.swal2-order-animation .truck:after { --r: 90deg; bottom: 4px; }
.swal2-order-animation .truck .back {
  left: 0;
  top: 0;
  width: 60px;
  height: 41px;
  z-index: 1;
}
.swal2-order-animation .truck .front {
  overflow: hidden;
  position: absolute;
  border-radius: 2px 9px 9px 2px;
  width: 26px;
  height: 41px;
  left: 60px;
}
.swal2-order-animation .truck .front:before, .swal2-order-animation .truck .front:after {
  content: "";
  position: absolute;
  display: block;
}
.swal2-order-animation .truck .front:before {
  height: 13px;
  width: 2px;
  left: 0;
  top: 14px;
  background: linear-gradient(#6C7486, #3F4656);
}
.swal2-order-animation .truck .front:after {
  border-radius: 2px 9px 9px 2px;
  background: #e20707;
  width: 24px;
  height: 41px;
  right: 0;
}
.swal2-order-animation .truck .front .window {
  overflow: hidden;
  border-radius: 10px;
  background: #0c0c0c;
  transform: perspective(4px) rotateY(3deg);
  width: 22px;
  height: 41px;
  position: absolute;
  left: 2px;
  top: 0;
  z-index: 1;
  transform-origin: 0 50%;
}
.swal2-order-animation .truck .front .window:before, .swal2-order-animation .truck .front .window:after {
  content: "";
  position: absolute;
  right: 0;
}
.swal2-order-animation .truck .front .window:before {
  top: 0;
  bottom: 0;
  width: 14px;
  background: #1C212E;
}
.swal2-order-animation .truck .front .window:after {
  width: 14px;
  top: 7px;
  height: 4px;
  position: absolute;
  background: rgba(255, 255, 255, 0.14);
  transform: skewY(14deg);
  box-shadow: 0 7px 0 rgba(255, 255, 255, 0.14);
}
.swal2-order-animation .truck .light {
  width: 3px;
  height: 8px;
  left: 83px;
  transform-origin: 100% 50%;
  position: absolute;
  border-radius: 2px;
  transform: scaleX(0.8);
  background: #f0dc5f;
}
.swal2-order-animation .truck .light:before {
  content: "";
  height: 4px;
  width: 7px;
  opacity: 0;
  transform: perspective(2px) rotateY(-15deg) scaleX(0.94);
  position: absolute;
  transform-origin: 0 50%;
  left: 3px;
  top: 50%;
  margin-top: -2px;
  background: linear-gradient(90deg, #f0dc5f, rgba(240, 220, 95, 0.7), rgba(240, 220, 95, 0));
}
.swal2-order-animation .truck .light.top { top: 4px; }
.swal2-order-animation .truck .light.bottom { bottom: 4px; }
.swal2-order-animation .box {
  --start: #EDD9A9;
  --stop: #DCB773;
  width: 21px;
  height: 21px;
  right: 100%;
  top: 21px;
}
.swal2-order-animation .box:before, .swal2-order-animation .box:after {
  content: "";
  top: 10px;
  position: absolute;
  left: 0;
  right: 0;
}
.swal2-order-animation .box:before {
  height: 3px;
  margin-top: -1px;
  background: rgba(0, 0, 0, 0.1);
}
.swal2-order-animation .box:after {
  height: 1px;
  background: rgba(0, 0, 0, 0.15);
}
.swal2-order-animation.animate .default {
  --o: 0;
  transition-delay: 0s;
}
.swal2-order-animation.animate .success {
  --offset: 0;
  --o: 1;
  transition-delay: 7s;
}
.swal2-order-animation.animate .success svg {
  transition-delay: 7.3s;
}
.swal2-order-animation.animate .truck {
  animation: truck 10s ease forwards;
}
.swal2-order-animation.animate .truck:before {
  animation: door1 2.4s ease forwards 0.3s;
}
.swal2-order-animation.animate .truck:after {
  animation: door2 2.4s ease forwards 0.6s;
}
.swal2-order-animation.animate .truck .light:before, .swal2-order-animation.animate .truck .light:after {
  animation: light 10s ease forwards;
}
.swal2-order-animation.animate .box {
  animation: box 10s ease forwards;
}
.swal2-order-animation.animate .lines {
  animation: lines 10s ease forwards;
}

/* Animations */
@keyframes truck {
  10%, 30% { transform: translateX(-164px); }
  40% { transform: translateX(-104px); }
  60% { transform: translateX(-224px); }
  75%, 100% { transform: translateX(24px); }
}
@keyframes lines {
  0%, 30% { opacity: 0; transform: scaleY(0.7) translateX(0); }
  35%, 65% { opacity: 1; }
  70% { opacity: 0; }
  100% { transform: scaleY(0.7) translateX(-400px); }
}
@keyframes light {
  0%, 30% { opacity: 0; transform: perspective(2px) rotateY(-15deg) scaleX(0.88); }
  40%, 100% { opacity: 1; transform: perspective(2px) rotateY(-15deg) scaleX(0.94); }
}
@keyframes door1 {
  30%, 50% { transform: rotate(32deg); }
}
@keyframes door2 {
  30%, 50% { transform: rotate(-32deg); }
}
@keyframes box {
  8%, 10% { transform: translateX(40px); opacity: 1; }
  25% { transform: translateX(112px); opacity: 1; }
  26% { transform: translateX(112px); opacity: 0; }
  27%, 100% { transform: translateX(0px); opacity: 0; }
}

/* BLOCKED ALERT */
.blocked-alert-container {
  margin-bottom: 24px;
  animation: slideDown 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
}
@keyframes slideDown {
  from { opacity: 0; transform: translateY(-20px); }
  to { opacity: 1; transform: translateY(0); }
}

.blocked-alert-card {
  background: linear-gradient(135deg, #fff5f5 0%, #ffe5e5 100%);
  border: 2px solid #ef4444;
  border-radius: 14px;
  padding: 24px;
  box-shadow: 0 10px 30px rgba(239, 68, 68, 0.15);
  overflow: hidden;
  position: relative;
}
/* Alert Dark Mode Override */
body.dark-mode .blocked-alert-card {
    background: linear-gradient(135deg, #2b1111 0%, #3f1212 100%);
    border-color: #7f1d1d;
}

.blocked-alert-card::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 4px;
  background: linear-gradient(90deg, #ef4444, #f87171);
}

.blocked-alert-header {
  display: flex;
  gap: 16px;
  margin-bottom: 20px;
  align-items: flex-start;
}

.alert-icon-wrapper {
  flex-shrink: 0;
  width: 48px;
  height: 48px;
  background: linear-gradient(135deg, #fee2e2, #fecaca);
  border-radius: 12px;
  display: flex;
  align-items: center;
  justify-content: center;
  border: 2px solid #fecaca;
}
body.dark-mode .alert-icon-wrapper { background: #450a0a; border-color: #7f1d1d; }

.alert-icon {
  width: 24px;
  height: 24px;
  color: #dc2626;
  stroke-linecap: round;
  stroke-linejoin: round;
}

.alert-text { flex: 1; }
.alert-title {
  margin: 0 0 4px 0;
  color: #991b1b;
  font-size: 18px;
  font-weight: 700;
  letter-spacing: -0.5px;
}
body.dark-mode .alert-title { color: #fecaca; }

.alert-subtitle {
  margin: 0;
  color: #7f1d1d;
  font-size: 13px;
  font-weight: 500;
  opacity: 0.9;
}
body.dark-mode .alert-subtitle { color: #f87171; }

.blocked-items-container {
  background: var(--bg-card);
  border-radius: 10px;
  padding: 16px;
  margin-bottom: 16px;
  border: 1px solid #fecaca;
}
body.dark-mode .blocked-items-container { background: #1a1a1a; border-color: #450a0a; }

.blocked-items-header { margin-bottom: 12px; }
.items-label {
  font-size: 12px;
  font-weight: 600;
  color: #7f1d1d;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}
body.dark-mode .items-label { color: #f87171; }

.blocked-items-list {
  list-style: none;
  margin: 0;
  padding: 0;
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.blocked-item {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 12px;
  background: #fef2f2;
  border-radius: 8px;
  border-left: 3px solid #ef4444;
  transition: all 0.2s ease;
}
body.dark-mode .blocked-item { background: #2c0b0e; }

.blocked-item:hover {
  background: #fee2e2;
  transform: translateX(4px);
}
body.dark-mode .blocked-item:hover { background: #450a0a; }

.item-indicator {
  display: flex;
  align-items: center;
  justify-content: center;
  min-width: 28px;
  width: 28px;
  height: 28px;
  background: linear-gradient(135deg, #ef4444, #f87171);
  color: white;
  border-radius: 50%;
  font-size: 12px;
  font-weight: 700;
  flex-shrink: 0;
}
.item-content {
  flex: 1;
  display: flex;
  flex-direction: column;
  gap: 4px;
}
.item-reason {
  font-size: 12px;
  color: #7f1d1d;
  background: #fecaca;
  padding: 2px 8px;
  border-radius: 4px;
  width: fit-content;
}
.item-icon {
  width: 20px;
  height: 20px;
  color: #10b981;
  flex-shrink: 0;
  opacity: 0;
  animation: checkSlideIn 0.5s ease forwards;
}
@keyframes checkSlideIn {
  from { opacity: 0; transform: scale(0); }
  to { opacity: 1; transform: scale(1); }
}

.blocked-alert-actions {
  background: linear-gradient(135deg, #fef2f2, #fee2e2);
  border-radius: 10px;
  padding: 16px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: 16px;
  border: 1px solid #fecaca;
}
body.dark-mode .blocked-alert-actions { background: #2c0b0e; border-color: #450a0a; }

.action-message {
  display: flex;
  align-items: center;
  gap: 10px;
  flex: 1;
}
.info-icon {
  width: 18px;
  height: 18px;
  color: #dc2626;
  flex-shrink: 0;
  stroke-linecap: round;
  stroke-linejoin: round;
}
.action-message span {
  font-size: 13px;
  color: #7f1d1d;
  font-weight: 500;
}
body.dark-mode .action-message span { color: #f87171; }

.action-button {
  display: inline-flex;
  align-items: center;
  gap: 8px;
  background: linear-gradient(135deg, #ef4444, #f87171);
  color: white;
  padding: 12px 20px;
  border: none;
  border-radius: 8px;
  font-weight: 600;
  font-size: 13px;
  text-decoration: none;
  cursor: pointer;
  transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
  white-space: nowrap;
  flex-shrink: 0;
}
.action-button:hover {
  background: linear-gradient(135deg, #dc2626, #ef4444);
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(239, 68, 68, 0.4);
}
.action-button:active { transform: translateY(0); }
.btn-icon {
  width: 16px;
  height: 16px;
  stroke-linecap: round;
  stroke-linejoin: round;
}

/* Coupon Modal Styling (New) */
.coupon-modal {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.5);
  z-index: 1000;
  align-items: center;
  justify-content: center;
  padding: 20px;
  animation: fadeIn 0.3s ease;
}
.coupon-modal.show { display: flex; }
@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

.coupon-modal-content-wrapper {
  background: var(--bg-card);
  border-radius: 12px;
  box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
  max-width: 600px;
  width: 100%;
  max-height: 80vh;
  display: flex;
  flex-direction: column;
  animation: slideUp 0.3s ease;
}
@keyframes slideUp {
  from { transform: translateY(30px); opacity: 0; }
  to { transform: translateY(0); opacity: 1; }
}

.coupon-modal-header-section {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 20px;
  border-bottom: 1px solid var(--border-color);
}
.coupon-modal-header-section h2 {
  margin: 0;
  font-size: 20px;
  font-weight: 600;
  color: var(--text-primary);
}

.coupon-modal-close {
  background: none;
  border: none;
  font-size: 24px;
  cursor: pointer;
  color: var(--text-muted);
  transition: color 0.2s;
}
.coupon-modal-close:hover { color: var(--text-primary); }

.coupon-modal-loading {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 60px 20px;
  gap: 16px;
}
.spinner {
  width: 40px;
  height: 40px;
  border: 3px solid var(--border-light);
  border-top-color: var(--accent-color);
  border-radius: 50%;
  animation: spin 1s linear infinite;
}
@keyframes spin {
  to { transform: rotate(360deg); }
}

.coupon-list {
  overflow-y: auto;
  padding: 20px;
  flex: 1;
}

.coupon-modal-card {
  display: flex;
  gap: 12px;
  padding: 16px;
  border: 1px solid var(--border-color);
  border-radius: 8px;
  margin-bottom: 12px;
  transition: all 0.3s ease;
  background: var(--bg-section);
}
.coupon-modal-card:hover {
  border-color: var(--accent-color);
  box-shadow: var(--shadow-sm);
}

.coupon-modal-content { flex: 1; }
.coupon-modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 8px;
}
.coupon-modal-title {
  margin: 0;
  font-size: 16px;
  font-weight: 600;
  color: var(--text-primary);
}

.coupon-status {
  padding: 4px 12px;
  border-radius: 20px;
  font-size: 11px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}
.coupon-status.active { background: #dcfce7; color: #166534; }
.coupon-status.upcoming { background: #fef3c7; color: #92400e; }
.coupon-status.expired { background: #fee2e2; color: #991b1b; }

.coupon-modal-description {
  margin: 0 0 12px 0;
  font-size: 13px;
  color: var(--text-secondary);
  line-height: 1.4;
}

.coupon-modal-details {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 12px;
  margin-bottom: 12px;
}
.detail-item {
  display: flex;
  flex-direction: column;
  gap: 4px;
}
.detail-label {
  font-size: 12px;
  color: var(--text-muted);
  font-weight: 500;
}
.detail-value {
  font-size: 13px;
  font-weight: 600;
  color: var(--text-primary);
}

.coupon-usage-bar {
  height: 6px;
  background: var(--bg-hover);
  border-radius: 3px;
  overflow: hidden;
}
.usage-bar-fill {
  height: 100%;
  background: linear-gradient(90deg, var(--accent-color), var(--accent-hover));
  transition: width 0.3s ease;
}

.coupon-modal-actions {
  display: flex;
  gap: 8px;
}
.copy-btn, .use-btn {
  padding: 8px 14px;
  border: none;
  border-radius: 6px;
  font-size: 12px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
  white-space: nowrap;
}
.copy-btn {
  background: var(--bg-hover);
  color: var(--text-secondary);
}
.copy-btn:hover { background: var(--border-light); }
.use-btn {
  background: var(--accent-color);
  color: white;
  flex: 1;
}
.use-btn:hover:not(:disabled) { background: var(--accent-hover); }
.use-btn:disabled {
  background: var(--border-light);
  cursor: not-allowed;
  opacity: 0.6;
}

.coupon-modal-pagination {
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 12px;
  padding: 16px 20px;
  border-top: 1px solid var(--border-color);
}
.pagination-btn {
  padding: 8px 14px;
  background: var(--bg-hover);
  color: var(--text-primary);
  border: none;
  border-radius: 6px;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.3s ease;
}
.pagination-btn:hover:not(:disabled) {
  background: var(--accent-color);
  color: white;
}
.pagination-btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}
.page-info {
  font-size: 14px;
  font-weight: 500;
  color: var(--text-muted);
  min-width: 120px;
  text-align: center;
}

.coupon-view-link {
  font-size: 14px;
  color: var(--text-secondary);
}
.coupon-view-link a {
  color: var(--accent-color);
  text-decoration: none;
}
.coupon-view-link a:hover {
  text-decoration: underline;
}

/* Mobile Responsive */
@media (max-width: 768px) {
  .blocked-alert-card { padding: 16px; }
  .blocked-alert-header { gap: 12px; }
  .alert-icon-wrapper { width: 40px; height: 40px; }
  .alert-icon { width: 20px; height: 20px; }
  .alert-title { font-size: 16px; }
  .blocked-items-list { gap: 8px; }
  .blocked-item { padding: 10px; }
  .blocked-alert-actions { flex-direction: column; align-items: stretch; }
  .action-button { width: 100%; justify-content: center; }
  .checkout-grid { grid-template-columns: 1fr; }
  .summary-sticky { position: static; }
}

@media (max-width: 640px) {
  .checkout-container { padding: 20px 16px; }
  .section-body { padding: 16px; }
  .addresses-grid { grid-template-columns: 1fr; }
  .form-row { flex-direction: column; }
  .modal-content { padding: 20px; }
  .modal-btn { min-width: 100%; }
  .swal2-order-animation { max-width: 100%; }
  .coupon-modal { padding: 10px; }
  .coupon-modal-content-wrapper { max-height: 90vh; }
  .coupon-modal-card { flex-direction: column; }
  .coupon-modal-actions { width: 100%; }
  .copy-btn, .use-btn { flex: 1; }
  .coupon-modal-details { grid-template-columns: 1fr; }
  .blocked-alert-card { padding: 12px; }
  .alert-title { font-size: 14px; }
  .alert-subtitle { font-size: 12px; }
  .item-name { font-size: 12px; }
  .item-reason { font-size: 11px; }
}


.swal2-container {
  z-index: 9999 !important;
}
.swal2-popup {
  z-index: 10000 !important;
}

</style>


</head>


<body>
  <div class="breadcrumbs">
    <a href="/">Home</a> &gt; <a href="/cart">Cart</a> &gt; <span>Checkout</span>
  </div>

  <div class="checkout-container">
    <div class="checkout-grid">
      <div class="left-column">
        <div class="section-card">
          <div class="section-header">
            <svg viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <rect x="1" y="3" width="15" height="13"></rect>
              <polygon points="16 8 20 8 23 11 23 16 16 16 16 8"></polygon>
              <circle cx="5.5" cy="18.5" r="2.5"></circle>
              <circle cx="18.5" cy="18.5" r="2.5"></circle>
            </svg>
            <h2>Delivery Address</h2>
          </div>
          <div class="section-body">
            <div class="addresses-grid">
              <% if (addresses && addresses.length > 0) { %>
                <% addresses.forEach((addr) => { %>
                  <div class="address-option <%= addr.isDefault ? 'selected default' : '' %>" data-address="<%= addr._id %>">
                    <div class="address-header">
                      <div class="type-icon"><%= addr.addressType === 'Home' ? 'üè†' : addr.addressType === 'Work' ? 'üè¢' : 'üì¶' %></div>
                      <div class="type-info">
                        <h4><%= addr.name || 'Unknown' %></h4>
                        <p><%= addr.addressType || 'Other' %></p>
                      </div>
                    </div>
                    <div class="address-details">
                      <div class="detail-row">
                        <div class="detail-icon">üì±</div>
                        <div class="detail-text">
                          <div class="detail-label">Phone</div>
                          <div class="detail-value"><%= addr.phone || 'N/A' %></div>
                        </div>
                      </div>
                      <div class="detail-row">
                        <div class="detail-icon">üè†</div>
                        <div class="detail-text">
                          <div class="detail-label">Address</div>
                          <div class="detail-value"><%= addr.houseName || '' %><%= addr.buildingNumber ? ', ' + addr.buildingNumber : '' %></div>
                        </div>
                      </div>
                      <div class="detail-row">
                        <div class="detail-icon">üèòÔ∏è</div>
                        <div class="detail-text">
                          <div class="detail-label">Landmark</div>
                          <div class="detail-value"><%= addr.landmark || 'N/A' %></div>
                        </div>
                      </div>
                      <% if (addr.altPhone) { %>
                        <div class="detail-row">
                          <div class="detail-icon">‚òéÔ∏è</div>
                          <div class="detail-text">
                            <div class="detail-label">Alt. Phone</div>
                            <div class="detail-value"><%= addr.altPhone %></div>
                          </div>
                        </div>
                      <% } %>
                      <div class="detail-row">
                        <div class="detail-icon">üìç</div>
                        <div class="detail-text">
                          <div class="detail-label">Location</div>
                          <div class="detail-value"><%= addr.city || 'N/A' %>, <%= addr.state || 'N/A' %> - <%= addr.pincode || 'N/A' %></div>
                        </div>
                      </div>
                      <div class="detail-row">
                        <div class="detail-icon">üåç</div>
                        <div class="detail-text">
                          <div class="detail-label">Nationality</div>
                          <div class="detail-value"><%= addr.nationality || 'N/A' %></div>
                        </div>
                      </div>
                    </div>
                    <div class="address-actions">
                      <button class="edit-btn" onclick="editAddress('<%= addr._id %>')">Edit</button>
                      <button class="delete-btn" onclick="deleteAddress('<%= addr._id %>')">Delete</button>
                    </div>
                    <div class="radio-indicator"></div>
                  </div>
                <% }) %>
              <% } else { %>
                <div class="empty-state">
                  <div class="empty-icon">üì≠</div>
                  <h3>No Addresses Found</h3>
                  <p>Add a new address to continue with checkout</p>
                </div>
              <% } %>
            </div>
            <button class="add-address-btn" onclick="openModal()">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
                <line x1="12" y1="5" x2="12" y2="19"></line>
                <line x1="5" y1="12" x2="19" y2="12"></line>
              </svg>
              Add New Address
            </button>
          </div>
        </div>

        <div class="section-card">
  <div class="section-header">
    <svg viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect>
      <line x1="1" y1="10" x2="23" y2="10"></line>
    </svg>
    <h2>Payment Method</h2>
  </div>
  <div class="section-body">
  
   

    <!-- Online Payment Option (Razorpay) -->
    <div class="payment-option" data-payment="razorpay">
      <div class="payment-info">
        <span class="payment-icon">üåê</span>
        <div class="payment-text">
          <span class="payment-label">Online Payment</span>
          <span class="payment-sublabel">UPI, Netbanking, Wallets</span>
        </div>
      </div>
      <div class="radio-indicator"></div>
    </div>

    <!-- Wallet Payment Option -->
    <div class="payment-option" data-payment="wallet">
      <div class="payment-info">
        <span class="payment-icon">üí∞</span>
        <div class="payment-text">
          <span class="payment-label">Wallet</span>
          <span class="payment-sublabel">Pay from your wallet balance</span>
        </div>
      </div>
      <div class="radio-indicator"></div>
    </div>

    <!-- Cash on Delivery Option -->
    <div class="payment-option" data-payment="cod">
      <div class="payment-info">
        <span class="payment-icon">üíµ</span>
        <div class="payment-text">
          <span class="payment-label">Cash on Delivery</span>
          <span class="payment-sublabel">Pay when you receive your order</span>
        </div>
      </div>
      <div class="radio-indicator"></div>
    </div>

    <div class="selected-payment-info" id="selectedPaymentInfo" style="display: none;">
      <span class="payment-icon" id="selectedPaymentIcon">üí≥</span>
      <span id="selectedPaymentText">Selected: Debit/Credit Card</span>
    </div>
  </div>
</div>

<!-- Razorpay Specific Info Box (shown when Razorpay selected) -->
<div id="razorpayInfo" class="payment-info-box" style="display: none; margin-top: 16px; padding: 12px; background: #f0f9ff; border-left: 4px solid #0ea5e9; border-radius: 4px;">
  <p style="margin: 0; color: #0c4a6e; font-size: 14px;">
    ‚úì Secure payment via Razorpay<br>
    ‚úì Multiple payment methods available<br>
    ‚úì Fast and encrypted transactions
  </p>
</div>

        <div class="security-badge">
          <svg viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>
          </svg>
          <span>üîí Secure checkout with 256-bit SSL encryption</span>
        </div>
      </div>

      <div class="right-column">
        <% if (blockedProducts && blockedProducts.length > 0) { %>
<div class="blocked-alert-container">
  <div class="blocked-alert-card">
    <!-- Header with icon and title -->
    <div class="blocked-alert-header">
      <div class="alert-icon-wrapper">
        <svg class="alert-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
          <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"></path>
        </svg>
      </div>
      <div class="alert-text">
        <h3 class="alert-title">Order Cannot Be Placed</h3>
        <p class="alert-subtitle">
          <%= blockedProducts.length %> <%= blockedProducts.length === 1 ? 'item' : 'items' %> 
          unavailable for checkout
        </p>
      </div>
    </div>

    <!-- Blocked items list -->
    <div class="blocked-items-container">
      <div class="blocked-items-header">
        <span class="items-label">Blocked Products:</span>
      </div>
      <ul class="blocked-items-list">
        <% blockedProducts.forEach((product, index) => { %>
          <li class="blocked-item">
            <div class="item-indicator"><%= index + 1 %></div>
            <div class="item-content">
              <span class="item-name"><%= product.name %></span>
              <span class="item-reason"><%= product.reason %></span>
            </div>
            <svg class="item-icon" viewBox="0 0 24 24" fill="currentColor">
              <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"></path>
            </svg>
          </li>
        <% }); %>
      </ul>
    </div>

    <!-- Action section -->
    <div class="blocked-alert-actions">
      <div class="action-message">
        <svg class="info-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="10"></circle>
          <line x1="12" y1="16" x2="12" y2="12"></line>
          <line x1="12" y1="8" x2="12.01" y2="8"></line>
        </svg>
        <span>Remove blocked items from your cart to proceed</span>
      </div>
      <a href="/cart" class="action-button">
        <svg class="btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M19 12H5M12 19l-7-7 7-7"></path>
        </svg>
        Return to Cart
      </a>
    </div>
  </div>
</div>
<% } %>
        <div class="summary-sticky">
          <div class="section-card">
            <div class="section-header">
              <h2>üõí Order Summary</h2>
            </div>
            <div class="section-body no-scroll">
              <div class="cart-items">
                <% if (cartItems && cartItems.length > 0) { %>
                  <% cartItems.forEach(function(item) { 
                    const itemStock = item.variant?.stock ?? item.productId?.stock ?? 0;
                    const isOutOfStock = itemStock <= 0;
                    const productName = item.productId?.productName || 'Unknown Product';
                    const productImage = item.productId && item.productId.images && item.productId.images.length > 0 
                      ? item.productId.images[0].startsWith('http') 
                        ? item.productId.images[0] 
                        : `/Uploads/product-images/${item.productId.images[0]}` 
                      : 'https://via.placeholder.com/70x70?text=No+Image';
                    const variantSize = item.variant?.size || '';
                    const itemPrice = (item.variant?.salePrice || item.variant?.price || item.price || 0) * item.quantity;
                  %>
                    <div class="cart-item <%= isOutOfStock ? 'out-of-stock-item' : '' %>">
                      <img class="item-image"
                           src="<%= productImage %>"
                           alt="<%= productName %>"
                           onerror="this.src='https://via.placeholder.com/70x70?text=No+Image'"
                           loading="lazy">
                      <div class="item-details">
                        <div class="item-name"><%= productName %></div>
                        <% if (variantSize && variantSize !== 'N/A') { %>
                          <div class="item-subtitle">Size: <%= variantSize %> ml ‚Ä¢ Qty: <%= item.quantity %></div>
                        <% } else { %>
                          <div class="item-subtitle">Qty: <%= item.quantity %></div>
                        <% } %>
                        <% if (isOutOfStock) { %>
                          <div class="out-of-stock">‚ö†Ô∏è OUT OF STOCK</div>
                        <% } %>
                      </div>
                      <div class="item-price">‚Çπ<%= Math.round(itemPrice).toLocaleString() %></div>
                    </div>
                  <% }) %>
                <% } else { %>
                  <div class="empty-state">
                    <div class="empty-icon">üõí</div>
                    <h3>No Items in Cart</h3>
                    <p>Your cart is empty. Add some products to continue.</p>
                  </div>
                <% } %>
              </div>

             <div class="coupon-section">
  <div class="coupon-input-group">
    <div class="coupon-input-wrapper">
      <svg viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
       
        <line x1="7" y1="7" x2="7.01" y2="7"></line>
      </svg>
      <input type="text" class="coupon-input" id="couponInput" placeholder="Enter coupon code">
      <div id="removeCouponContainer"></div>
    </div>

    <button class="apply-btn" id="applyBtn">Apply</button>
    
  </div>

  <!--  Coupon View Link Section (moved below apply section) -->
  <div class="coupon-view-link">
    <p>Have coupons? <a href="/coupons">View all available coupons</a></p>
  </div>

  <div class="coupon-success" id="couponSuccess">
    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
      <polyline points="20 6 9 17 4 12"></polyline>
    </svg>
    <span>Coupon applied successfully!</span>
  </div>
</div>


             <div class="price-breakup">
  <!-- Row 1: Subtotal -->
  <div class="price-row">
    <span>Subtotal</span>
    <span>‚Çπ<%= (subtotal || 0).toLocaleString() %></span>
  </div>
 
  <!-- Row 2: Shipping (Always show ‚Çπ49) -->
  <div class="price-row" id="shippingRow">
    <span>Shipping</span>
    <span>‚Çπ49</span>
  </div>
 
  <!-- Row 3: Discount (Show if discount > 0) -->
  <div class="price-row discount <%= (discount || 0) > 0 ? 'show' : '' %>" id="discountRow">
    <span>Discount</span>
    <span id="discountValue">-‚Çπ<%= (discount || 0).toLocaleString() %></span>
  </div>
 
  <!-- Row 4: Total -->
  <div class="total-row">
    <span>Total</span>
    <span class="total-amount" id="totalAmount">
      ‚Çπ<%= (((subtotal || 0) - (discount || 0) + 49)).toLocaleString() %>
    </span>
  </div>
</div>

              <button id="place-order-btn" class="place-order-btn">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z"></path>
                  <line x1="3" y1="6" x2="21" y2="6"></line>
                  <path d="M16 10a4 4 0 0 1-8 0"></path>
                </svg>
                Place Order
              </button>
              <p class="terms-text">By placing this order, you agree to our Terms & Conditions</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

 
<div class="modal" id="addressModal">
  <div class="modal-content">
    <div class="modal-header">
      <h2 id="modalTitle">Add New Address</h2>
      <button class="close-btn" onclick="closeModal()">√ó</button>
    </div>
    <form id="addressForm" onsubmit="saveAddress(event)">
      <input type="hidden" id="editId" name="id">
      
      <!-- Address Type -->
      <div class="form-group">
        <label class="form-label" for="type">Address Type *</label>
        <select class="form-select" name="addressType" id="type" required>
          <option value="" disabled selected>Select address type</option>
          <option value="Home">üè† Home</option>
          <option value="Work">üè¢ Work</option>
          <option value="Other">üì¶ Other</option>
        </select>
        <div class="error-message" id="typeError">Please select a valid address type</div>
      </div>

      <!-- Name & Phone -->
      <div class="form-row">
        <div class="form-group">
          <label class="form-label" for="name">Full Name *</label>
          <input type="text" class="form-input" name="name" id="name" placeholder="Enter full name" required minlength="3">
          <small style="color: #666; font-size: 12px; margin-top: 5px;">Letters and spaces only, 3-20 characters</small>
          <div class="error-message" id="nameError"></div>
        </div>
        <div class="form-group">
          <label class="form-label" for="phone">Phone Number *</label>
          <input type="tel" class="form-input" name="phone" id="phone" placeholder="10-digit number" required maxlength="10">
          <div class="error-message" id="phoneError">Phone number must be 10 digits</div>
        </div>
      </div>

      <!-- House & Building -->
      <div class="form-row">
        <div class="form-group">
          <label class="form-label" for="houseName">House/Building Name *</label>
          <input type="text" class="form-input" name="houseName" id="houseName" placeholder="House/building name" required minlength="2">
          <div class="error-message" id="houseNameError">House name must be at least 2 characters</div>
        </div>
        <div class="form-group">
          <label class="form-label" for="buildingNumber">Building Number</label>
          <input type="text" class="form-input" name="buildingNumber" id="buildingNumber" placeholder="Building number (optional)">
        </div>
      </div>

      <!-- Landmark -->
      <div class="form-group">
        <label class="form-label" for="landmark">Landmark *</label>
        <textarea class="form-textarea" name="landmark" id="landmark" placeholder="Nearby landmark or reference" required minlength="3"></textarea>
        <div class="error-message" id="landmarkError">Landmark must be at least 3 characters</div>
      </div>

      <!-- Alt Phone & Nationality -->
      <div class="form-row">
        <div class="form-group">
          <label class="form-label" for="altPhone">Alternative Number</label>
          <input type="tel" class="form-input" name="altPhone" id="altPhone" placeholder="10-digit number (optional)" maxlength="10">
          <div class="error-message" id="altPhoneError">Alternative phone must be 10 digits</div>
        </div>
        <div class="form-group">
          <label class="form-label" for="nationality">Nationality *</label>
          <input type="text" class="form-input" name="nationality" id="nationality" value="India" readonly style="background-color: #f3f4f6; cursor: not-allowed;">
          <small style="color: #666; font-size: 12px; margin-top: 5px;">India is the only available country</small>
        </div>
      </div>

      <!-- City & State -->
      <div class="form-row">
        <div class="form-group">
          <label class="form-label" for="city">City *</label>
          <input type="text" class="form-input" name="city" id="city" placeholder="Auto-filled from PIN code" required>
          <small style="color: #666; font-size: 12px; margin-top: 5px;">Auto-filled when you enter PIN code</small>
          <div class="error-message" id="cityError">City is required</div>
        </div>
        <div class="form-group">
          <label class="form-label" for="state">State *</label>
          <select class="form-select" name="state" id="state" required>
            <option value="" disabled selected>Select state</option>
            <option value="Andhra Pradesh">Andhra Pradesh</option>
            <option value="Arunachal Pradesh">Arunachal Pradesh</option>
            <option value="Assam">Assam</option>
            <option value="Bihar">Bihar</option>
            <option value="Chhattisgarh">Chhattisgarh</option>
            <option value="Goa">Goa</option>
            <option value="Gujarat">Gujarat</option>
            <option value="Haryana">Haryana</option>
            <option value="Himachal Pradesh">Himachal Pradesh</option>
            <option value="Jharkhand">Jharkhand</option>
            <option value="Karnataka">Karnataka</option>
            <option value="Kerala">Kerala</option>
            <option value="Madhya Pradesh">Madhya Pradesh</option>
            <option value="Maharashtra">Maharashtra</option>
            <option value="Manipur">Manipur</option>
            <option value="Meghalaya">Meghalaya</option>
            <option value="Mizoram">Mizoram</option>
            <option value="Nagaland">Nagaland</option>
            <option value="Odisha">Odisha</option>
            <option value="Punjab">Punjab</option>
            <option value="Rajasthan">Rajasthan</option>
            <option value="Sikkim">Sikkim</option>
            <option value="Tamil Nadu">Tamil Nadu</option>
            <option value="Telangana">Telangana</option>
            <option value="Tripura">Tripura</option>
            <option value="Uttar Pradesh">Uttar Pradesh</option>
            <option value="Uttarakhand">Uttarakhand</option>
            <option value="West Bengal">West Bengal</option>
          </select>
          <small style="color: #666; font-size: 12px; margin-top: 5px;">Auto-filled when you enter PIN code</small>
          <div class="error-message" id="stateError">State is required</div>
        </div>
      </div>

      <!-- PIN Code -->
      <div class="form-group">
        <label class="form-label" for="zip">PIN Code *</label>
        <input type="text" class="form-input" name="pincode" id="zip" placeholder="6-digit PIN code" required maxlength="6">
        <small style="color: #666; font-size: 12px; margin-top: 5px;">6 digits - auto-fills city and state</small>
        <div id="zipLoader" style="display: none; margin-top: 8px; color: #22c55e; font-size: 12px;">
          <span>‚è≥ Fetching location...</span>
        </div>
        <div id="zipSuccess" style="display: none; margin-top: 8px; color: #22c55e; font-size: 12px;">
          <span>‚úì Location found</span>
        </div>
        <div class="error-message" id="zipError">PIN code must be 6 digits</div>
      </div>

      <!-- Default Address -->
      <div class="form-group">
        <div class="checkbox-group">
          <input type="checkbox" id="setDefault" name="isDefault">
          <label for="setDefault">‚≠ê Set as default address</label>
        </div>
      </div>

      <!-- Form Actions -->
      <div class="modal-actions">
        <button type="button" class="modal-btn btn-cancel" onclick="closeModal()">Cancel</button>
        <button type="submit" class="modal-btn btn-submit" id="submitBtn">Save Address</button>
      </div>
    </form>
  </div>
</div>


<div id="couponModal" class="coupon-modal">
  <div class="coupon-modal-content-wrapper">
    <div class="coupon-modal-header-section">
      <h2>Select a Coupon</h2>
      <button class="coupon-modal-close" onclick="closeCouponModal()">‚úï</button>
    </div>

    <div id="couponLoading" class="coupon-modal-loading" style="display: none;">
      <div class="spinner"></div>
      <p>Loading coupons...</p>
    </div>

    <div id="couponList" class="coupon-list">
      <!-- Coupons will be rendered here -->
    </div>

    <div class="coupon-modal-pagination">
      <button id="couponPrevBtn" class="pagination-btn" onclick="couponPrevPage()">‚Üê Previous</button>
      <span id="couponPageInfo" class="page-info">Page 1 of 1</span>
      <button id="couponNextBtn" class="pagination-btn" onclick="couponNextPage()">Next ‚Üí</button>
    </div>
  </div>
</div>


<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.all.min.js"></script>
<script src="https://checkout.razorpay.com/v1/checkout.js"></script>

<script>

  let priceState = {
    subtotal: 0,
    discount: 0,
    total: 0,
    appliedCoupon: null,
    appliedCouponCode: '' 
  };



  const showErrorMessage = (fieldId, message) => {
    const field = document.getElementById(fieldId);
    const errorElement = document.getElementById(`${fieldId}Error`);
    if (field && errorElement) {
      field.classList.add('error-field');
      errorElement.textContent = message;
      errorElement.classList.add('show');
    }
  };

  const clearErrorMessage = (fieldId) => {
    const field = document.getElementById(fieldId);
    const errorElement = document.getElementById(`${fieldId}Error`);
    if (field && errorElement) {
      field.classList.remove('error-field');
      errorElement.classList.remove('show');
      errorElement.textContent = '';
    }
  };

  const clearAllErrorMessages = () => {
    document.querySelectorAll('.error-message').forEach(elem => {
      elem.classList.remove('show');
      elem.textContent = '';
    });
    document.querySelectorAll('.error-field').forEach(field => {
      field.classList.remove('error-field');
    });
  };

  // ============================================
  // ADDRESS VALIDATION
  // ============================================
  
  const validateAddressForm = (payload) => {
    const errors = {};

    if (!payload.addressType || !['Home', 'Work', 'Other'].includes(payload.addressType)) {
      errors.type = 'Please select a valid address type';
    }

    if (!payload.name) {
      errors.name = 'Full name is required';
    } else {
      const name = payload.name.trim();
      if (name.length < 3) {
        errors.name = 'Full name must be at least 3 characters';
      } else if (name.length > 20) {
        errors.name = 'Full name cannot exceed 20 characters';
      } else if (!/^[A-Za-z]+(?: [A-Za-z]+)*$/.test(name)) {

    errors.name = 'Only letters and spaces allowed';
}

    }

    if (!payload.phone) {
      errors.phone = 'Phone number is required';
    } else {
      const phone = payload.phone.trim();
      if (!/^\d{10}$/.test(phone)) {
        errors.phone = 'Phone number must be exactly 10 digits';
      } else {
        const uniqueDigits = new Set(phone.split(''));
        if (uniqueDigits.size === 1) {
          errors.phone = 'Phone number cannot consist of all identical digits';
        }

        const digits = phone.split('').map(Number);
        const isAscending = digits.every((d, i) => i === 0 || d === digits[i - 1] + 1);
        if (isAscending) {
          errors.phone = 'Phone number cannot be in ascending order (e.g., 1234567890)';
        }

        const isDescending = digits.every((d, i) => i === 0 || d === digits[i - 1] - 1);
        if (isDescending) {
          errors.phone = 'Phone number cannot be in descending order (e.g., 9876543210)';
        }

        let maxConsecutive = 1;
        let currentConsecutive = 1;
        for (let i = 1; i < phone.length; i++) {
          if (phone[i] === phone[i - 1]) {
            currentConsecutive++;
            maxConsecutive = Math.max(maxConsecutive, currentConsecutive);
          } else {
            currentConsecutive = 1;
          }
        }
        if (maxConsecutive > 3) {
          errors.phone = 'Phone number cannot have more than 3 consecutive identical digits';
        }
      }
    }

    if (!payload.houseName) {
      errors.houseName = 'House/Building name is required';
    } else {
      const houseName = payload.houseName;
      if (houseName.length < 3) {
        errors.houseName = 'House/Building name must be at least 3 characters';
      } else if (houseName.length > 50) {
        errors.houseName = 'House/Building name cannot exceed 50 characters';
      } else if (!/[a-zA-Z0-9]/.test(houseName)) {
        errors.houseName = 'House/Building name cannot contain only special characters';
      } else {
        const specialCharCount = (houseName.match(/[^a-zA-Z0-9\s\-'.]/g) || []).length;
        if (specialCharCount > houseName.length * 0.5) {
          errors.houseName = 'House/Building name contains too many special characters';
        }
      }
    }

    if (payload.buildingNumber && payload.buildingNumber.length > 0) {
      const buildingNumber = payload.buildingNumber;
      if (!/[a-zA-Z0-9]/.test(buildingNumber)) {
        errors.buildingNumber = 'Building number cannot contain only special characters';
      } else {
        const specialCharCount = (buildingNumber.match(/[^a-zA-Z0-9\s\-'.\/]/g) || []).length;
        if (specialCharCount > buildingNumber.length * 0.5) {
          errors.buildingNumber = 'Building number contains too many special characters';
        }
      }
    }

    if (!payload.landmark) {
      errors.landmark = 'Landmark is required';
    } else {
      const landmark = payload.landmark;
      if (landmark.length < 3) {
        errors.landmark = 'Landmark must be at least 3 characters';
      } else if (!/[a-zA-Z0-9]/.test(landmark)) {
        errors.landmark = 'Landmark cannot contain only special characters';
      } else {
        const specialCharCount = (landmark.match(/[^a-zA-Z0-9\s\-'.]/g) || []).length;
        if (specialCharCount > landmark.length * 0.5) {
          errors.landmark = 'Landmark contains too many special characters';
        }
      }
    }

    if (payload.altPhone && payload.altPhone.length > 0) {
      const altPhone = payload.altPhone.trim();
      if (!/^\d{10}$/.test(altPhone)) {
        errors.altPhone = 'Alternative phone number must be exactly 10 digits';
      } else if (altPhone === payload.phone) {
        errors.altPhone = 'Alternative phone cannot be same as main phone number';
      } else {
        const uniqueDigits = new Set(altPhone.split(''));
        if (uniqueDigits.size === 1) {
          errors.altPhone = 'Alternative phone number cannot consist of all identical digits';
        }

        const digits = altPhone.split('').map(Number);
        const isAscending = digits.every((d, i) => i === 0 || d === digits[i - 1] + 1);
        if (isAscending) {
          errors.altPhone = 'Alternative phone number cannot be in ascending order';
        }

        const isDescending = digits.every((d, i) => i === 0 || d === digits[i - 1] - 1);
        if (isDescending) {
          errors.altPhone = 'Alternative phone number cannot be in descending order';
        }
      }
    }

    if (!payload.nationality) {
      errors.nationality = 'Nationality is required';
    } else if (payload.nationality.trim() !== 'India') {
      errors.nationality = 'Only India is available';
    }

    if (!payload.city) {
      errors.city = 'City is required';
    } else {
      const city = payload.city;
      if (city.length < 2) {
        errors.city = 'City must be at least 2 characters';
      } else if (!/^[A-Za-z ]+$/
.test(city)) {
        errors.city = 'City can only contain letters, spaces, apostrophes, and hyphens';
      }
    }

    if (!payload.state) {
      errors.state = 'State is required';
    } else {
      const validStates = [
        'Andhra Pradesh', 'Arunachal Pradesh', 'Assam', 'Bihar', 'Chhattisgarh',
        'Goa', 'Gujarat', 'Haryana', 'Himachal Pradesh', 'Jharkhand',
        'Karnataka', 'Kerala', 'Madhya Pradesh', 'Maharashtra', 'Manipur',
        'Meghalaya', 'Mizoram', 'Nagaland', 'Odisha', 'Punjab',
        'Rajasthan', 'Sikkim', 'Tamil Nadu', 'Telangana', 'Tripura',
        'Uttar Pradesh', 'Uttarakhand', 'West Bengal'
      ];
      if (!validStates.includes(payload.state)) {
        errors.state = 'Please select a valid state';
      }
    }

    if (!payload.pincode) {
      errors.zip = 'PIN code is required';
    } else {
      const pincode = payload.pincode.trim();
      if (!/^\d{6}$/.test(pincode)) {
        errors.zip = 'PIN code must be exactly 6 digits';
      } else {
        const uniqueDigits = new Set(pincode.split(''));
        if (uniqueDigits.size === 1) {
          errors.zip = 'PIN code cannot consist of all identical digits';
        }

        let isSequential = true;
        for (let i = 1; i < 6; i++) {
          if (parseInt(pincode[i]) - parseInt(pincode[i - 1]) !== 1) {
            isSequential = false;
            break;
          }
        }
        if (isSequential) {
          errors.zip = 'PIN code cannot be sequential (e.g., 123456)';
        }

        let isReverseSequential = true;
        for (let i = 1; i < 6; i++) {
          if (parseInt(pincode[i - 1]) - parseInt(pincode[i]) !== 1) {
            isReverseSequential = false;
            break;
          }
        }
        if (isReverseSequential) {
          errors.zip = 'PIN code cannot be reverse sequential (e.g., 654321)';
        }
      }
    }

    return errors;
  };

  

  async function saveAddress(e) {
    e.preventDefault();
    const submitBtn = document.getElementById('submitBtn');
    submitBtn.disabled = true;
    const originalText = submitBtn.textContent;
    submitBtn.textContent = 'Saving...';

    const editId = document.getElementById('editId').value;
    const payload = {
      addressType: document.getElementById('type').value.trim(),
      name: document.getElementById('name').value.trim(),
      phone: document.getElementById('phone').value.trim(),
      houseName: document.getElementById('houseName').value.trim(),
      buildingNumber: document.getElementById('buildingNumber').value.trim(),
      landmark: document.getElementById('landmark').value.trim(),
      altPhone: document.getElementById('altPhone').value.trim(),
      nationality: 'India',
      city: document.getElementById('city').value.trim(),
      state: document.getElementById('state').value.trim(),
      pincode: document.getElementById('zip').value.trim(),
      isDefault: document.getElementById('setDefault').checked
    };

    const errors = validateAddressForm(payload);
    clearAllErrorMessages();

    if (Object.keys(errors).length > 0) {
      Object.entries(errors).forEach(([fieldId, message]) => {
        showErrorMessage(fieldId, message);
      });
      submitBtn.disabled = false;
      submitBtn.textContent = originalText;

      Swal.fire({
        icon: 'error',
        title: 'Validation Error!',
        text: 'Please fix the errors highlighted in the form',
        confirmButtonColor: '#22c55e'
      });
      return;
    }

    if (editId) payload.id = editId;

    const url = editId ? `/checkout/edit-address/${editId}` : '/checkout/add-address';

    try {
      const res = await fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
      const data = await res.json();

      if (data.success) {
        Swal.fire({
          icon: 'success',
          title: 'Success!',
          text: `Address ${editId ? 'updated' : 'added'} successfully`,
          confirmButtonColor: '#22c55e',
          confirmButtonText: 'OK'
        });
        closeModal();
        setTimeout(() => window.location.reload(), 1500);
      } else {
        if (data.errors && Array.isArray(data.errors)) {
          Swal.fire({
            icon: 'error',
            title: 'Validation Error!',
            html: '<ul style="text-align: left;">' +
                  data.errors.map(err => `<li>${err}</li>`).join('') +
                  '</ul>',
            confirmButtonColor: '#22c55e'
          });
        } else {
          Swal.fire({
            icon: 'error',
            title: 'Error!',
            text: data.message || 'Failed to save address',
            confirmButtonColor: '#22c55e'
          });
        }
      }
    } catch (err) {
      console.error('Save address error:', err);
      Swal.fire({
        icon: 'error',
        title: 'Server Error!',
        text: 'Failed to save address. Please try again.',
        confirmButtonColor: '#22c55e'
      });
    } finally {
      submitBtn.disabled = false;
      submitBtn.textContent = originalText;
    }
  }

  document.getElementById('name')?.addEventListener('blur', (e) => {
    const name = e.target.value.trim();
    clearErrorMessage('name');
    if (name.length > 0) {
      if (name.length < 3) {
        showErrorMessage('name', 'Must be at least 3 characters');
      } else if (name.length > 20) {
        showErrorMessage('name', 'Cannot exceed 20 characters');
      } else if (!/^[a-zA-Z\s'-]+$/.test(name)) {
        showErrorMessage('name', 'Letters, spaces, apostrophes and hyphens only');
      }
    }
  });

  document.getElementById('phone')?.addEventListener('blur', (e) => {
    const phone = e.target.value.trim();
    clearErrorMessage('phone');
    if (phone.length === 10) {
      const uniqueDigits = new Set(phone.split(''));
      if (uniqueDigits.size === 1) {
        showErrorMessage('phone', 'Cannot have all same digits (e.g., 0000000000)');
      }
      
      const digits = phone.split('').map(Number);
      const isAscending = digits.every((d, i) => i === 0 || d === digits[i - 1] + 1);
      if (isAscending) {
        showErrorMessage('phone', 'Cannot be ascending (e.g., 1234567890)');
      }
      
      const isDescending = digits.every((d, i) => i === 0 || d === digits[i - 1] - 1);
      if (isDescending) {
        showErrorMessage('phone', 'Cannot be descending (e.g., 9876543210)');
      }
    }
  });

  document.getElementById('altPhone')?.addEventListener('blur', (e) => {
    const altPhone = e.target.value.trim();
    clearErrorMessage('altPhone');
    if (altPhone.length > 0) {
      const mainPhone = document.getElementById('phone')?.value.trim();
      if (altPhone === mainPhone) {
        showErrorMessage('altPhone', 'Cannot be same as main phone number');
      }
    }
  });

  document.getElementById('houseName')?.addEventListener('blur', (e) => {
    const houseName = e.target.value.trim();
    clearErrorMessage('houseName');
    if (houseName.length > 0) {
      if (!/[a-zA-Z0-9]/.test(houseName)) {
        showErrorMessage('houseName', 'Cannot contain only special characters');
      }
    }
  });

  document.getElementById('landmark')?.addEventListener('blur', (e) => {
    const landmark = e.target.value.trim();
    clearErrorMessage('landmark');
    if (landmark.length > 0) {
      if (landmark.length < 3) {
        showErrorMessage('landmark', 'Must be at least 3 characters');
      } else if (!/[a-zA-Z0-9]/.test(landmark)) {
        showErrorMessage('landmark', 'Cannot contain only special characters');
      }
    }
  });

  document.getElementById('city')?.addEventListener('blur', (e) => {
    const city = e.target.value.trim();
    clearErrorMessage('city');
    if (city.length > 0 && !/^[a-zA-Z\s'-]+$/.test(city)) {
      showErrorMessage('city', 'City can only contain letters, spaces, apostrophes, and hyphens');
    }
  });

  

  document.getElementById('phone')?.addEventListener('input', (e) => {
    e.target.value = e.target.value.replace(/\D/g, '').substring(0, 10);
  });

  document.getElementById('altPhone')?.addEventListener('input', (e) => {
    e.target.value = e.target.value.replace(/\D/g, '').substring(0, 10);
  });

  document.getElementById('zip')?.addEventListener('input', (e) => {
    e.target.value = e.target.value.replace(/\D/g, '').substring(0, 6);
  });

  document.getElementById('name')?.addEventListener('input', (e) => {
    e.target.value = e.target.value.replace(/[^a-zA-Z\s'-]/g, '').substring(0, 20);
    clearErrorMessage('name');
  });

  // ============================================
  // PIN CODE WITH LOCATION FETCH
  // ============================================

  document.getElementById('zip')?.addEventListener('blur', async (e) => {
    const pincode = e.target.value.trim();
    const zipError = document.getElementById('zipError');
    const zipSuccess = document.getElementById('zipSuccess');
    const zipLoader = document.getElementById('zipLoader');

    zipError.style.display = 'none';
    zipSuccess.style.display = 'none';
    zipLoader.style.display = 'none';

    if (!pincode) return;

    if (!/^\d{6}$/.test(pincode)) {
      zipError.textContent = 'PIN code must be exactly 6 digits';
      zipError.style.display = 'block';
      return;
    }

    if (/^(\d)\1{5}$/.test(pincode)) {
      zipError.textContent = 'PIN code cannot have all same digits';
      zipError.style.display = 'block';
      return;
    }

    let isSequential = true;
    for (let i = 1; i < 6; i++) {
      if (parseInt(pincode[i]) - parseInt(pincode[i - 1]) !== 1) {
        isSequential = false;
        break;
      }
    }
    if (isSequential) {
      zipError.textContent = 'PIN code cannot be sequential';
      zipError.style.display = 'block';
      return;
    }

    let isReverseSequential = true;
    for (let i = 1; i < 6; i++) {
      if (parseInt(pincode[i - 1]) - parseInt(pincode[i]) !== 1) {
        isReverseSequential = false;
        break;
      }
    }
    if (isReverseSequential) {
      zipError.textContent = 'PIN code cannot be reverse sequential';
      zipError.style.display = 'block';
      return;
    }

    zipLoader.style.display = 'block';

    try {
      const res = await fetch(`/addresses/get-location/${pincode}`);
      const data = await res.json();

      zipLoader.style.display = 'none';

      if (data.success) {
        const city = data.city || '';
        const state = data.state || '';

        document.getElementById('city').value = city;

        const stateSelect = document.getElementById('state');
        let found = false;

        for (let i = 0; i < stateSelect.options.length; i++) {
          if (stateSelect.options[i].value === state) {
            stateSelect.selectedIndex = i;
            found = true;
            break;
          }
        }

        if (found) {
          zipSuccess.textContent = `‚úì Location found: ${city}, ${state}`;
          zipSuccess.style.display = 'block';
        } else {
          zipError.textContent = `City found (${city}) but state not in list. Please select manually.`;
          zipError.style.display = 'block';
        }
      } else {
        zipError.textContent = data.message || 'Invalid PIN code';
        zipError.style.display = 'block';
      }
    } catch (err) {
      zipLoader.style.display = 'none';
      zipError.textContent = 'Error fetching location data';
      zipError.style.display = 'block';
    }
  });

  // ============================================
  // ADDRESS SELECTION & PAYMENT
  // ============================================

  const paymentMethods = {
    'card': { icon: 'üí≥', label: 'Debit Card / Credit Card' },
    'bank': { icon: 'üè¶', label: 'Net Banking' },
    'upi': { icon: 'üì±', label: 'UPI Payment' },
    'cod': { icon: 'üíµ', label: 'Cash on Delivery' },
    'wallet': { icon: 'üí∞', label: 'Wallet' },
    'razorpay': { icon: 'üí≥', label: 'Razorpay Payment' }
  };

  document.querySelectorAll('.address-option').forEach(option => {
    option.addEventListener('click', e => {
      
      if (e.target.closest('.edit-btn') || e.target.closest('.delete-btn')) return;
      
   
      document.querySelectorAll('.address-option').forEach(opt => opt.classList.remove('selected'));
      
     
      option.classList.add('selected');
      
      console.log('‚úÖ Address selected:', option.getAttribute('data-address'));
      updatePlaceOrderButton();
    });
   });

  document.querySelectorAll('.payment-option').forEach(option => {
    option.addEventListener('click', () => {
      document.querySelectorAll('.payment-option').forEach(opt => opt.classList.remove('selected'));
      option.classList.add('selected');

      const paymentType = option.getAttribute('data-payment');
      const paymentInfo = paymentMethods[paymentType];
      const selectedPaymentInfo = document.getElementById('selectedPaymentInfo');

      if (paymentInfo) {
        selectedPaymentInfo.style.display = 'flex';
      }

      updatePlaceOrderButton();
    });
  });

  function updatePlaceOrderButton() {
    const placeOrderBtn = document.getElementById('place-order-btn');
    const selectedAddress = document.querySelector('.address-option.selected');
    const selectedPayment = document.querySelector('.payment-option.selected');
    placeOrderBtn.disabled = !(selectedAddress && selectedPayment);
  }

  // ============================================
  // PLACE ORDER
  // ============================================

  document.getElementById('place-order-btn')?.addEventListener('click', async () => {
    const retryBtn = document.getElementById('retryPaymentBtn');
    if (retryBtn) retryBtn.style.display = 'none';



    const outOfStockItems = document.querySelectorAll('.out-of-stock-item');
    if (outOfStockItems.length > 0) {
      const outOfStockNames = Array.from(outOfStockItems).map(item => 
        item.querySelector('.item-name')?.textContent || 'Unknown'
      ).join(', ');
      Swal.fire({
        icon: 'error',
        title: 'Out of Stock!',
        text: `Items out of stock: ${outOfStockNames}. Please update your cart.`,
        confirmButtonColor: '#ef4444'
      });
      return;
    }

    const selectedAddress = document.querySelector('.address-option.selected');
    if (!selectedAddress) {
      Swal.fire({
        icon: 'warning',
        title: 'Select Address',
        text: 'Please choose a delivery address.',
        confirmButtonColor: '#22c55e'
      });
      return;
    }

    const selectedPayment = document.querySelector('.payment-option.selected');
    if (!selectedPayment) {
      Swal.fire({
        icon: 'warning',
        title: 'Select Payment',
        text: 'Please choose a payment method.',
        confirmButtonColor: '#22c55e'
      });
      return;
    }

    

    const addressId = selectedAddress.getAttribute('data-address');
    const paymentMethod = selectedPayment.getAttribute('data-payment');
    const couponCode = priceState.appliedCouponCode || '';

    const btn = document.getElementById('place-order-btn');
    const originalText = btn.textContent;
    btn.disabled = true;
    btn.textContent = 'Processing...';

 try {
      if (['razorpay', 'card', 'upi', 'bank'].includes(paymentMethod)) {
        await handleRazorpayPayment(addressId, couponCode);
      } else if (paymentMethod === 'cod') {
        await handleCODPayment(addressId, couponCode);
      } else if (paymentMethod === 'wallet') {
        await handleWalletPayment(addressId, couponCode);
      } else {
        throw new Error('Unsupported payment method');
      }
    } catch (err) {
      console.error('Order placement error:', err);
      Swal.fire({
        icon: 'error',
        title: 'Order Failed',
        text: err.message || 'Please try again.',
        confirmButtonColor: '#ef4444'
      });
    } finally {
      btn.disabled = false;
      btn.textContent = originalText;
    }
  });

  // ============================================
  // ADDRESS MODAL
  // ============================================

  function editAddress(id) {
    openModal(id);
  }

  function openModal(id = null) {
    const modal = document.getElementById('addressModal');
    const modalTitle = document.getElementById('modalTitle');
    const submitBtn = document.getElementById('submitBtn');
    const form = document.getElementById('addressForm');

    clearAllErrorMessages();
    form.reset();

    if (!id) {
      document.getElementById('editId').value = '';
      modalTitle.textContent = 'Add New Address';
      submitBtn.textContent = 'Save Address';
    } else {
      modalTitle.textContent = 'Edit Address';
      submitBtn.textContent = 'Update Address';
      fetchAddress(id);
    }

    modal.classList.add('show');
  }

  function closeModal() {
    document.getElementById('addressModal').classList.remove('show');
    clearAllErrorMessages();
  }

  async function fetchAddress(id) {
    try {
      const res = await fetch(`/addresses/addresses-edit/${id}`, {
        method: 'GET',
        headers: { 'Content-Type': 'application/json' }
      });

      if (!res.ok) throw new Error('Failed to fetch');

      const data = await res.json();

      if (data.success && data.address) {
        const addr = data.address;
        document.getElementById('editId').value = addr._id || '';
        document.getElementById('type').value = addr.addressType || '';
        document.getElementById('name').value = addr.name || '';
        document.getElementById('phone').value = addr.phone || '';
        document.getElementById('houseName').value = addr.houseName || '';
        document.getElementById('buildingNumber').value = addr.buildingNumber || '';
        document.getElementById('landmark').value = addr.landmark || '';
        document.getElementById('altPhone').value = addr.altPhone || '';
        document.getElementById('nationality').value = addr.nationality || '';
        document.getElementById('city').value = addr.city || '';
        document.getElementById('state').value = addr.state || '';
        document.getElementById('zip').value = addr.pincode || '';
        document.getElementById('setDefault').checked = addr.isDefault || false;
      }
    } catch (err) {
      Swal.fire({
        icon: 'error',
        title: 'Error!',
        text: 'Failed to load address',
        confirmButtonColor: '#22c55e'
      });
    }
  }

  async function deleteAddress(id) {
    const confirm = await Swal.fire({
      icon: 'warning',
      title: 'Are you sure?',
      text: 'Do you want to delete this address?',
      showCancelButton: true,
      confirmButtonText: 'Yes, delete it!',
      cancelButtonText: 'Cancel',
      confirmButtonColor: '#ef4444',
      cancelButtonColor: '#22c55e'
    });

    if (!confirm.isConfirmed) return;

    try {
      const res = await fetch(`/addresses/delete/${id}`, { method: 'DELETE' });
      const data = await res.json();
      if (data.success) {
        Swal.fire({
          icon: 'success',
          title: 'Deleted!',
          text: 'Address deleted successfully',
          timer: 2000,
          showConfirmButton: false
        });
        setTimeout(() => window.location.reload(), 2000);
      }
    } catch (err) {
      Swal.fire({
        icon: 'error',
        title: 'Error!',
        text: 'Failed to delete address',
        confirmButtonColor: '#22c55e'
      });
    }
  }

async function handleRazorpayPayment(addressId, couponCode = '') {
  try {
    console.log('üí≥ [STEP 1] Starting payment flow');
    
    const selectedAddressId = addressId || document.querySelector('.address-option.selected')?.getAttribute('data-address');
    const appliedCouponCode = couponCode || priceState.appliedCouponCode || '';

    if (!selectedAddressId) throw new Error('Please select a delivery address');

  
    const authCheck = await fetch('/payment/check-auth', { method: 'GET', credentials: 'include' });
    const authData = await authCheck.json();
    if (!authData.isAuthenticated) {
      window.location.href = '/login';
      return;
    }

    
    console.log('üõí [STEP 2] Placing order...');
    const placeOrderResponse = await fetch('/order/place', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      credentials: 'include',
      body: JSON.stringify({
        addressId: selectedAddressId,
        couponCode: appliedCouponCode,
        paymentMethod: 'razorpay',
        notes: ''
      })
    });

    const placeOrderData = await placeOrderResponse.json();
    if (!placeOrderData.success) throw new Error(placeOrderData.message);

    // 3. Create Razorpay Order
    console.log('üí≥ [STEP 3] Creating Razorpay ID...');
    Swal.fire({ title: 'Processing...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });

    const createOrderResponse = await fetch('/payment/create-razorpayOrder', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      credentials: 'include',
      body: JSON.stringify({}) 
    });

    const orderData = await createOrderResponse.json();
    if (!orderData.success) throw new Error(orderData.message);

    Swal.close();

    // 4. Open Razorpay Options
    const options = {
      key: orderData.keyId,
      amount: orderData.amount,
      currency: orderData.currency || 'INR',
      name: 'Sentique',
      description: 'Online Purchase',
      order_id: orderData.orderId,
      
      // Success Handler
      handler: async (response) => {
        await verifyRazorpayPayment(
          response.razorpay_order_id,
          response.razorpay_payment_id,
          response.razorpay_signature,
          selectedAddressId,
          appliedCouponCode
        );
      },

      theme: { color: '#22c55e' },

      modal: {
        
        ondismiss: async () => {
          console.log('‚ö†Ô∏è User closed payment modal');
          Swal.fire({ 
            title: 'Cancelling...', 
            text: 'Recording payment status',
            allowOutsideClick: false, 
            didOpen: () => Swal.showLoading() 
          });
          
          try {
            
            const res = await fetch('/payment/payment-failure', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              credentials: 'include',
              body: JSON.stringify({
                razorpay_order_id: orderData.orderId,
                error_description: 'Payment cancelled by user',
                error_code: 'USER_CANCELLED'
              })
            });
            
            const data = await res.json();
            Swal.close();

           
            if (data.success && data.orderId) {
               window.location.href = `/orderFailure?orderId=${data.orderId}`;
            } else {
               
               console.error("No orderId returned");
               window.location.href = `/orderFailure?error=PaymentCancelled`;
            }
          } catch (err) {
            console.error('Error in ondismiss:', err);
            window.location.href = '/orderFailure';
          }
        }
      }
    };

    const rzp = new Razorpay(options);
    
    
    rzp.on('payment.failed', async (response) => {
      await handlePaymentFailure(response.error);
    });

    rzp.open();

  } catch (err) {
    console.error('‚ùå PAYMENT ERROR:', err);
    Swal.fire({ icon: 'error', title: 'Error', text: err.message });
  }
}
  
 async function verifyRazorpayPayment(razorpayOrderId, razorpayPaymentId, razorpaySignature, addressId, couponCode = '') {
  console.log(' Verifying payment with signature');

  Swal.fire({
    title: 'Verifying Payment...',
    html: 'Please wait while we verify your payment',
    allowOutsideClick: false,
    didOpen: () => Swal.showLoading()
  });

  try {
    if (!razorpayOrderId || !razorpayPaymentId || !razorpaySignature || !addressId) {
      throw new Error('Missing payment verification data');
    }

    const payload = {
      razorpay_order_id: razorpayOrderId,
      razorpay_payment_id: razorpayPaymentId,
      razorpay_signature: razorpaySignature,
      addressId: addressId,
      couponCode: couponCode || ''
    };

    console.log('üì§ Sending verification payload');

    const response = await fetch('/payment/verify-razorpay-payment', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      credentials: 'include',
      body: JSON.stringify(payload)
    });

    console.log('üì• Verification response status:', response.status);

    if (!response.ok) {
      const errorText = await response.text();
      console.error('‚ùå Verification failed - Response:', errorText);
      throw new Error('Verification failed');
    }

    const data = await response.json();
    console.log('‚úÖ Verification successful:', data);

    if (data.success) {
      Swal.fire({
        icon: 'success',
        title: 'Payment Successful!',
        html: `<div style="text-align: center;"><p><strong>Thank you for your order!</strong></p><p>Order ID: <strong>${data.orderId || data.orderNumber}</strong></p></div>`,
        confirmButtonText: 'View Order',
        confirmButtonColor: '#22c55e',
        allowOutsideClick: false
      }).then(() => {
       
        window.location.href = `/orderSuccess?orderId=${data.orderId || data.orderNumber}`;
      });
    } else {
      throw new Error(data.message || 'Payment verification failed');
    }
  } catch (err) {
    console.error('‚ùå Verification error:', err.message);
    Swal.close();
    
    const amountText = document.getElementById('totalAmount')?.textContent || '‚Çπ0';
   
    window.location.href = `/orderFailure?transactionId=N/A&errorReason=${encodeURIComponent(err.message)}&paymentMethod=Card&amount=${encodeURIComponent(amountText)}&orderId=N/A`;
  }
}



  async function handleCODPayment(addressId, couponCode = '') {

  const amountText = document.getElementById('totalAmount')?.textContent || '0';
  const totalAmount = parseFloat(amountText.replace(/[‚Çπ$,]/g, ''));

  const COD_LIMIT = 2000;

  if (totalAmount > COD_LIMIT) {
    Swal.fire({
      icon: 'warning',
      title: 'COD Not Available',
      html: `<div style="text-align: left; line-height: 1.8;">
        <p><strong>Cash on Delivery is not available for orders above ‚Çπ${COD_LIMIT.toLocaleString('en-IN')}</strong></p>
        <p style="color: #666; font-size: 14px; margin-top: 10px;">
          Your order total: <strong style="color: #ef4444;">‚Çπ${totalAmount.toLocaleString('en-IN', {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
          })}</strong>
        </p>
        <p style="color: #666; font-size: 14px; margin-top: 10px;">
          Please choose an alternative payment method:
        </p>
        <ul style="margin-top: 8px; color: #666; font-size: 14px;">
          <li>üí≥ Debit Card / Credit Card</li>
          <li>üè¶ Net Banking</li>
          <li>üì± UPI Payment</li>
          <li>üí∞ Wallet</li>
        </ul>
      </div>`,
      confirmButtonText: 'OK',
      confirmButtonColor: '#22c55e'
    });
    return;
  }

  Swal.fire({
    title: 'Processing Order...',
    html: 'Please wait while we process your order',
    allowOutsideClick: false,
    didOpen: () => Swal.showLoading()
  });

  try {
    const payload = {
      addressId,
      paymentMethod: 'cod',
      couponCode
    };

    const response = await fetch('/order/place', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      credentials: 'include',
      body: JSON.stringify(payload)
    });
    
    const data = await response.json();

    if (data.success) {
      Swal.fire({
        icon: 'success',
        title: 'Order Placed Successfully!',
        html: `<div style="text-align: center;"><strong>Thank you for your order!</strong><br><p style="color: #666; font-size: 14px;">Order ID: <strong>${data.orderId}</strong></p></div>`,
        confirmButtonText: 'View Order',
        confirmButtonColor: '#22c55e',
        allowOutsideClick: false
      }).then(() => {
        window.location.href = `/orderSuccess?orderId=${data.orderId}`;
      });
    } else {
      throw new Error(data.message || 'Failed to place order');
    }
  } catch (err) {
    Swal.fire({
      icon: 'error',
      title: 'Error!',
      text: err.message || 'Failed to place order',
      confirmButtonColor: '#ef4444'
    });
  }
 }

 document.addEventListener('DOMContentLoaded', function() {
  const COD_LIMIT = 2000;
  
  function checkCODAvailability() {
    const amountText = document.getElementById('totalAmount')?.textContent || '0';
    const totalAmount = parseFloat(amountText.replace(/[‚Çπ$,]/g, ''));
    
    const codOption = document.querySelector('[data-payment="cod"]');
    
    if (codOption) {
      if (totalAmount > COD_LIMIT) {
        codOption.style.opacity = '0.5';
        codOption.style.pointerEvents = 'none';
        codOption.style.cursor = 'not-allowed';
        codOption.title = `COD not available for orders above ‚Çπ${COD_LIMIT}`;
        
        // Add warning badge
        if (!codOption.querySelector('.cod-badge')) {
          const badge = document.createElement('div');
          badge.className = 'cod-badge';
          badge.innerHTML = '‚ö†Ô∏è Not Available';
          badge.style.cssText = `
            position: absolute;
            top: 8px;
            right: 8px;
            background: #fef3c7;
            color: #92400e;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
            border: 1px solid #fcd34d;
          `;
          codOption.style.position = 'relative';
          codOption.appendChild(badge);
        }
        
        // If COD is currently selected, show warning and deselect
        if (codOption.classList.contains('selected')) {
          codOption.classList.remove('selected');
          Swal.fire({
            icon: 'warning',
            title: 'COD Not Available',
            text: `Cash on Delivery is not available for orders above ‚Çπ${COD_LIMIT}. Please select another payment method.`,
            confirmButtonColor: '#22c55e'
          });
        }
      } else {
        codOption.style.opacity = '1';
        codOption.style.pointerEvents = 'auto';
        codOption.style.cursor = 'pointer';
        codOption.title = '';
        
        // Remove warning badge
        const badge = codOption.querySelector('.cod-badge');
        if (badge) badge.remove();
      }
    }
  }
  
  // Check on page load
  checkCODAvailability();
  
  // Re-check whenever discount changes or amount updates
  const observer = new MutationObserver(checkCODAvailability);
  const totalAmountElem = document.getElementById('totalAmount');
  if (totalAmountElem) {
    observer.observe(totalAmountElem, { childList: true, subtree: true, characterData: true });
  }
 });

  // ============================================
  // WALLET PAYMENT
  // ============================================

  async function handleWalletPayment(addressId, couponCode = '') {
    Swal.fire({
      title: 'Processing Order...',
      html: 'Please wait while we process your order',
      allowOutsideClick: false,
      didOpen: () => Swal.showLoading()
    });

    try {
      const payload = {
        addressId,
        paymentMethod: 'wallet',
        couponCode
      };

      const response = await fetch('/order/place', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'include',
        body: JSON.stringify(payload)
      });
      
      const data = await response.json();

      if (data.success) {
        Swal.fire({
          icon: 'success',
          title: 'Order Placed Successfully!',
          html: `<div style="text-align: center;"><strong>Thank you for your order!</strong><br><p style="color: #666; font-size: 14px;">Order ID: <strong>${data.orderId}</strong></p></div>`,
          confirmButtonText: 'View Order',
          confirmButtonColor: '#22c55e',
          allowOutsideClick: false
        }).then(() => {
          window.location.href = `/orderSuccess?orderId=${data.orderId}`;
        });
      } else {
        throw new Error(data.message || 'Failed to place order');
      }
    } catch (err) {
      Swal.fire({
        icon: 'error',
        title: 'Error!',
        text: err.message || 'Failed to place order',
        confirmButtonColor: '#ef4444'
      });
    }
  }

  // ============================================
  // COUPON MANAGEMENT
  // ============================================

  document.addEventListener('DOMContentLoaded', function() {
    console.log(' Coupon script loaded');

    function initPrices() {
      const priceRows = document.querySelectorAll('.price-row');
      priceRows.forEach((row) => {
        const label = row.querySelector('span:first-child');
        const value = row.querySelector('span:last-child');
        
        if (label && label.textContent.trim() === 'Subtotal') {
          priceState.subtotal = parseFloat(value.textContent.replace(/[‚Çπ,]/g, '')) || 0;
        }
      });
    }
function updateDisplay() {
  const subtotal = typeof priceState.subtotal === 'number' ? priceState.subtotal : 0;
  const discount = typeof priceState.discount === 'number' ? priceState.discount : 0;
  const shippingCharge = 49;

  priceState.total = Math.max(0, subtotal - discount + shippingCharge);

  // Show shipping charge row
  const shippingRow = document.getElementById('shippingRow');
  if (shippingRow) {
    shippingRow.style.display = 'flex';
    const shippingElem = shippingRow.querySelector('span:last-child');
    if (shippingElem) {
      shippingElem.textContent = '‚Çπ49';
    }
  }

  // Handle discount row
  const discountRow = document.getElementById('discountRow');
  const discountValueElem = document.getElementById('discountValue');
  if (discountRow && discountValueElem) {
    if (discount > 0) {
      discountRow.classList.add('show');
      try {
        discountValueElem.textContent = '-‚Çπ' + parseFloat(discount).toLocaleString('en-IN', {
          minimumFractionDigits: 2,
          maximumFractionDigits: 2
        });
      } catch (err) {
        discountValueElem.textContent = '-‚Çπ' + discount.toFixed(2);
      }
    } else {
      discountRow.classList.remove('show');
    }
  }

  // Update total
  const totalElem = document.getElementById('totalAmount');
  if (totalElem) {
    try {
      totalElem.textContent = '‚Çπ' + parseFloat(priceState.total).toLocaleString('en-IN', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
      });
    } catch (err) {
      totalElem.textContent = '‚Çπ' + priceState.total.toFixed(2);
    }
  }

  updateCouponUI();
}

    function updateCouponUI() {
      const couponInput = document.getElementById('couponInput');
      const applyBtn = document.getElementById('applyBtn');
      const removeBtnContainer = document.getElementById('removeCouponContainer');

      if (priceState.appliedCoupon) {
       
        if (couponInput) couponInput.style.display = 'none';
        if (applyBtn) applyBtn.style.display = 'none';
        
        if (removeBtnContainer) {
          removeBtnContainer.innerHTML = `
            <div style="display: flex; align-items: center; gap: 10px; padding: 12px; background: #f0fdf4; border: 1px solid #dcfce7; border-radius: 6px;">
              <span style="flex: 1; color: #166534; font-weight: 500;">
                 ${priceState.appliedCoupon}
              </span>
              <button type="button" id="removeCouponBtn" style="
                background: #ef4444;
                color: white;
                border: none;
                padding: 6px 12px;
                border-radius: 4px;
                cursor: pointer;
                font-size: 14px;
                font-weight: 500;
                transition: background 0.2s;
              " title="Remove coupon">
                 Remove
              </button>
            </div>
          `;

          const removeBtn = document.getElementById('removeCouponBtn');
          if (removeBtn) {
            removeBtn.addEventListener('click', removeCoupon);
            removeBtn.addEventListener('mouseenter', (e) => {
              e.target.style.background = '#dc2626';
            });
            removeBtn.addEventListener('mouseleave', (e) => {
              e.target.style.background = '#ef4444';
            });
          }
        }
      } else {
        // No coupon applied
        if (couponInput) couponInput.style.display = 'block';
        if (applyBtn) applyBtn.style.display = 'block';
        
        if (removeBtnContainer) {
          removeBtnContainer.innerHTML = '';
        }
      }
    }

    function removeCoupon() {
      priceState.discount = 0;
      priceState.appliedCoupon = null;
      priceState.appliedCouponCode = '';

      const couponInput = document.getElementById('couponInput');
      if (couponInput) {
        couponInput.value = '';
        couponInput.focus();
      }

      updateDisplay();

      const successElem = document.getElementById('couponSuccess');
      if (successElem) {
        successElem.classList.remove('show');
      }

      Swal.fire({
        icon: 'success',
        title: 'Coupon Removed',
        text: 'Coupon has been removed successfully',
        confirmButtonColor: '#22c55e',
        timer: 2000,
        showConfirmButton: false
      });
    }

    const applyBtn = document.getElementById('applyBtn');
    const couponInput = document.getElementById('couponInput');

    if (applyBtn && couponInput) {
      applyBtn.addEventListener('click', async () => {
        const code = couponInput.value.trim().toUpperCase();

        if (!code) {
          Swal.fire({
            icon: 'error',
            title: 'Enter Code',
            text: 'Please enter a coupon code',
            confirmButtonColor: '#ef4444'
          });
          return;
        }

        if (priceState.appliedCoupon === code) {
          Swal.fire({
            icon: 'info',
            title: 'Already Applied',
            text: 'This coupon is already applied',
            confirmButtonColor: '#22c55e'
          });
          return;
        }

        applyBtn.disabled = true;
        const originalText = applyBtn.textContent;
        applyBtn.textContent = 'Applying...';

        try {
          const requestData = {
            couponCode: code,
            cartTotal: priceState.subtotal
          };

          const response = await fetch('/coupon/apply', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify(requestData)
          });

          const data = await response.json();

          if (data.success) {
            const discountAmount = data.totalDiscount !== undefined ? data.totalDiscount : data.discount;
            
            priceState.discount = parseFloat(discountAmount) || 0;
            priceState.appliedCoupon = code;
            priceState.appliedCouponCode = code;
            
            updateDisplay();

            const successElem = document.getElementById('couponSuccess');
            if (successElem) {
              successElem.classList.add('show');
            }

            let discountDisplay = '0.00';
            try {
              discountDisplay = parseFloat(priceState.discount).toLocaleString('en-IN', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
              });
            } catch (err) {
              discountDisplay = priceState.discount.toFixed(2);
            }

            Swal.fire({
              icon: 'success',
              title: 'Coupon Applied!',
              html: `You saved <strong>‚Çπ${discountDisplay}</strong>`,
              confirmButtonColor: '#22c55e',
              timer: 2500,
              showConfirmButton: false
            });
          } else {
            Swal.fire({
              icon: 'error',
              title: 'Coupon Error',
              text: data.message || 'Failed to apply coupon',
              confirmButtonColor: '#ef4444'
            });
          }
        } catch (err) {
          Swal.fire({
            icon: 'error',
            title: 'Error',
            text: err.message,
            confirmButtonColor: '#ef4444'
          });
        } finally {
          applyBtn.disabled = false;
          applyBtn.textContent = originalText;
        }
      });

      couponInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          applyBtn.click();
        }
      });
    }

    initPrices();
  });


  // ============================================
 // COUPON MODAL - CHECKOUT PAGE
 // ============================================

 let couponModalData = {
  coupons: [],
  currentPage: 1,
  totalPages: 1,
  loading: false
 };

 // Open coupon modal
 function openCouponModal() {
  const modal = document.getElementById('couponModal');
  if (modal) {
    modal.classList.add('show');
    loadCoupons(1);
  }
 }

 // Close coupon modal
 function closeCouponModal() {
  const modal = document.getElementById('couponModal');
  if (modal) {
    modal.classList.remove('show');
  }
 }

 // Load coupons from API
 async function loadCoupons(page = 1) {
  try {
    couponModalData.loading = true;
    const loadingElem = document.getElementById('couponLoading');
    if (loadingElem) loadingElem.style.display = 'flex';

    const response = await fetch(`/api/coupons?page=${page}&limit=6`);
    const data = await response.json();

    if (data.success) {
      couponModalData.coupons = data.coupons || [];
      couponModalData.currentPage = data.currentPage || 1;
      couponModalData.totalPages = data.totalPages || 1;
      renderCoupons();
      updatePagination();
    } else {
      throw new Error(data.message || 'Failed to load coupons');
    }
  } catch (err) {
    console.error('Error loading coupons:', err);
    const listElem = document.getElementById('couponList');
    if (listElem) {
      listElem.innerHTML = '<p style="text-align: center; color: #ef4444; padding: 20px;">Error loading coupons</p>';
    }
  } finally {
    couponModalData.loading = false;
    const loadingElem = document.getElementById('couponLoading');
    if (loadingElem) loadingElem.style.display = 'none';
  }
 }

 // Render coupons in modal
 function renderCoupons() {
  const listElem = document.getElementById('couponList');
  if (!listElem) return;

  if (couponModalData.coupons.length === 0) {
    listElem.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">No coupons available</p>';
    return;
  }

  listElem.innerHTML = couponModalData.coupons.map(coupon => {
    
    const discountDisplay = coupon.discountType === 'percentage' 
      ? `${coupon.discountValue}%` 
      : `‚Çπ${coupon.discountValue}`;
    
    
    const isDisabled = coupon.status !== 'active' || coupon.userHasUsed;
    const buttonText = coupon.userHasUsed ? 'Already Used' : (coupon.status !== 'active' ? 'Not Available' : '‚úì USE');

    return `
      <div class="coupon-modal-card">
        <div class="coupon-modal-content">
          <div class="coupon-modal-header">
            <h3 class="coupon-modal-title">${coupon.title || coupon.name || 'Special Discount'}</h3>
            <span class="coupon-status ${coupon.status}">${coupon.status.toUpperCase()}</span>
          </div>
          
          <p class="coupon-modal-description">${coupon.description || 'Special discount coupon'}</p>
          
          <div class="coupon-modal-details">
            <div class="detail-item">
              <span class="detail-label">Discount:</span>
              <span class="detail-value">
                ${discountDisplay}
                ${coupon.maxDiscount > 0 ? ` (Max: ‚Çπ${coupon.maxDiscount})` : ''}
              </span>
            </div>
            <div class="detail-item">
              <span class="detail-label">Min Purchase:</span>
              <span class="detail-value">‚Çπ${coupon.minPurchase || '0'}</span>
            </div>
            <div class="detail-item">
              <span class="detail-label">Expires:</span>
              <span class="detail-value">${new Date(coupon.expiryDate).toLocaleDateString('en-IN')}</span>
            </div>
            <div class="detail-item">
              <span class="detail-label">Usage:</span>
              <span class="detail-value">${coupon.used}/${coupon.limit} used</span>
            </div>
          </div>

          <div class="coupon-usage-bar">
            <div class="usage-bar-fill" style="width: ${coupon.usagePercentage}%"></div>
          </div>
        </div>

        <div class="coupon-modal-actions">
          <button class="copy-btn" onclick="copyCouponCode('${coupon.code}')">
            üìã COPY
          </button>
          <button class="use-btn" onclick="applyCouponFromModal('${coupon.code}')" 
                  ${isDisabled ? 'disabled' : ''}>
            ${buttonText}
          </button>
        </div>
      </div>
    `;
  }).join('');
 }

 // Copy coupon code to clipboard
 function copyCouponCode(code) {
  navigator.clipboard.writeText(code).then(() => {
    Swal.fire({
      icon: 'success',
      title: 'Copied!',
      text: `Code "${code}" copied to clipboard`,
      timer: 2000,
      showConfirmButton: false,
      confirmButtonColor: '#22c55e'
    });
  }).catch(err => {
    console.error('Failed to copy:', err);
    Swal.fire({
      icon: 'error',
      title: 'Copy Failed',
      text: 'Could not copy to clipboard',
      confirmButtonColor: '#ef4444'
    });
  });
 }

 // Apply coupon from modal
 function applyCouponFromModal(code) {
  closeCouponModal();
  
  const couponInput = document.getElementById('couponInput');
  if (couponInput) {
    couponInput.value = code;
    
    
    const applyBtn = document.getElementById('applyBtn');
    if (applyBtn) {
      setTimeout(() => applyBtn.click(), 100);
    }
  }
 }

 // Update pagination buttons
 function updatePagination() {
  const prevBtn = document.getElementById('couponPrevBtn');
  const nextBtn = document.getElementById('couponNextBtn');
  const pageInfo = document.getElementById('couponPageInfo');

  if (prevBtn) prevBtn.disabled = couponModalData.currentPage <= 1;
  if (nextBtn) nextBtn.disabled = couponModalData.currentPage >= couponModalData.totalPages;
  if (pageInfo) {
    pageInfo.textContent = `Page ${couponModalData.currentPage} of ${couponModalData.totalPages}`;
  }
 }

 // Pagination handlers
 function couponPrevPage() {
  if (couponModalData.currentPage > 1) {
    loadCoupons(couponModalData.currentPage - 1);
  }
 }

 function couponNextPage() {
  if (couponModalData.currentPage < couponModalData.totalPages) {
    loadCoupons(couponModalData.currentPage + 1);
  }
 }

 // Initialize modal on page load
 document.addEventListener('DOMContentLoaded', function() {
  
  const modal = document.getElementById('couponModal');
  if (modal) {
    modal.addEventListener('click', (e) => {
      if (e.target === modal) {
        closeCouponModal();
      }
    });
  }
 
  const viewCouponLink = document.querySelector('.coupon-view-link a');
  if (viewCouponLink) {
    viewCouponLink.addEventListener('click', (e) => {
      e.preventDefault();
      openCouponModal();
    });
  }
 });




// ======================== CHECKOUT PAGE FLOW ========================

async function handleCheckoutSubmit() {
  console.log('üìã Step 1: Validating checkout data');
  
  try {
    const addressId = document.getElementById('selectedAddress').value;
    const paymentMethod = document.querySelector('input[name="paymentMethod"]:checked').value;
    const couponCode = document.getElementById('couponCode')?.value;

    if (!addressId) {
      Swal.fire('Error', 'Please select an address', 'error');
      return;
    }

    if (!paymentMethod) {
      Swal.fire('Error', 'Please select a payment method', 'error');
      return;
    }

    const checkoutResponse = await fetch('/order/place', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      credentials: 'include',
      body: JSON.stringify({
        addressId,
        paymentMethod,
        couponCode: couponCode || null
      })
    });

    if (!checkoutResponse.ok) {
      const error = await checkoutResponse.json();
      Swal.fire('Error', error.message, 'error');
      return;
    }

    const checkoutData = await checkoutResponse.json();
    console.log(' Checkout validated:', checkoutData);

    // Proceed based on payment method
    if (paymentMethod === 'razorpay') {
      await initiateRazorpayPayment();
    } else if (paymentMethod === 'cod') {
      // COD: Create order directly
      window.location.href = '/orderSuccess?orderId=<orderId>';
    } else if (paymentMethod === 'wallet') {
      // Wallet: Create order directly
      window.location.href = '/orderSuccess?orderId=<orderId>';
    }

  } catch (error) {
    console.error(' Checkout error:', error);
    Swal.fire('Error', error.message, 'error');
  }
}

// ======================== RAZORPAY PAYMENT FLOW ========================

async function initiateRazorpayPayment() {
  console.log('üí≥ Step 2: Initiating Razorpay payment');

  try {
    Swal.fire({
      title: 'Processing...',
      html: 'Creating payment order',
      allowOutsideClick: false,
      didOpen: () => Swal.showLoading()
    });

    // If server reads session.checkoutData, send empty body or nothing
    const resp = await fetch('/payment/create-razorpayOrder', {
      method: 'POST',
      credentials: 'include',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({}) 
    });

    if (!resp.ok) {
      const txt = await resp.text().catch(() => null);
      throw new Error(txt || `Failed to create payment order (${resp.status})`);
    }

    const orderData = await resp.json();

    if (!orderData.success || !orderData.keyId || !orderData.orderId) {
      throw new Error(orderData.message || 'Invalid payment configuration');
    }

    Swal.close();
    openRazorpayModal(orderData);

  } catch (error) {
    console.error(' Error initiating payment:', error);
    Swal.fire('Error', error.message || 'Failed to initiate payment', 'error');
  }
}

function openRazorpayModal(orderData) {
  console.log(' Opening Razorpay modal');

  const options = {
    key: orderData.keyId,
    amount: orderData.amount,
    currency: orderData.currency,
    name: 'Sentique',
    description: 'Order Payment',
    order_id: orderData.orderId,
    
    // Success Handler
    handler: async (response) => {
      console.log(' Payment successful! Verifying...');
      await verifyPayment(
        response.razorpay_order_id,
        response.razorpay_payment_id,
        response.razorpay_signature
      );
    },

    theme: { color: '#22c55e' },

    modal: {
      
      ondismiss: async () => {
        console.log('‚ö† User closed payment modal');
        
        // 1. Show loading while we save the failed order
        Swal.fire({
          title: 'Cancelling...',
          text: 'Recording payment status',
          allowOutsideClick: false,
          didOpen: () => Swal.showLoading()
        });

        try {
          // 2. Call backend to create the "Failed" order
          const response = await fetch('/payment/payment-failure', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({
              razorpay_order_id: orderData.orderId,
              error_description: 'Payment cancelled by user',
              error_code: 'USER_CANCELLED'
            })
          });

          const data = await response.json();
          console.log("üõë Failure recorded:", data);
          
          Swal.close();

        
          if (data.success && data.orderId) {
             window.location.href = `/orderFailure?orderId=${data.orderId}`;
          } else {
            
             console.error("No orderId returned from failure endpoint");
             window.location.href = `/orderFailure?error=PaymentCancelled`;
          }

        } catch (err) {
          console.error('Error in ondismiss:', err);
          window.location.href = '/orderFailure?error=UnknownError';
        }
      }
    }
  };

  const rzp = new Razorpay(options);

  // Handle Bank Declines / Network Failures
  rzp.on('payment.failed', async (response) => {
    console.log(' Payment failed event:', response.error);
    await handlePaymentFailure(response.error);
  });

  rzp.open();
}

// ======================== VERIFY PAYMENT ========================

async function verifyPayment(razorpayOrderId, razorpayPaymentId, razorpaySignature) {
  console.log(' Step 3: Verifying payment');

  Swal.fire({
    title: 'Verifying Payment...',
    html: 'Please wait',
    allowOutsideClick: false,
    didOpen: () => Swal.showLoading()
  });

  try {
   
    const verifyResponse = await fetch('/payment/verify-razorpay-payment', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      credentials: 'include',
      body: JSON.stringify({
        razorpay_order_id: razorpayOrderId,
        razorpay_payment_id: razorpayPaymentId,
        razorpay_signature: razorpaySignature
      })
    });

    const verifyData = await verifyResponse.json();
   

    if (verifyData.success) {
      console.log(' Payment verified successfully!');
      Swal.fire({
        icon: 'success',
        title: 'Payment Successful!',
        html: `<p>Order ID: <strong>${verifyData.orderNumber || verifyData.orderId}</strong></p>`,
        confirmButtonText: 'View Order',
        confirmButtonColor: '#22c55e',
        allowOutsideClick: false
      }).then(() => {
        
        window.location.href = `/orderSuccess?orderId=${verifyData.orderId}`;
      });
    } else {
      throw new Error(verifyData.message || 'Verification failed');
    }

  } catch (error) {
    console.error(' Verification error:', error);
    Swal.fire({
      icon: 'error',
      title: 'Verification Failed',
      text: error.message,
      confirmButtonColor: '#ef4444'
    });
  }
}

// ======================== HANDLE PAYMENT FAILURE ========================

async function handlePaymentFailure(error) {
  console.log(' Step 4: Handling payment failure');

  try {
    // Record failure in database
    const failureResponse = await fetch('/payment/payment-failure', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      credentials: 'include',
      body: JSON.stringify({
        razorpay_order_id: error.metadata?.order_id || 'unknown',
        error_description: error.description,
        error_code: error.code
      })
    });

    const failureData = await failureResponse.json();
    console.log(' Failure recorded. Order ID:', failureData.orderId);

    // Show failure page
    window.location.href = `/orderFailure?orderId=${failureData.orderId}&error=${error.code}`;

  } catch (err) {
    console.error('Error recording failure:', err);
    window.location.href = '/orderFailure';
  }
}

// ======================== ORDER LIST PAGE - SHOW FAILED ORDERS ========================

async function loadOrders() {
  try {
    const response = await fetch('/profile/order-list', {
      credentials: 'include'
    });

    const data = await response.json();
    
    if (!data.success) {
      console.error('Error loading orders:', data.message);
      return;
    }

    const ordersContainer = document.getElementById('ordersContainer');
    ordersContainer.innerHTML = '';

    data.orders.forEach(order => {
      const orderCard = document.createElement('div');
      orderCard.className = 'order-card';
      
      // Show retry button if payment failed
      const retryButton = order.paymentStatus === 'Failed' 
        ? `<button class="retry-btn" onclick="retryFailedOrder('${order._id}')">Retry Payment</button>`
        : '';

      orderCard.innerHTML = `
        <div class="order-header">
          <span>Order #${order._id}</span>
          <span class="status" data-status="${order.paymentStatus}">
            Payment: ${order.paymentStatus}
          </span>
        </div>
        <div class="order-body">
          <p>Items: ${order.items.length}</p>
          <p>Amount: ‚Çπ${order.finalAmount}</p>
          <p>Order Status: ${order.status}</p>
        </div>
        <div class="order-footer">
          ${retryButton}
          <button onclick="viewOrderDetails('${order._id}')">View Details</button>
        </div>
      `;

      ordersContainer.appendChild(orderCard);
    });

  } catch (error) {
    console.error('Error loading orders:', error);
  }
}

// ======================== RETRY FAILED ORDER PAYMENT ========================

async function retryFailedOrder(orderId) {
  console.log(' Retrying payment for order:', orderId);

  try {
    Swal.fire({
      title: 'Processing...',
      html: 'Preparing order for retry',
      allowOutsideClick: false,
      didOpen: () => Swal.showLoading()
    });

    // Prepare failed order for retry
    const retryResponse = await fetch('/payment/retry-failed-order', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      credentials: 'include',
      body: JSON.stringify({ orderId })
    });

    const retryData = await retryResponse.json();
    

    Swal.close();
    
    
    await initiateRazorpayPayment();

  } catch (error) {
    console.error(' Retry error:', error);
    Swal.fire('Error', error.message, 'error');
  }
}



document.addEventListener('DOMContentLoaded', function() {
    
    const savedTheme = localStorage.getItem('sentique-theme');
    if (savedTheme === 'dark') {
      document.body.classList.add('dark-mode');
    }
  
    const observer = new MutationObserver((mutations) => {
      mutations.forEach((mutation) => {
        if (mutation.attributeName === 'class') {
          const isDarkMode = document.body.classList.contains('dark-mode');
          localStorage.setItem('sentique-theme', isDarkMode ? 'dark' : 'light');
        }
      });
    });

    observer.observe(document.body, {
      attributes: true,
      attributeFilter: ['class']
    });
  });
</script>

</body>

</html>
