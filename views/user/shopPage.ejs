<%- include("../partials/user/header.ejs") %>

<style>
  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
  }

  body, html {
    width: 100%;
    margin: 0;
    padding: 0;
    overflow-x: hidden;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background-color: #f8f9fa;
  }

  .site-wrapper {
    max-width: 1400px;
    margin: 0 auto; 
    padding: 20px;
    min-height: 100vh;
  }

  .layout {
    display: flex;
    gap: 30px;
    align-items: flex-start;
    margin-top: 20px;
  }

  .shop-search-bar { 
    margin: 20px auto 10px auto; 
    display: flex; 
    justify-content: center; 
    position: relative; 
    z-index: 1001; 
    width: 100%;
    padding: 0 20px;
  }
  
  .search-container { width: 100%; max-width: 600px; position: relative; }
  .shop-search-form { width: 100%; position: relative; }
  
  .shop-search-input {
    width: 100%; padding: 14px 50px 14px 20px; border-radius: 50px;
    border: 1px solid #ddd; font-size: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.03);
    transition: 0.3s; background: white;
  }
  .shop-search-input:focus { outline: none; border-color: #667eea; box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.15); }
  .shop-search-btn { position: absolute; right: 15px; top: 50%; transform: translateY(-50%); border: none; background: none; cursor: pointer; color: #555; }
  .shop-reset-btn { position: absolute; right: 45px; top: 50%; transform: translateY(-50%); border: none; background: none; cursor: pointer; color: #ef4444; }

  .filters {
    width: 280px;
    background: #eceaea;
    border-radius: 12px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    overflow: hidden;
    border: 1px solid #e2e8f0;
    height: fit-content;
    position: sticky;
    top: 20px;
    flex-shrink: 0;
  }

  .filter-header {
    background: linear-gradient(135deg, #070707 0%, #080708 100%);
    color: white; padding: 20px 24px; border-bottom: 1px solid #e2e8f0;
  }
  .filter-header h4 { font-size: 18px; font-weight: 600; margin: 0; display: flex; align-items: center; gap: 8px; }

  .filter-content { padding: 24px; max-height: 70vh; overflow-y: auto; }
  .filter-content::-webkit-scrollbar { width: 4px; }
  .filter-content::-webkit-scrollbar-track { background: #f1f5f9; }
  .filter-content::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }

  .filter-section { margin-bottom: 28px; }
  .filter-section:last-child { margin-bottom: 0; }

  .filter-section h5 {
    font-size: 14px; font-weight: 600; color: #374151; margin-bottom: 16px;
    text-transform: uppercase; letter-spacing: 0.5px; display: flex; align-items: center;
    gap: 8px; padding-bottom: 8px; border-bottom: 2px solid #bdbebe;
  }
  .filter-section h5::before {
    content: ''; width: 4px; height: 16px;
    background: linear-gradient(135deg, #ea6666 0%, #a24b4b 100%); border-radius: 2px;
  }

  .filter-options { display: flex; flex-direction: column; gap: 2px; }
  
  .filter-option label {
    display: flex; align-items: center; cursor: pointer; font-size: 14px; color: #635e4b;
    padding: 8px 12px; border-radius: 8px; transition: all 0.2s ease;
    user-select: none; margin: 0;
  }
  .filter-option label:hover { background-color: #f8fafc; color: #37361f; transform: translateX(2px); }

  .filter-option input[type="checkbox"], .filter-option input[type="radio"] {
    width: 18px; height: 18px; margin-right: 12px; cursor: pointer; position: relative;
    appearance: none; border: 2px solid #d1d5db; border-radius: 4px; background: white;
    transition: all 0.2s ease; flex-shrink: 0;
  }
  .filter-option input[type="radio"] { border-radius: 50%; }
  
  .filter-option input:checked {
    background: linear-gradient(135deg, #1b0f0f 0%, #322214 100%); border-color: #e8c2ad; transform: scale(1.1);
  }
  .filter-option input[type="checkbox"]:checked::after {
    content: '✓'; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: white; font-size: 12px; font-weight: bold;
  }
  .filter-option input[type="radio"]:checked::after {
    content: ''; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 8px; height: 8px; background: white; border-radius: 50%;
  }

  .price-range-section { background: #ececed; border-radius: 8px; padding: 16px; margin-top: 8px; }
  .filter-actions { padding: 20px 24px; border-top: 1px solid #e2e8f0; background: #eeeff0; display: flex; gap: 12px; }

  .btn {
    padding: 12px 20px; border-radius: 8px; font-size: 14px; font-weight: 500; cursor: pointer;
    border: none; transition: all 0.2s ease; text-decoration: none; display: inline-flex;
    align-items: center; justify-content: center; gap: 8px; flex: 1;
  }
  .btn-primary { background: linear-gradient(135deg, #626362 0%, #363636 100%); color: white; box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3); }
  .btn-primary:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4); }
  .btn-secondary { background: white; color: #6b7280; border: 1px solid #d1d5db; }
  .btn-secondary:hover { background: #f9fafb; border-color: #9ca3af; transform: translateY(-1px); }

  .products { flex: 1; width: 100%; }
  .sort-bar { display: flex; justify-content: flex-end; margin-bottom: 20px; }
  .sort-bar select { min-width: 170px; padding: 10px 14px; border-radius: 6px; border: 1px solid #ccc; background: #fff; }

  /* === STANDARD 3D PRODUCT GRID === */
  .product-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr); 
    gap: 25px;
    margin-bottom: 40px;
  }

  .product-card {
    border: 1px solid #e5e5e5;
    border-radius: 12px;
    overflow: hidden;
    display: flex;
    flex-direction: column;
    background: #fff;
    height: 100%;
    position: relative;
    transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
    cursor: pointer;
  }

  .product-card:hover {
    box-shadow: 0 10px 25px rgba(0,0,0,0.1);
    transform: translateY(-5px);
  }

  .image-wrap {
    width: 100%;
    padding-top: 100%;
    position: relative;
    overflow: hidden;
    background: #f4f4f4;
  }

  .image-wrap img {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform 0.5s ease, opacity 0.5s ease;
  }

  .image-wrap .primary-img {
    opacity: 1;
    z-index: 1;
  }

  .image-wrap .secondary-img {
    opacity: 0;
    z-index: 0;
    position: absolute;
    top: 0;
    left: 0;
  }

  .product-card:hover .image-wrap .primary-img {
    opacity: 0;
    transform: scale(1.08);
  }

  .product-card:hover .image-wrap .secondary-img {
    opacity: 1;
    transform: scale(1.08);
  }

  .product-icons {
    position: absolute;
    top: 10px;
    right: 10px;
    z-index: 10;
  }

  .wishlist-icon {
    width: 36px;
    height: 36px;
    background: rgba(255,255,255,0.95);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #ccc;
    font-size: 18px;
    transition: all 0.2s;
    cursor: pointer;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  }

  .wishlist-icon:hover {
    color: #ef4444;
    background: #fff;
    transform: scale(1.1);
  }

  .product-body {
    padding: 15px;
    display: flex;
    flex-direction: column;
    gap: 8px;
    flex: 1;
  }

  .product-body h5 {
    margin: 0;
    font-size: 15px;
    line-height: 1.4;
    font-weight: 600;
    color: #333;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .product-meta {
    margin-top: auto;
    display: flex;
    flex-direction: column;
    gap: 4px;
  }

  .product-meta div {
    font-size: 13px;
    color: #555;
  }

  .price {
    font-weight: 700;
    font-size: 17px;
    color: #e6623a;
  }

  .old-price {
    text-decoration: line-through;
    color: #888;
    font-size: 13px;
    margin-left: 8px;
  }

  .offer-badge {
    position: absolute;
    top: 12px;
    left: 12px;
    background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);
    color: white;
    padding: 4px 10px;
    border-radius: 4px;
    font-size: 11px;
    font-weight: bold;
    z-index: 10;
    box-shadow: 0 4px 10px rgba(255, 107, 107, 0.3);
  }

  .pagination {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 8px;
    margin-top: 50px;
    padding-top: 20px;
    border-top: 1px solid #f0f0f0;
    list-style: none;
  }

  .page-link {
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    background: #fff;
    border: 1px solid #e2e8f0;
    color: #64748b;
    font-weight: 600;
    font-size: 14px;
    text-decoration: none;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }

  .page-link:hover {
    background: #f8fafc;
    border-color: #cbd5e1;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.05);
    color: #0f172a;
  }

  .page-item.active .page-link {
    background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
    color: white;
    border-color: transparent;
    box-shadow: 0 4px 12px rgba(15, 23, 42, 0.3);
    transform: scale(1.05);
  }

  .search-results-dropdown {
    position: absolute;
    top: 110%;
    left: 0;
    right: 0;
    background: white;
    border-radius: 12px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.15);
    border: 1px solid #eee;
    max-height: 400px;
    overflow-y: auto;
    display: none;
    z-index: 2000;
  }

  .search-result-item {
    display: flex;
    align-items: center;
    padding: 12px 15px;
    border-bottom: 1px solid #f5f5f5;
    text-decoration: none;
    color: #333;
    transition: background 0.2s;
  }

  .search-result-item:last-child { border-bottom: none; }
  .search-result-item:hover { background: #f8f9fa; }

  .search-result-img {
    width: 45px;
    height: 45px;
    border-radius: 6px;
    object-fit: cover;
    margin-right: 15px;
    border: 1px solid #eee;
  }

  .search-result-info h6 {
    margin: 0;
    font-size: 14px;
    font-weight: 600;
    color: #333;
  }

  .search-result-info span {
    font-size: 13px;
    color: #e6623a;
    font-weight: 700;
  }

  .filters-toggle {
    display: none;
    width: 100%;
    margin-bottom: 20px;
    background: #1e293b;
    color: white;
    border: none;
    padding: 14px;
    border-radius: 8px;
    font-weight: 600;
    cursor: pointer;
  }

  .filter-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 999; }

  @media (max-width: 1200px) { .product-grid { grid-template-columns: repeat(3, 1fr); } }
  @media (max-width: 991px) { .filters { width: 220px; } .product-grid { gap: 15px; } }
  @media (max-width: 768px) {
    .layout { display: block; }
    .filters { position: fixed; top: 0; left: -100%; width: 85%; height: 100vh; z-index: 1000; transition: left 0.3s; border-radius: 0; }
    .filters.show { left: 0; }
    .filters-toggle { display: block; }
    .filter-overlay.show { display: block; }
    .product-grid { grid-template-columns: repeat(2, 1fr); gap: 10px; }
    .site-wrapper { padding: 0 15px; margin-top: 20px; }
    .shop-search-bar { padding: 0 10px; margin-bottom: 15px; }
  }

  .toast-container { position: fixed; top: 20px; right: 20px; z-index: 9999; }
  .toast { background: white; padding: 15px; border-radius: 10px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); margin-bottom: 10px; display: flex; align-items: center; gap: 10px; animation: fadeIn 0.3s; border-left: 4px solid #333; }
  .toast.success { border-color: #22c55e; } .toast.success i { color: #22c55e; }
  .toast.info { border-color: #3b82f6; } .toast.info i { color: #3b82f6; }
  @keyframes fadeIn { from{opacity:0; transform:translateX(20px);} to{opacity:1; transform:translateX(0);} }

  /* DARK MODE */
  .dark-mode body, .dark-mode html, .dark-mode .site-wrapper { background-color: #0d0d0d !important; }
  .dark-mode .filters { background: #1a1a1a !important; border-color: #333 !important; }
  .dark-mode .filter-header { background: #000 !important; color: #fff !important; }
  .dark-mode .filter-section h5 { color: #fff !important; border-color: #444 !important; }
  .dark-mode .filter-section h5::before { background: linear-gradient(135deg, #d4af37 0%, #f0d978 100%) !important; }
  .dark-mode .price-range-section { background: #222 !important; }
  .dark-mode .filter-option label { color: #ccc !important; }
  .dark-mode .filter-option label:hover { background: #333 !important; color: #fff !important; }
  .dark-mode .filter-option input { border-color: #666 !important; background: #222 !important; }
  .dark-mode .filter-option input:checked { background: linear-gradient(135deg, #d4af37 0%, #f0d978 100%) !important; border-color: #d4af37 !important; }
  .dark-mode .filter-actions { background: #222 !important; border-color: #444 !important; }
  .dark-mode .btn-primary { background: linear-gradient(135deg, #d4af37 0%, #f0d978 100%) !important; color: #000 !important; }
  .dark-mode .btn-primary:hover { box-shadow: 0 4px 12px rgba(212, 175, 55, 0.4) !important; }
  .dark-mode .btn-secondary { background: #333 !important; color: #ccc !important; border-color: #555 !important; }
  .dark-mode .btn-secondary:hover { background: #444 !important; border-color: #666 !important; color: #fff !important; }
  .dark-mode .shop-search-input { background: #222 !important; color: #fff !important; border-color: #444 !important; }
  .dark-mode .shop-search-input:focus { border-color: #d4af37 !important; box-shadow: 0 0 0 4px rgba(212, 175, 55, 0.15) !important; }
  .dark-mode .product-card { background: #1a1a1a !important; border-color: #333 !important; }
  .dark-mode .product-card:hover { box-shadow: 0 10px 25px rgba(212, 175, 55, 0.2) !important; }
  .dark-mode .image-wrap { background: #222 !important; }
  .dark-mode .wishlist-icon { background: rgba(0, 0, 0, 0.8) !important; color: #ccc !important; }
  .dark-mode .wishlist-icon:hover { color: #d4af37 !important; background: rgba(212, 175, 55, 0.1) !important; }
  .dark-mode .offer-badge { background: linear-gradient(135deg, #d4af37 0%, #f0d978 100%) !important; box-shadow: 0 4px 10px rgba(212, 175, 55, 0.4) !important; color: #000 !important; }
  .dark-mode .product-body { background: #1a1a1a !important; }
  .dark-mode .product-body h5, .dark-mode .product-meta div { color: #fff !important; }
  .dark-mode .product-meta div strong { color: #ccc !important; }
  .dark-mode .price { color: #d4af37 !important; }
  .dark-mode .old-price { color: #bbb !important; }
  .dark-mode .sort-bar select { background: #222 !important; color: #fff !important; border-color: #444 !important; }
  .dark-mode .search-results-dropdown { background: #1e1e1e !important; border-color: #444 !important; }
  .dark-mode .search-result-item { color: #fff !important; border-bottom-color: #333 !important; }
  .dark-mode .search-result-item:hover { background: #333 !important; }
  .dark-mode .search-result-info h6 { color: #fff !important; }
  .dark-mode .search-result-info span { color: #d4af37 !important; }
  .dark-mode .pagination { border-top-color: #333 !important; }
  .dark-mode .page-link { background: #111 !important; color: #ccc !important; border-color: #333 !important; }
  .dark-mode .page-link:hover { background: #222 !important; border-color: #444 !important; color: #fff !important; }
  .dark-mode .page-item.active .page-link { background: linear-gradient(135deg, #d4af37 0%, #f0d978 100%) !important; color: #000 !important; }
  .dark-mode .filters-toggle { background: #333 !important; color: #fff !important; }
  .dark-mode .toast { background: #222 !important; color: #fff !important; border-left-color: #d4af37 !important; }

  /* PRODUCT RATING */
.rating {
  display: flex;
  align-items: center;
  gap: 4px;
  font-size: 14px;
}

.rating i {
  color: #facc15; 
}

.rating .empty {
  color: #d1d5db;
}

.rating-count {
  font-size: 12px;
  color: #6b7280;
  margin-left: 6px;
}

/* DARK MODE */
.dark-mode .rating i {
  color: #d4af37;
}

.dark-mode .rating .empty {
  color: #555;
}

.dark-mode .rating-count {
  color: #aaa;
}

@media (max-width: 768px) {
  .shop-search-bar {
    position: relative;
    z-index: 10; 
  }
}

@media (max-width: 768px) {
  .mobile-nav {
    text-align: center;
  }

  .mobile-nav a {
    padding: 14px 0;
    font-size: 15px;
    font-weight: 500;
  }
}

@media (max-width: 768px) {
  .mobile-nav {
    position: fixed;
    top: 60px;         
    left: 0;
    width: 100%;
    background: var(--bg-nav);
    z-index: 3000;        
  }
}


</style>

<body>

  <div class="shop-search-bar">
    <div class="search-container">
      <form method="GET" action="/shopPage" class="shop-search-form"
        autocomplete="off">

        <!-- SEARCH -->
        <input type="text" name="search" placeholder="Search products..."
          value="<%= search || '' %>" class="shop-search-input"
          id="liveSearchInput">

        <!-- PRESERVE CATEGORY -->
        <% if(selectedCategories) selectedCategories.forEach(c => { %>
        <input type="hidden" name="categorys" value="<%= c %>">
        <% }) %>

        <!-- PRESERVE BRANDS -->
        <% if(selectedBrands) selectedBrands.forEach(b => { %>
        <input type="hidden" name="brands" value="<%= b %>">
        <% }) %>

        <!-- PRESERVE PRICE -->
        <% if(priceRange) { %>
        <input type="hidden" name="priceRange" value="<%= priceRange %>">
        <% } %>

        <% if(sort) { %>
        <input type="hidden" name="sort" value="<%= sort %>">
        <% } %>

        <button type="submit" class="shop-search-btn"><i
            class="fa fa-search"></i></button>

      </form>

      <div id="searchResults" class="search-results-dropdown"></div>
    </div>
  </div>

  <div class="site-wrapper">
    <button id="toggleFilters" class="filters-toggle"><i
        class="fa fa-filter"></i> Show Filters</button>
    <div id="filterOverlay" class="filter-overlay"></div>

    <div class="layout">
      <aside id="filters" class="filters">
        <div class="filter-header">
          <h4><i class="fa fa-filter"></i> Filters</h4>
          <i class="fa fa-times" id="closeFilter"
            style="margin-left:auto; cursor:pointer; display:none;"></i>
        </div>
        <div class="filter-content">
          <form id="filterForm" method="GET">
            <div class="filter-section">
              <h5>Category</h5>
              <div class="filter-options">
                <% categories.forEach(cat => { %>
                <div class="filter-option">
                  <label>
                    <input type="checkbox" name="categorys"
                      value="<%= cat._id %>"
                      <%=selectedCategories.includes(cat._id.toString()) ?
                      "checked" : "" %>>
                    <%= cat.name %>
                  </label>
                </div>
                <% }) %>
              </div>
            </div>
            <div class="filter-section">
              <h5>Brands</h5>
              <div class="filter-options">
                <% brands.forEach(brand => { %>
                <div class="filter-option">
                  <label>
                    <input type="checkbox" name="brands"
                      value="<%= brand._id %>" <%=selectedBrands &&
                      selectedBrands.includes(brand._id.toString()) ? "checked"
                      : "" %>>
                    <%= brand.brandName %>
                  </label>
                </div>
                <% }) %>
              </div>
            </div>
            <div class="filter-section">
              <h5>Price Range</h5>
              <div class="price-range-section">
                <div class="filter-option"><label><input type="radio"
                      name="priceRange" value="below1000"
                      <%=priceRange==='below1000'?'checked':'' %>> Below
                    ₹1,000</label></div>
                <div class="filter-option"><label><input type="radio"
                      name="priceRange" value="1000-2000"
                      <%=priceRange==='1000-2000'?'checked':'' %>> ₹1,000 -
                    ₹2,000</label></div>
                <div class="filter-option"><label><input type="radio"
                      name="priceRange" value="2000-3000"
                      <%=priceRange==='2000-3000'?'checked':'' %>> ₹2,000 -
                    ₹3,000</label></div>
                <div class="filter-option"><label><input type="radio"
                      name="priceRange" value="above5000"
                      <%=priceRange==='above5000'?'checked':'' %>> Above
                    ₹5,000</label></div>
                <div class="filter-option"><label><input type="radio"
                      name="priceRange" value <%=!priceRange?'checked':'' %>>
                    All Prices</label></div>
              </div>
            </div>
          </form>
        </div>
        <div class="filter-actions">
          <button type="button" class="btn btn-secondary"
            onclick="window.location.href='/shopPage'">Clear</button>
          <button type="submit" form="filterForm"
            class="btn btn-primary">Apply</button>
        </div>
      </aside>

      <main class="products">
        <div class="sort-bar">
          <form method="GET">
            <% if(selectedCategories) selectedCategories.forEach(c => { %><input
              type="hidden" name="categorys" value="<%= c %>"><% }) %>
            <% if(selectedBrands) selectedBrands.forEach(b => { %><input
              type="hidden" name="brands" value="<%= b %>"><% }) %>
            <% if(priceRange) { %><input type="hidden" name="priceRange"
              value="<%= priceRange %>"><% } %>
            <% if(search) { %><input type="hidden" name="search"
              value="<%= search %>"><% } %>
            <select name="sort" onchange="this.form.submit()">
              <option value>Sort By</option>
              <option value="newest" <%=sort==='newest'?'selected':''
                %>>Newest</option>
              <option value="priceLow" <%=sort==='priceLow'?'selected':''
                %>>Price: Low to High</option>
              <option value="priceHigh" <%=sort==='priceHigh'?'selected':''
                %>>Price: High to Low</option>
              <option value="nameAZ" <%=sort==='nameAZ'?'selected':'' %>>Name: A
                - Z</option>
              <option value="nameZA" <%=sort==='nameZA'?'selected':'' %>>Name: Z
                - A</option>
            </select>
          </form>
        </div>

        <section class="product-grid">
          <% if (products && products.length > 0) { %>
          <% products.forEach(product => { %>
          <article class="product-card">
            <div class="image-wrap">
              <a href="/productDetails?id=<%= product._id %>">
                <img
                  src="<%= (product.images && product.images.length > 0) ? product.images[0] : '/images/placeholder.jpg' %>"
                  alt="<%= product.productName %>" class="primary-img">
                <img
                  src="<%= (product.images && product.images.length > 1) ? product.images[1] : product.images[0] %>"
                  alt="<%= product.productName %>" class="secondary-img">
              </a>
            </div>

            <div class="product-icons">
              <div class="wishlist-icon" data-id="<%= product._id %>">
                <i class="fa fa-heart"></i>
              </div>
            </div>

            <%
            let discount = 0;
            if (product.regularPrice > product.salePrice) {
            discount = Math.round(((product.regularPrice - product.salePrice) /
            product.regularPrice) * 100);
            }
            %>
            <% if (discount > 0) { %>
            <div class="offer-badge"><%= discount %>% OFF</div>
            <% } %>

            <div class="product-body">
              <h5><%= product.productName %></h5>
              <div class="product-meta">
                <div><strong>Brand:</strong> <%= product.brand ?
                  product.brand.brandName : "N/A" %></div>
                <div><strong>Category:</strong> <%= product.category ?
                  product.category.name : "N/A" %></div>
                <div style="display:flex; flex-direction:column; gap:6px;">

                  <!-- PRICE (UNCHANGED LOGIC) -->
                  <div>
                    <span class="price">₹<%= product.salePrice %></span>
                    <% if(product.regularPrice > product.salePrice){ %>
                    <span class="old-price">₹<%= product.regularPrice %></span>
                    <% } %>
                  </div>

                  <div class="rating">
                    <%
                    let rating = product.averageRating || 0;
                    let fullStars = Math.floor(rating);
                    let halfStar = rating % 1 >= 0.5;
                    let emptyStars = 5 - fullStars - (halfStar ? 1 : 0);
                    %>

                    <% for(let i = 0; i < fullStars; i++) { %>
                    <i class="fa fa-star"></i>
                    <% } %>

                    <% if(halfStar) { %>
                    <i class="fa fa-star-half-alt"></i>
                    <% } %>

                    <% for(let i = 0; i < emptyStars; i++) { %>
                    <i class="fa fa-star empty"></i>
                    <% } %>

                    <span class="rating-count">
                      (<%= product.totalReviews || 0 %>)
                    </span>
                  </div>

                </div>

              </div>
            </div>
          </article>
          <% }) %>
          <% } else { %>
          <div style="grid-column: 1/-1; text-align: center; padding: 50px;">
            <h3>No Products Found</h3>
          </div>
          <% } %>
        </section>

        <nav>
          <ul class="pagination">
            <% if (currentPage > 1) { %>
            <li class="page-item">
              <a class="page-link"
                href="?page=<%= currentPage-1 %>&sort=<%= sort %>">
                <i class="fa fa-chevron-left" style="font-size:12px;"></i>
              </a>
            </li>
            <% } %>
            <% for (let i=1; i<=totalPages; i++) { %>
            <li class="page-item <%= i===currentPage?'active':'' %>">
              <a class="page-link" href="?page=<%= i %>&sort=<%= sort %>"><%= i
                %></a>
            </li>
            <% } %>
            <% if (currentPage < totalPages) { %>
            <li class="page-item">
              <a class="page-link"
                href="?page=<%= currentPage+1 %>&sort=<%= sort %>">
                <i class="fa fa-chevron-right" style="font-size:12px;"></i>
              </a>
            </li>
            <% } %>
          </ul>
        </nav>
      </main>
    </div>
  </div>

  <script>
  const searchInput = document.getElementById('liveSearchInput');
  const resultsContainer = document.getElementById('searchResults');

  searchInput.addEventListener('keyup', async (e) => {
    const query = e.target.value.trim();
    if (query.length === 0) {
        resultsContainer.style.display = 'none';
        resultsContainer.innerHTML = '';
        return;
    }
    try {
        const response = await fetch(`/api/search?query=${query}`);
        const data = await response.json();
        if (data.success && data.results.length > 0) {
            const html = data.results.map(product => `
                <a href="/productDetails?id=${product.id}" class="search-result-item">
                    <img src="${product.image}" class="search-result-img" alt="${product.name}">
                    <div class="search-result-info">
                        <h6>${product.name}</h6>
                        <span>₹${product.price}</span>
                    </div>
                </a>
            `).join('');
            resultsContainer.innerHTML = html;
            resultsContainer.style.display = 'block';
        } else {
            resultsContainer.innerHTML = '<div style="padding:15px; text-align:center; color:#666;">No products found</div>';
            resultsContainer.style.display = 'block';
        }
    } catch (error) {
        console.error("Search Error:", error);
    }
  });

  document.addEventListener('click', (e) => {
    if (!searchInput.contains(e.target) && !resultsContainer.contains(e.target)) {
        resultsContainer.style.display = 'none';
    }
  });

  const filters = document.getElementById('filters');
  const overlay = document.getElementById('filterOverlay');
  const closeBtn = document.getElementById('closeFilter');
  
  document.getElementById('toggleFilters').addEventListener('click', () => {
    filters.classList.add('show');
    overlay.classList.add('show');
    closeBtn.style.display = 'block';
  });

  function closeFilters() {
    filters.classList.remove('show');
    overlay.classList.remove('show');
    closeBtn.style.display = 'none';
  }

  overlay.addEventListener('click', closeFilters);
  closeBtn.addEventListener('click', closeFilters);

  function showToast(type, msg) {
    let box = document.createElement('div');
    box.className = `toast ${type}`;
    box.innerHTML = `<i class="fa ${type==='success'?'fa-check-circle':'fa-info-circle'}"></i> <span>${msg}</span>`;
    let container = document.getElementById('toastContainer') || document.createElement('div');
    container.id = 'toastContainer'; container.className = 'toast-container';
    document.body.appendChild(container);
    container.appendChild(box);
    setTimeout(() => box.remove(), 3000);
  }

  document.addEventListener('click', async (e) => {
    let btn = e.target.closest('.wishlist-icon');
    if(btn) {
      let id = btn.dataset.id;
      try {
        let res = await fetch('/wishlist/add', {
           method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({productId:id})
        });
        let data = await res.json();
        if(data.success) {
            btn.querySelector('i').style.color = 'red';
            showToast('success', 'Added to Wishlist');
        } else {
            showToast('info', 'Already in Wishlist');
        }
      } catch(e) { console.log(e); }
    }
  });
</script>

  <%- include("../partials/user/footer.ejs") %>