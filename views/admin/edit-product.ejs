<%- include("../partials/admin/header.ejs") %>

<link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" rel="stylesheet" />

<style>
* { box-sizing: border-box; }
body { font-family: Inter, sans-serif; background: #f9f9f9; }
.main-content { margin-left: 240px; margin-top: 60px; padding: 20px; min-height: 100vh; }
.container { max-width: 1100px; background: #fff; padding: 25px; border-radius: 12px; margin: auto; box-shadow: 0 0 10px rgba(0,0,0,0.08); }
h2 { text-align: center; margin-bottom: 20px; }
.form-wrapper { display: flex; flex-wrap: wrap; gap: 30px; }
.left, .right { flex: 1; min-width: 300px; }
.image-box img { width: 100%; border-radius: 10px; max-height: 250px; object-fit: cover; border: 1px solid #ddd; }
.image-buttons { display: flex; gap: 8px; margin-top: 8px; }
.save-btn { background: #007bff; color: #fff; border: none; padding: 6px 10px; border-radius: 6px; cursor: pointer; }
.cancel-btn { background: #dc3545; color: #fff; border: none; padding: 6px 10px; border-radius: 6px; cursor: pointer; }
label { font-weight: 600; margin-top: 10px; display: block; }
input, textarea, select { width: 100%; padding: 10px; margin: 6px 0; border: 1px solid #ccc; border-radius: 6px; }
.variant-row { display: flex; gap: 8px; margin-bottom: 8px; align-items: center; }
.variant-row input { flex: 1; }
.button-row { display: flex; gap: 10px; margin-top: 16px; }
.btn-green { flex: 1; background: #28a745; color: #fff; border: none; padding: 12px; border-radius: 8px; cursor: pointer; }
.btn-red { flex: 1; background: #dc3545; color: #fff; border: none; padding: 12px; border-radius: 8px; cursor: pointer; }
.image-preview-container { display: flex; flex-wrap: wrap; gap: 10px; }
.image-box { position: relative; width: 120px; }
.preview-img { width: 100%; height: 100px; object-fit: cover; border-radius: 5px; border: 1px solid #ddd; }
@media(max-width:768px) { .main-content { margin-left: 0; } .button-row { flex-direction: column; } }
.alert { padding: 10px; margin-bottom: 12px; border-radius: 6px; }
.alert-success { background: #d4edda; color: #155724; }
.alert-danger { background: #f8d7da; color: #721c24; }
</style>

<div class="main-content">
  <div class="container">
    <h2>Edit Product</h2>

    <% if (successMessage) { %>
      <div class="alert alert-success"><%= successMessage %></div>
    <% } %>
    <% if (errorMessage) { %>
      <div class="alert alert-danger"><%= errorMessage %></div>
    <% } %>

    <form id="editProductForm" action="/admin/edit-product/<%= product._id %>" method="POST" enctype="multipart/form-data" onsubmit="return validateForm()">
      <div class="form-wrapper">

        <!-- LEFT: Images -->
        <div class="left">
          <% for (let i = 0; i < 4; i++) { 
               const img = product.images && product.images[i] ? product.images[i] : null;
               let previewSrc = '/photos/default.jpg';
               if (img) previewSrc = img.startsWith('http') || img.startsWith('data:') || img.startsWith('/') ? img : '/uploads/' + img;
          %>
            <div class="image-box" style="margin-bottom:14px;">
              <img id="preview-image-<%= i %>" src="<%= previewSrc %>" data-original-name="<%= img || '' %>" data-original-index="<%= img ? i : '' %>" class="preview-img" />
              <label>Choose image (slot <%= i+1 %>)</label>
              <input type="file" accept="image/*" class="product-image-input" data-slot="<%= i %>" />
              <div class="image-buttons">
                <button type="button" class="save-btn" data-slot="<%= i %>">Crop & Save</button>
                <button type="button" class="cancel-btn" onclick="resetImage(<%= i %>)">Reset</button>
                <% if (img) { %>
                  <button type="button" class="cancel-btn" onclick="markDeleteExisting(<%= i %>)">Delete</button>
                <% } %>
              </div>
            </div>
          <% } %>
          <input type="hidden" name="deletedImages" id="deletedImages" value=""/>
        </div>

        <!-- RIGHT: Product info + variants -->
        <div class="right">
          <label>Product Name</label>
          <input type="text" name="productName" value="<%= product.productName %>" required />

          <label>Brand</label>
          <select name="brand" required>
            <option value="">-- Select Brand --</option>
            <% brands.forEach(b => { %>
              <option value="<%= b._id %>" <%= (product.brand && (product.brand._id ? product.brand._id.toString() : product.brand.toString()) === b._id.toString()) ? 'selected' : '' %>><%= b.brandName || b.name %></option>
            <% }) %>
          </select>

          <label>Category</label>
          <select name="category" required>
            <option value="">-- Select Category --</option>
            <% cat.forEach(c => { %>
              <option value="<%= c._id %>" <%= (product.category && (product.category._id ? product.category._id.toString() : product.category.toString()) === c._id.toString()) ? 'selected' : '' %>><%= c.name %></option>
            <% }) %>
          </select>

          <label>Short Description</label>
          <textarea name="description" rows="3" required><%= product.description %></textarea>

           <label>Long Description</label>
          <textarea name="Longdescription" rows="3" required><%= product.Longdescription %></textarea>

          <label>Variants</label>
          <div id="variants-wrapper">
            <% if (product.variants && product.variants.length > 0) { %>
              <% product.variants.forEach(v => { %>
                <div class="variant-row">
                  <input type="number" name="variantSize[]" placeholder="Size (ml)" value="<%= v.size %>" required />
                  <input type="number" name="variantStock[]" placeholder="Stock" value="<%= v.stock %>" min="0" required />
                  <input type="number" name="variantRegularPrice[]" placeholder="Regular Price" step="0.01" value="<%= v.regularPrice %>" required />
                  <input type="number" name="variantSalePrice[]" placeholder="Sale Price" step="0.01" value="<%= v.salePrice %>" required />
                  <button type="button" onclick="removeVariantRow(this)">Remove</button>
                </div>
              <% }) %>
            <% } else { %>
              <div class="variant-row">
                <input type="number" name="variantSize[]" placeholder="Size (ml)" required />
                <input type="number" name="variantStock[]" placeholder="Stock" min="0" required />
                <input type="number" name="variantRegularPrice[]" placeholder="Regular Price" step="0.01" required />
                <input type="number" name="variantSalePrice[]" placeholder="Sale Price" step="0.01" required />
                <button type="button" onclick="removeVariantRow(this)">Remove</button>
              </div>
            <% } %>
          </div>
          <button type="button" onclick="addVariantRow()" style="margin-top:8px;">Add Variant</button>

          <div class="button-row">
            <button class="btn-green" type="submit">Update</button>
            <button class="btn-red" type="button" onclick="window.location.href='/admin/products'">Cancel</button>
          </div>
        </div>

      </div>
    </form>
  </div>
</div>

<!-- Cropper Modal & Script -->
<div id="cropper-modal" style="display:none;position:fixed;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,0.75);z-index:9999;align-items:center;justify-content:center;">
  <div style="background:#fff;padding:12px;border-radius:8px;max-width:90%;max-height:90%;text-align:center;overflow:auto;">
    <h4>Crop image</h4>
    <img id="cropper-image" src="" style="max-width:100%;max-height:70vh;display:block;margin:8px auto;" />
    <div style="margin-top:8px;">
      <button type="button" class="save-btn" id="cropper-save">Crop & Use</button>
      <button type="button" class="cancel-btn" id="cropper-cancel">Cancel</button>
    </div>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
<script>
let cropper=null,currentSlot=null;
const modal=document.getElementById('cropper-modal');
const cropperImage=document.getElementById('cropper-image');
const deletedIndexes=new Set();

function updateDeletedHidden(){ document.getElementById('deletedImages').value=Array.from(deletedIndexes).join(','); }

function markDeleteExisting(slot){
  const preview=document.getElementById(`preview-image-${slot}`);
  deletedIndexes.add(Number(slot));
  updateDeletedHidden();
  preview.src='/photos/default.jpg';
  preview.removeAttribute('data-original-name');
  preview.removeAttribute('data-original-index');
  document.querySelectorAll(`input[name="productImagesBase64[]"][data-slot="${slot}"]`).forEach(el=>el.remove());
}

function resetImage(slot){
  const preview=document.getElementById(`preview-image-${slot}`);
  const origName=preview.getAttribute('data-original-name');
  if(origName){
    preview.src=origName.startsWith('http')||origName.startsWith('data:')||origName.startsWith('/')?origName:'/uploads/'+origName;
    deletedIndexes.delete(Number(slot));
  }else{
    preview.src='/photos/default.jpg';
    deletedIndexes.delete(Number(slot));
  }
  document.querySelectorAll(`input[name="productImagesBase64[]"][data-slot="${slot}"]`).forEach(el=>el.remove());
  updateDeletedHidden();
}

document.querySelectorAll('.save-btn').forEach(btn=>{
  btn.addEventListener('click',()=>{
    const slot=btn.getAttribute('data-slot');
    const fileInput=document.querySelector(`.product-image-input[data-slot="${slot}"]`);
    if(!fileInput||!fileInput.files[0]){ alert('Choose an image first'); return; }
    const reader=new FileReader();
    reader.onload=e=>{
      cropperImage.src=e.target.result;
      currentSlot=Number(slot);
      modal.style.display='flex';
      setTimeout(()=>{ if(cropper)cropper.destroy(); cropper=new Cropper(cropperImage,{aspectRatio:1,viewMode:1,autoCropArea:1}); },80);
    };
    reader.readAsDataURL(fileInput.files[0]);
  });
});

document.getElementById('cropper-save').addEventListener('click',()=>{
  if(!cropper) return;
  const canvas=cropper.getCroppedCanvas({width:800,height:800});
  const dataUrl=canvas.toDataURL('image/jpeg',0.9);
  const preview=document.getElementById(`preview-image-${currentSlot}`);
  const origIdx=preview.getAttribute('data-original-index');
  if(origIdx) deletedIndexes.add(Number(origIdx));
  preview.src=dataUrl;

  // remove existing hidden inputs
  document.querySelectorAll(`input[name="productImagesBase64[]"][data-slot="${currentSlot}"]`).forEach(el=>el.remove());

  const hidden=document.createElement('input');
  hidden.type='hidden';
  hidden.name='productImagesBase64[]';
  hidden.value=dataUrl;
  hidden.setAttribute('data-slot',currentSlot);
  document.getElementById('editProductForm').appendChild(hidden);
  updateDeletedHidden();
  closeCropper();
});

document.getElementById('cropper-cancel').addEventListener('click',closeCropper);
function closeCropper(){ modal.style.display='none'; if(cropper){ cropper.destroy(); cropper=null; } }

function addVariantRow(){
  const wrapper=document.getElementById('variants-wrapper');
  const row=document.createElement('div');
  row.className='variant-row';
  row.innerHTML=`
    <input type="number" name="variantSize[]" placeholder="Size (ml)" required />
    <input type="number" name="variantStock[]" placeholder="Stock" min="0" required />
    <input type="number" name="variantRegularPrice[]" placeholder="Regular Price" step="0.01" required />
    <input type="number" name="variantSalePrice[]" placeholder="Sale Price" step="0.01" required />
    <button type="button" onclick="removeVariantRow(this)">Remove</button>
  `;
  wrapper.appendChild(row);
}
function removeVariantRow(btn){ btn.parentElement.remove(); }

function validateForm(){
  let existingCount=0;
  for(let i=0;i<4;i++){
    const preview=document.getElementById(`preview-image-${i}`);
    if(preview.getAttribute('data-original-name')) existingCount++;
  }
  const newCount=document.querySelectorAll('input[name="productImagesBase64[]"]').length;
  if((existingCount+newCount-deletedIndexes.size)<1){ alert('At least one image required'); return false; }
  if((existingCount+newCount-deletedIndexes.size)>4){ alert('Max 4 images allowed'); return false; }
  if(document.getElementsByName('variantSize[]').length===0){ alert('Add at least one variant'); return false; }
  updateDeletedHidden();
  return true;
}
</script>
