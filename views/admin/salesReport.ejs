<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Sales Report - Admin Dashboard</title>
        <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
        <link
            href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
            rel="stylesheet">
        <style>
       
        :root {
            --sidebar-width: 260px;
            --primary: #3a8869;
            --primary-dark: #a24b83;
            --primary-gradient: linear-gradient(135deg, #5ab344 0%, #51b144 100%);
            --success: #38a169;
            --warning: #ed8936;
            --bg-body: #f8fafc;
            --shadow-sm: 0 2px 4px rgba(0,0,0,0.05);
            --shadow-md: 0 10px 15px -3px rgba(0,0,0,0.1);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg-body);
            color: #1a202c;
            min-height: 100vh;
            overflow-x: hidden;
        }

    

        .main-content {
    margin-left: 240px;
    margin-top: 60px;
    width: calc(100% - 240px);
    padding: 20px;
}

        .container { max-width: 1600px; margin: 0 auto; padding-top: 60px; }


        @media (max-width: 768px) {
  .main-content {
    margin-left: 0;
    width: 100%;
  }
}
       
        .header {
            background: white; padding: 24px; border-radius: 16px; margin-bottom: 24px;
            box-shadow: var(--shadow-sm); display: flex; justify-content: space-between;
            align-items: center; flex-wrap: wrap; gap: 15px;
        }

        .btn {
            padding: 10px 20px; border-radius: 10px; font-size: 0.85rem; font-weight: 600;
            cursor: pointer; transition: all 0.2s; display: inline-flex; align-items: center; gap: 8px;
            border: none; text-decoration: none;
        }
        .btn-primary { background: var(--primary-gradient); color: white; }
        .btn-success { background: var(--success); color: white; }
        .btn-warning { background: var(--warning); color: white; }
        
        /* View Products Button UI */
        .btn-view {
            background: #f1f5f9; color: var(--primary); padding: 6px 12px; font-size: 0.75rem;
            border: 1px solid #e2e8f0; border-radius: 8px; width: auto; font-weight: 600;
        }
        .btn-view:hover { background: var(--primary); color: white; border-color: var(--primary); }

        /* --- Filter Section --- */
        .filter-section { background: white; padding: 25px; border-radius: 16px; margin-bottom: 24px; box-shadow: var(--shadow-sm); }
        .quick-filters { display: grid; grid-template-columns: repeat(auto-fit, minmax(110px, 1fr)); gap: 10px; margin-bottom: 20px; }
        .filter-btn {
            padding: 10px; border: 1.5px solid #e2e8f0; background: white; border-radius: 10px;
            font-size: 0.85rem; font-weight: 500; cursor: pointer; color: #2c5f4b; transition: 0.2s;
        }
        .filter-btn.active { background: var(--primary); color: white; border-color: var(--primary); }

        .filter-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 20px; }
        .filter-group { display: flex; flex-direction: column; gap: 6px; }
        .filter-group label { font-size: 0.75rem; font-weight: 700; color: #718096; text-transform: uppercase; }
        .filter-group input, .filter-group select { padding: 12px; border: 1.5px solid #e2e8f0; border-radius: 10px; outline: none; }
        .filter-group input:focus { border-color: var(--primary); }

        /* --- Stats Cards --- */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 24px; }
        .stat-card { background: white; padding: 20px; border-radius: 16px; border-left: 4px solid var(--primary); box-shadow: var(--shadow-sm); }
        .stat-card h3 { font-size: 0.75rem; color: #718096; text-transform: uppercase; margin-bottom: 5px; }
        .stat-value { font-size: 1.5rem; font-weight: 700; }

        /* --- Table --- */
        .table-wrapper { background: white; border-radius: 16px; box-shadow: var(--shadow-sm); overflow: hidden; }
        .table-header { padding: 20px 24px; border-bottom: 1px solid #f1f5f9; display: flex; justify-content: space-between; align-items: center; }
        .table-scroll { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; min-width: 1000px; }
        th { padding: 15px; text-align: left; background: #f8fafc; font-size: 0.75rem; color: #64748b; text-transform: uppercase; }
        td { padding: 15px; border-bottom: 1px solid #f1f5f9; font-size: 0.9rem; }

        /* --- Pagination Correct Fix --- */
        .pagination-wrapper { 
            padding: 20px; display: flex; justify-content: center; align-items: center; 
            border-top: 1px solid #f1f5f9; background: #fff;
        }
        .pagination { display: flex; align-items: center; gap: 5px; list-style: none; }
        .pagination a, .pagination span {
            min-width: 38px; height: 38px; display: flex; align-items: center; justify-content: center;
            text-decoration: none; color: #4a5568; border-radius: 8px; border: 1px solid #e2e8f0; font-weight: 500; transition: 0.2s;
        }
        .pagination a:hover { background: #f8fafc; border-color: var(--primary); color: var(--primary); }
        .pagination .active span { background: var(--primary); color: white; border-color: var(--primary); }

        /* --- Modal --- */
        .modal { display: none; position: fixed; z-index: 3000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); backdrop-filter: blur(4px); }
        .modal.show { display: flex; align-items: center; justify-content: center; padding: 20px; }
        .modal-content { background: white; border-radius: 20px; width: 100%; max-width: 600px; max-height: 80vh; overflow: hidden; }
        .modal-header { padding: 20px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; }
        .modal-body { padding: 20px; overflow-y: auto; }

     @media print {
    .filter-section, .pagination-wrapper { display: none !important; }
    .main-content { margin-left: 0 !important; }
}

    </style>
    </head>
    <body>

        <%- include("../partials/admin/header.ejs") %>

        <div class="sidebar-overlay" onclick="toggleSidebar()"></div>

        <div class="main-content">

            <div class="container">
                <div class="header">
                    <div>
                        <h1>Sales Report</h1>
                        <p style="font-size: 0.8rem; color: #718096;">Overview
                            of your store's revenue</p>
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <a
                            href="/admin/salesReport/export-pdf?filterType=<%= filterType %>&startDate=<%= startDate %>&endDate=<%= endDate %>"
                            class="btn btn-warning">üìÑ PDF Export</a>
                        <a
                            href="/admin/salesReport/export-excel?filterType=<%= filterType %>&startDate=<%= startDate %>&endDate=<%= endDate %>"
                            class="btn btn-success">üìä Excel Export</a>
                    </div>
                </div>

                <% if (typeof showError !== 'undefined' && showError) { %>
                <div
                    style="background: #fff5f5; color: #c53030; padding: 15px; border-radius: 12px; margin-bottom: 20px; border: 1px solid #feb2b2;">
                    <%= errorMessage %>
                </div>
                <% } %>

                <div class="filter-section">
                    <form method="GET" id="filterForm"
                        onsubmit="handleFilterSubmit(event)">
                        <div class="quick-filters">
                            <button type="button"
                                class="filter-btn <%= filterType === 'daily' ? 'active' : '' %>"
                                onclick="setFilter('daily')">Daily</button>
                            <button type="button"
                                class="filter-btn <%= filterType === 'weekly' ? 'active' : '' %>"
                                onclick="setFilter('weekly')">Weekly</button>
                            <button type="button"
                                class="filter-btn <%= filterType === 'monthly' ? 'active' : '' %>"
                                onclick="setFilter('monthly')">Monthly</button>
                            <button type="button"
                                class="filter-btn <%= filterType === 'yearly' ? 'active' : '' %>"
                                onclick="setFilter('yearly')">Yearly</button>
                            <button type="button"
                                class="filter-btn <%= filterType === 'custom' ? 'active' : '' %>"
                                onclick="setFilter('custom')">Custom</button>
                        </div>

                        <input type="hidden" id="filterType" name="filterType"
                            value="<%= filterType %>">
                        <input type="hidden" id="page" name="page" value="1">

                        <div class="filter-grid">
                            <div class="filter-group">
                                <label>Start Date</label>
                                <input type="date" id="startDate"
                                    name="startDate" value="<%= startDate %>">
                            </div>
                            <div class="filter-group">
                                <label>End Date</label>
                                <input type="date" id="endDate" name="endDate"
                                    value="<%= endDate %>">
                            </div>
                            <div class="filter-group">
                                <label>Records</label>
                                <select id="limit" name="limit">
                                    <option value="10" <%=limit === 10 ?
                                        'selected' : '' %>>10 Rows</option>
                                    <option value="25" <%=limit === 25 ?
                                        'selected' : '' %>>25 Rows</option>
                                    <option value="50" <%=limit === 50 ?
                                        'selected' : '' %>>50 Rows</option>
                                </select>
                            </div>
                        </div>

                        <div style="display: flex; gap: 10px;">
                            <button type="submit" class="btn btn-primary">Apply
                                Filters</button>
                            <button type="button" class="btn"
                                style="background: #edf2f7;"
                                onclick="resetFilter()">Reset</button>
                        </div>
                    </form>
                </div>

                <div class="stats-grid">
                    <div class="stat-card"><h3>Orders</h3><div
                            class="stat-value"><%= totalOrders %></div></div>
                    <div class="stat-card"
                        style="border-color: var(--success);"><h3>Revenue</h3><div
                            class="stat-value">‚Çπ<%=
                            totalRevenue.toLocaleString('en-IN') %></div></div>
                    <div class="stat-card"
                        style="border-color: var(--warning);"><h3>Discount</h3><div
                            class="stat-value">‚Çπ<%=
                            totalDiscount.toLocaleString('en-IN') %></div></div>
                    <div class="stat-card"
                        style="border-color: #9f7aea;"><h3>Coupons</h3><div
                            class="stat-value"><%= totalCouponsApplied
                            %></div></div>
                </div>

                <div class="table-wrapper">
                    <div class="table-header">
                        <h2>Orders List</h2>
                        <span
                            style="font-size: 0.8rem; font-weight: 600; color: #718096;"><%=
                            totalOrders %> Total Orders</span>
                    </div>

                    <div class="table-scroll">
                        <table>
                            <thead>
                                <tr>
                                    <th>Order ID</th>
                                    <th>Customer</th>
                                    <th>Products</th>
                                    <th style="text-align: center;">Items</th>
                                    <th style="text-align: right;">Total</th>
                                    <th style="text-align: right;">Discount</th>
                                    <th style="text-align: right;">Final</th>
                                    <th>Payment</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                <% if (orders.length > 0) { %>
                                <% orders.forEach(order => { %>
                                <tr>
                                    <td><span
                                            style="font-weight: 600; color: var(--primary);">#<%=
                                            order.orderIdShort %></span></td>
                                    <td>
                                        <div style="font-weight: 600;"><%=
                                            order.user.name %></div>
                                        <div
                                            style="font-size: 0.7rem; color: #a0aec0;"><%=
                                            order.user.phone %></div>
                                    </td>
                                    <td>
                                        <button class="btn-view"
                                            onclick="showProductModal('<%= order._id %>')">
                                            <%= order.firstProduct %> <%=
                                            order.productCount > 1 ?
                                            '(+'+(order.productCount-1)+')' : ''
                                            %>
                                        </button>
                                    </td>
                                    <td style="text-align: center;"><%=
                                        order.totalItems %></td>
                                    <td style="text-align: right;">‚Çπ<%=
                                        order.totalPrice.toLocaleString('en-IN')
                                        %></td>
                                    <td
                                        style="text-align: right; color: var(--warning);">-‚Çπ<%=
                                        order.discount.toLocaleString('en-IN')
                                        %></td>
                                    <td
                                        style="text-align: right; font-weight: 700;">‚Çπ<%=
                                        order.finalAmount.toLocaleString('en-IN')
                                        %></td>
                                    <td><span style="font-size: 0.75rem;"><%=
                                            order.paymentMethod %></span></td>
                                    <td><span
                                            class="status-badge status-delivered"><%=
                                            order.status %></span></td>
                                </tr>
                                <% }); %>
                                <% } else { %>
                                <tr><td colspan="9"
                                        style="text-align: center; padding: 50px; color: #a0aec0;">No
                                        orders found.</td></tr>
                                <% } %>
                            </tbody>
                        </table>
                    </div>

                    <% if (orders.length > 0) { %>
                    <div class="pagination-wrapper">
                        <ul class="pagination">
                            <% if (hasPrevPage) { %>
                            <li><a
                                    href="?filterType=<%= filterType %>&startDate=<%= startDate %>&endDate=<%= endDate %>&page=<%= currentPage - 1 %>&limit=<%= limit %>">‚ùÆ</a></li>
                            <% } %>

                            <% for(let i=1; i<=totalPages; i++) { %>
                            <li
                                class="<%= i === currentPage ? 'active' : '' %>">
                                <% if(i === currentPage) { %> <span><%= i
                                    %></span> <% } else { %>
                                <a
                                    href="?filterType=<%= filterType %>&startDate=<%= startDate %>&endDate=<%= endDate %>&page=<%= i %>&limit=<%= limit %>"><%=
                                    i %></a>
                                <% } %>
                            </li>
                            <% } %>

                            <% if (hasNextPage) { %>
                            <li><a
                                    href="?filterType=<%= filterType %>&startDate=<%= startDate %>&endDate=<%= endDate %>&page=<%= currentPage + 1 %>&limit=<%= limit %>">‚ùØ</a></li>
                            <% } %>
                        </ul>
                    </div>
                    <% } %>
                </div>
            </div>
        </div>

        <div id="productModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 style="font-size: 1rem; font-weight: 700;">Order
                        Details</h2>
                    <button onclick="closeProductModal()"
                        style="background: none; border: none; font-size: 1.5rem; cursor: pointer;">&times;</button>
                </div>
                <div class="modal-body" id="modalBody"></div>
            </div>
        </div>

        <script>
        const ordersData = <%- JSON.stringify(orders) %>;

       

        function showProductModal(orderId) {
            const order = ordersData.find(o => o._id === orderId);
            if (!order) return;
            let html = `<div style="background: #f8fafc; padding: 15px; border-radius: 12px; margin-bottom: 15px;">
                <p style="font-size: 0.7rem; font-weight: 700; color: #64748b; text-transform: uppercase;">Customer</p>
                <p style="font-weight: 700;">${order.user.name}</p>
            </div>`;
            order.orderItems.forEach(item => {
                html += `<div style="display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #f1f5f9;">
                    <p style="font-size: 0.9rem; font-weight: 500;">${item.productName} (x${item.quantity})</p>
                    <p style="font-weight: 700; color: var(--success);">‚Çπ${item.price.toLocaleString('en-IN')}</p>
                </div>`;
            });
            document.getElementById('modalBody').innerHTML = html;
            document.getElementById('productModal').classList.add('show');
        }

        function closeProductModal() { document.getElementById('productModal').classList.remove('show'); }

        function setFilter(type) {
            document.getElementById('filterType').value = type;
            const isCustom = type === 'custom';
            document.getElementById('startDate').disabled = !isCustom;
            document.getElementById('endDate').disabled = !isCustom;
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
        }

        function resetFilter() { window.location.href = '/admin/salesReport'; }

        function handleFilterSubmit(event) {
            const type = document.getElementById('filterType').value;
            if (type === 'custom' && (!document.getElementById('startDate').value || !document.getElementById('endDate').value)) {
                event.preventDefault();
                Swal.fire({ icon: 'error', title: 'Missing Dates', text: 'Select both start and end dates.' });
            }
        }

        window.onload = () => {
            if(document.getElementById('filterType').value !== 'custom') {
                document.getElementById('startDate').disabled = true;
                document.getElementById('endDate').disabled = true;
            }
        };
    </script>
    </body>
</html>