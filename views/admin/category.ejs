<%- include("../partials/admin/header.ejs") %>

<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="csrf-token" content="<%= locals.csrfToken || '' %>">
    <title>Categories Management</title>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet">
    <link rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
    :root {
      --primary-color: #4f46e5;
      --bg-color: #f3f4f6;
      --card-bg: #ffffff;
      --text-main: #1f2937;
      --text-muted: #6b7280;
    }

    body {
      background-color: var(--bg-color);
      font-family: 'Inter', 'Segoe UI', sans-serif;
      color: var(--text-main);
    }

    .main-content {
      padding: 2rem;
      width: 100%;
    }

    /* Card Styling */
    .content-card {
      background: var(--card-bg);
      border-radius: 16px;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      padding: 1.5rem;
      margin-bottom: 2rem;
    }

    /* Header Layout */
    .page-header {
      display: flex;
      flex-direction: column;
      gap: 1rem;
      margin-bottom: 2rem;
    }

    @media (min-width: 768px) {
      .page-header {
        flex-direction: row;
        justify-content: space-between;
        align-items: center;
      }
      .header-actions {
        display: flex;
        gap: 1rem;
        align-items: center;
      }
    }

    /* Add Button */
    .btn-custom-add {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      font-weight: 600;
      white-space: nowrap; /* Keeps text on one line */
      transition: all 0.3s ease;
      box-shadow: 0 4px 6px rgba(16, 185, 129, 0.2);
    }
    .btn-custom-add:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 12px rgba(16, 185, 129, 0.3);
      color: white;
    }

    /* Search Bar */
    .search-wrapper {
      position: relative;
      min-width: 250px;
    }
    .search-wrapper input {
      padding-right: 40px;
      border-radius: 8px;
      border: 1px solid #e5e7eb;
    }
    .search-wrapper button {
      position: absolute;
      right: 5px;
      top: 50%;
      transform: translateY(-50%);
      background: none;
      border: none;
      color: var(--text-muted);
    }

    /* --- TABLE FIXES FOR SCROLLING --- */
    .table-responsive {
      border-radius: 8px;
      /* IMPORTANT: overflow-x: auto enables horizontal scrolling */
      overflow-x: auto; 
      -webkit-overflow-scrolling: touch; /* Smooth scrolling on iOS */
      border: 1px solid #e5e7eb;
    }
    
    .table {
      margin-bottom: 0;
      vertical-align: middle;
      /* Optional: Force minimum width to ensure layout looks good before scrolling triggers */
      min-width: 800px; 
    }
    
    .table th, .table td {
      padding: 1rem;
      /* IMPORTANT: Prevents text from wrapping and breaking layout on small screens */
      white-space: nowrap; 
    }

    .table thead th {
      background-color: #f9fafb;
      font-weight: 600;
      text-transform: uppercase;
      font-size: 0.75rem;
      letter-spacing: 0.05em;
      color: var(--text-muted);
      border-bottom: 2px solid #e5e7eb;
    }

    /* Images */
    .category-img {
      width: 50px;
      height: 50px;
      object-fit: cover;
      border-radius: 6px;
      border: 1px solid #e5e7eb;
    }
    .no-img-placeholder {
      width: 50px;
      height: 50px;
      background: #f3f4f6;
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.6rem;
      color: var(--text-muted);
      border: 1px dashed #d1d5db;
    }

    /* Modal Styling */
    .modal-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(4px);
      z-index: 1050;
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    .modal-overlay.show {
      display: flex;
      opacity: 1;
    }
    .custom-modal {
      background: white;
      width: 90%;
      max-width: 500px;
      margin: auto;
      border-radius: 16px;
      padding: 2rem;
      position: relative;
      transform: translateY(20px);
      transition: transform 0.3s ease;
      max-height: 90vh;
      overflow-y: auto;
    }
    .modal-overlay.show .custom-modal {
      transform: translateY(0);
    }
    .modal-close-btn {
      position: absolute;
      top: 1rem;
      right: 1.5rem;
      font-size: 1.5rem;
      cursor: pointer;
      color: var(--text-muted);
    }

    /* Mobile Adjustments */
    @media (max-width: 768px) {
      .main-content { padding: 1rem; }
      .content-card { padding: 1rem; }
      .header-actions { flex-direction: column; width: 100%; }
      .search-wrapper, .btn-custom-add { width: 100%; }
    }
  </style>
  </head>
  <body>

    <div class="main-content">
      <div class="content-card">

        <div class="page-header">
          <div>
            <h2 class="fw-bold m-0">Categories</h2>
            <p class="text-muted small m-0">Manage your product categories</p>
          </div>

          <div class="header-actions">
            <form method="get" action="/admin/category"
              class="search-wrapper m-0">
              <input
                type="text"
                class="form-control"
                name="search"
                placeholder="Search categories..."
                value="<%= typeof search !== 'undefined' ? search : '' %>">
              <button type="submit"><i class="fas fa-search"></i></button>
              <% if (search && search.trim() !== "") { %>
              <a href="/admin/category" class="position-absolute"
                style="right: 45px; top: 50%; transform: translateY(-50%); color: #ef4444;"><i
                  class="fas fa-times"></i></a>
              <% } %>
            </form>

            <button class="btn-custom-add" onclick="openModal()">
              <i class="fas fa-plus me-2"></i>Add Category
            </button>
          </div>
        </div>

        <% if (typeof message !== 'undefined' && message) { %>
        <div class="alert alert-warning text-center" role="alert">
          <%= message %>
        </div>
        <% } %>

        <div class="table-responsive">
          <table class="table table-hover">
            <thead>
              <tr>
                <th scope="col" class="text-center" style="width: 50px;">#</th>
                <th scope="col">Category</th>
                <th scope="col">Description</th>
                <th scope="col" class="text-center">Offer</th>
                <th scope="col" class="text-center">Status</th>
                <th scope="col" class="text-center">Actions</th>
              </tr>
            </thead>
            <tbody>
              <% cat.forEach((category, index) => { %>
              <tr>
                <td class="text-center"><%= (currentPage - 1) * 4 + index + 1
                  %></td>
                <td>
                  <div class="d-flex align-items-center">
                    <% if (category.image) { %>
                    <img src="<%= category.image %>" alt="Img"
                      class="category-img me-3">
                    <% } else { %>
                    <div class="no-img-placeholder me-3">No Img</div>
                    <% } %>
                    <span class="fw-semibold"><%= category.name %></span>
                  </div>
                </td>
                <td>
                  <button class="btn btn-sm btn-outline-secondary"
                    onclick="viewDescription('<%= category.description %>')">
                    <i class="fas fa-eye me-1"></i> View
                  </button>
                </td>
                <td class="text-center">
                  <div class="d-flex flex-column align-items-center gap-1">
                    <span class="badge bg-secondary mb-1"><%=
                      category.categoryOffer ? category.categoryOffer + "%" :
                      "0%" %></span>
                    <% if (category.categoryOffer === 0 ||
                    !category.categoryOffer) { %>
                    <button onclick="addOffer('<%= category._id %>')"
                      class="btn btn-xs btn-outline-success py-0 px-2"
                      style="font-size: 0.75rem;">Add</button>
                    <% } else { %>
                    <button onclick="removeOffer('<%= category._id %>')"
                      class="btn btn-xs btn-outline-danger py-0 px-2"
                      style="font-size: 0.75rem;">Remove</button>
                    <% } %>
                  </div>
                </td>
                <td class="text-center">
                  <% if (category.isListed) { %>
                  <span
                    class="badge bg-success bg-opacity-10 text-success px-3 py-2 rounded-pill">Listed</span>
                  <% } else { %>
                  <span
                    class="badge bg-danger bg-opacity-10 text-danger px-3 py-2 rounded-pill">Unlisted</span>
                  <% } %>
                </td>
                <td class="text-center">
                  <div class="d-flex justify-content-center gap-2">
                    <form class="list-toggle-form m-0">
                      <input type="hidden" name="categoryId"
                        value="<%= category._id %>">
                      <% if (category.isListed) { %>
                      <button type="button"
                        class="btn btn-sm btn-outline-danger list-toggle-btn"
                        data-action="unlist" title="Unlist">
                        <i class="fas fa-ban"></i>
                      </button>
                      <% } else { %>
                      <button type="button"
                        class="btn btn-sm btn-outline-success list-toggle-btn"
                        data-action="list" title="List">
                        <i class="fas fa-check"></i>
                      </button>
                      <% } %>
                    </form>
                    <a href="/admin/editCategory?id=<%= category._id %>"
                      class="btn btn-sm btn-outline-primary" title="Edit">
                      <i class="fas fa-edit"></i>
                    </a>
                  </div>
                </td>
              </tr>
              <% }); %>
            </tbody>
          </table>
        </div>

        <% if (totalPages > 1) { %>
        <div class="mt-4 d-flex justify-content-center gap-2">
          <% if (currentPage > 1) { %>
          <a href="?page=<%= currentPage - 1 %>"
            class="btn btn-sm btn-outline-secondary">&laquo; Prev</a>
          <% } %>

          <% for (let i = 1; i <= totalPages; i++) { %>
          <a href="?page=<%= i %>"
            class="btn btn-sm <%= i === currentPage ? 'btn-primary' : 'btn-outline-secondary' %>"><%=
            i %></a>
          <% } %>

          <% if (currentPage < totalPages) { %>
          <a href="?page=<%= currentPage + 1 %>"
            class="btn btn-sm btn-outline-secondary">Next &raquo;</a>
          <% } %>
        </div>
        <% } %>

      </div>
    </div>

    <div id="descriptionModal" class="modal-overlay">
      <div class="custom-modal">
        <span class="modal-close-btn"
          onclick="closeDescriptionModal()">&times;</span>
        <h4 class="mb-4 text-center fw-bold">Description</h4>
        <div id="descriptionContent" class="p-3 bg-light rounded border"></div>
      </div>
    </div>

    <div id="categoryModal" class="modal-overlay">
      <div class="custom-modal">
        <span class="modal-close-btn" onclick="closeModal()">&times;</span>
        <h4 class="mb-4 text-center fw-bold">Add New Category</h4>

        <form id="categoryForm" enctype="multipart/form-data">
          <div class="mb-3">
            <label class="form-label fw-semibold">Category Name</label>
            <input type="text" class="form-control" id="categoryName"
              name="name" placeholder="Name">
            <div id="name-error" class="text-danger small mt-1"
              style="display:none;"></div>
          </div>

          <div class="mb-3">
            <label class="form-label fw-semibold">Description</label>
            <textarea class="form-control" id="categoryDesc" name="description"
              rows="3" placeholder="Description"></textarea>
            <div id="description-error" class="text-danger small mt-1"
              style="display:none;"></div>
          </div>

          <div class="mb-3">
            <label class="form-label fw-semibold">Image</label>
            <div
              style="border: 2px dashed #d1d5db; padding: 20px; text-align: center; border-radius: 8px; cursor: pointer;"
              id="dropZone"
              onclick="document.getElementById('categoryImage').click()">
              <i class="fas fa-cloud-upload-alt text-primary mb-2"></i>
              <p class="m-0 text-muted small">Click to upload</p>
              <input type="file" id="categoryImage" name="image"
                accept="image/*" style="display: none;" />
            </div>
            <div class="text-center mt-2" id="previewContainer"
              style="display: none;">
              <img id="imagePreview"
                style="max-width: 100px; border-radius: 8px;" />
              <br>
              <button type="button" class="btn btn-sm btn-danger mt-2"
                onclick="removeImage(event)">Remove</button>
            </div>
            <div id="image-error" class="text-danger small mt-1"
              style="display:none;"></div>
          </div>

          <div class="d-grid gap-2">
            <button type="submit" class="btn btn-success">Save</button>
            <button type="button" class="btn btn-light"
              onclick="closeModal()">Cancel</button>
          </div>
        </form>
      </div>
    </div>

    <script>

    /* ================= IMAGE PREVIEW LOGIC ================= */
const imageInput = document.getElementById('categoryImage');
const imagePreview = document.getElementById('imagePreview');
const previewContainer = document.getElementById('previewContainer');
const dropZone = document.getElementById('dropZone');

// Triggered when admin selects a file
imageInput?.addEventListener('change', function() {
  const file = this.files[0];
  
  if (file) {
    const allowedTypes = ["image/jpeg", "image/png", "image/jpg", "image/webp"];
    if (!allowedTypes.includes(file.type)) {
      Swal.fire("Error", "Please select a valid image (JPG, PNG, WEBP)", "error");
      this.value = ""; // Clear the selection
      return;
    }

    const reader = new FileReader();
    reader.onload = function(e) {
      imagePreview.src = e.target.result;
      previewContainer.style.display = 'block'; // Show preview
      dropZone.style.display = 'none';         // Hide upload box
    }
    reader.readAsDataURL(file);
  }
});

/* ================= REMOVE IMAGE LOGIC ================= */
function removeImage(event) {
  event.preventDefault();
  event.stopPropagation();
  
  const imageInput = document.getElementById('categoryImage');
  const previewContainer = document.getElementById('previewContainer');
  const dropZone = document.getElementById('dropZone');
  
  imageInput.value = ""; // Clear file from input
  previewContainer.style.display = 'none';
  dropZone.style.display = 'block'; // Show upload box again
}
/* ================= OPEN / CLOSE ADD CATEGORY MODAL ================= */
function openModal() {
  document.getElementById("categoryModal").classList.add("show");
  document.body.style.overflow = "hidden";
}

function closeModal() {
  document.getElementById("categoryModal").classList.remove("show");
  document.body.style.overflow = "auto";
}

/* ================= ADD CATEGORY OFFER ================= */
async function addOffer(categoryId) {
  const { value: amount } = await Swal.fire({
    title: "Enter offer percentage (0–99)",
    input: "number",
    inputAttributes: { min: 0, max: 99 },
    showCancelButton: true
  });

  if (amount === null) return;

  fetch("/admin/addCategoryOffer", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ categoryId, percentage: parseInt(amount) })
  })
    .then(res => res.json())
    .then(data => {
      if (!data.status) {
        Swal.fire("Error", data.message, "error");
        return;
      }
      Swal.fire("Success", "Offer added", "success")
        .then(() => location.reload());
    });
}

/* ================= REMOVE CATEGORY OFFER ================= */
function removeOffer(categoryId) {
  Swal.fire({
    title: "Remove category offer?",
    icon: "warning",
    showCancelButton: true,
    confirmButtonText: "Yes"
  }).then(result => {
    if (!result.isConfirmed) return;

    fetch("/admin/removeCategoryOffer", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ categoryId })
    })
      .then(res => res.json())
      .then(data => {
        if (!data.status) {
          Swal.fire("Error", data.message, "error");
          return;
        }
        Swal.fire("Removed", "Offer removed", "success")
          .then(() => location.reload());
      });
  });
}

/* ================= LIST / UNLIST CATEGORY ================= */
document.querySelectorAll(".list-toggle-btn").forEach(btn => {
  btn.addEventListener("click", function () {
    const form = this.closest("form");
    const categoryId = form.querySelector("input").value;
    const action = this.dataset.action;

    const endpoint =
      action === "list"
        ? "/admin/listCategory"
        : "/admin/unlistCategory";

    fetch(endpoint, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ categoryId })
    })
      .then(res => res.json())
      .then(data => {
        if (!data.status) {
          Swal.fire("Error", data.message, "error");
          return;
        }
        Swal.fire("Success", `Category ${action}ed successfully`, "success")
          .then(() => location.reload());
      });
  });
});

/* ================= VIEW DESCRIPTION ================= */
function viewDescription(desc) {
  document.getElementById("descriptionContent").textContent =
    desc || "No description available";
  document.getElementById("descriptionModal").classList.add("show");
  document.body.style.overflow = "hidden";
}

function closeDescriptionModal() {
  document.getElementById("descriptionModal").classList.remove("show");
  document.body.style.overflow = "auto";
}

document.getElementById("categoryForm")?.addEventListener("submit", async function (e) {
  e.preventDefault();

  const nameInput = document.getElementById("categoryName");
  const descInput = document.getElementById("categoryDesc");
  const imageInput = document.getElementById("categoryImage");

  const nameErr = document.getElementById("name-error");
  const descErr = document.getElementById("description-error");
  const imgErr = document.getElementById("image-error");


  [nameErr, descErr, imgErr].forEach(el => {
    el.textContent = "";
    el.style.display = "none";
  });

  let valid = true;
  const name = nameInput.value.trim();
  const desc = descInput.value.trim();


  if (!name) {
    nameErr.textContent = "Category name is required";
    nameErr.style.display = "block";
    valid = false;
  } else if (!/^[A-Za-z\s]{3,20}$/.test(name)) {
    nameErr.textContent = "Only alphabets allowed (3–20 characters)";
    nameErr.style.display = "block";
    valid = false;
  }

 
  if (!desc) {
    descErr.textContent = "Description is required";
    descErr.style.display = "block";
    valid = false;
  } else if (desc.length < 5 || desc.length > 50) {
    descErr.textContent = "Description must be between 5 and 50 characters";
    descErr.style.display = "block";
    valid = false;
  }

  if (!imageInput.files.length) {
    imgErr.textContent = "Image is required";
    imgErr.style.display = "block";
    valid = false;
  } else {
    const file = imageInput.files[0];
    const allowedTypes = ["image/jpeg", "image/png", "image/jpg", "image/webp"];
    if (!allowedTypes.includes(file.type)) {
      imgErr.textContent = "Only JPG, PNG, or WEBP images are allowed (No PDFs/Docs)";
      imgErr.style.display = "block";
      valid = false;
    }
  }

  if (!valid) return;


  const formData = new FormData(this);

  try {
    const response = await fetch("/admin/addCategory", {
      method: "POST",
      body: formData 
    });

    const data = await response.json();

    if (response.ok && data.success) {
      Swal.fire({
        icon: 'success',
        title: 'Success!',
        text: data.message,
      }).then(() => {
        location.reload(); 
      });
    } else {
      
      Swal.fire({
        icon: 'error',
        title: 'Oops...',
        text: data.error || "Something went wrong",
      });
    }
  } catch (error) {
    Swal.fire({
      icon: 'error',
      title: 'Error',
      text: "Internal Server Error. Please try again.",
    });
  }
});
</script>

  </body>
</html>