<%- include("../partials/admin/header.ejs") %>

<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />

<style>
  .main-content { padding: 20px; width: 100%; }
  .page-title { font-size: 28px; font-weight: 700; margin-bottom: 20px; }
  .filter-sort-container { display: flex; flex-wrap: wrap; gap: 10px; align-items: center; justify-content: space-between; margin-bottom: 20px; }
  .filters { display: flex; flex-wrap: wrap; gap: 10px; align-items: center; }
  .filter-button, .dropdown, .add-product-btn { padding: 8px 12px; border-radius: 6px; border: 1px solid #ccc; background: white; font-size: 14px; cursor: pointer; }
  .add-product-btn { background: #459436; color: white; border: none; font-weight: bold; }
  .table-wrapper { width: 100%; overflow-x: auto; padding-top: 10px; }
  .product-table { width: 100%; border-collapse: collapse; background: white; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.05); }
  .product-table th, .product-table td { padding: 12px 16px; text-align: center; border-bottom: 1px solid #eee; }
  .product-table th { position: sticky; top: 0; background: #fff; z-index: 2; }
  .action-buttons { display: flex; gap: 8px; justify-content: center; }
  .btn { padding: 6px 12px; border-radius: 4px; font-size: 14px; font-weight: 500; }
  .edit-btn { background: #386f39; color: white; border: none; }
  .pagination .page-item.active .page-link { background: #35b2dc; color: white; border-color: #35b8dc; }
  .badge { font-size: 13px; padding: 4px 8px; }
</style>

<div class="main-content">
  <h1 class="page-title">Products</h1>

  <!-- Flash Messages -->
  <% if (successMessage && successMessage.length > 0) { %>
    <div class="alert alert-success"><%= successMessage %></div>
  <% } %>
  <% if (errorMessage && errorMessage.length > 0) { %>
    <div class="alert alert-danger"><%= errorMessage %></div>
  <% } %>

  <!-- Filters -->
  <form action="/admin/products" method="get" class="filter-sort-container">
    <div class="filters">
      <input type="text" name="search" placeholder="Search product..." class="dropdown" value="<%= search || '' %>" />
      <select name="category" class="dropdown">
        <option value="">All Categories</option>
        <% if (cat) { cat.forEach(c => { %>
          <option value="<%= c._id %>" <%= selectedCategory == c._id ? 'selected' : '' %>><%= c.name %></option>
        <% }) } %>
      </select>
      <select name="brand" class="dropdown">
        <option value="">All Brands</option>
        <% if (brands) { brands.forEach(b => { %>
          <option value="<%= b._id %>" <%= selectedBrand == b._id ? 'selected' : '' %>><%= b.brandName || b.name %></option>
        <% }) } %>
      </select>
      <button type="submit" class="filter-button">Apply</button>
      <button type="button" class="add-product-btn" onclick="window.location.href='/admin/add-product'">Add Product</button>
    </div>
  </form>

  <!-- Product Table -->
  <div class="table-wrapper">
    <table class="product-table">
      <thead>
        <tr>
          <th>Name</th>
          <th>Brand</th>
          <th>Category</th>
          <th>Variants (Size | Stock | Price)</th>
          <th>Offer %</th>
          <th>Offer Action</th>
          <th>Status</th>
          <th>Block/Unblock</th>
          <th>Edit</th>
          <th>Delete</th>
        </tr>
      </thead>
      <tbody>
        <% if (products && products.length > 0) { %>
          <% products.forEach(product => { %>
            <tr>
              <td><%= product.productName %></td>
              <td><%= product.brand ? (product.brand.brandName || product.brand.name) : 'N/A' %></td>
              <td><%= product.category ? product.category.name : 'N/A' %></td>
              <td>
                <% if (product.variants && product.variants.length > 0) { %>
                  <ul style="list-style:none; padding:0; margin:0;">
                    <% product.variants.forEach(v => { %>
                      <li><%= v.size %> ML | Stock = <%= v.stock %> |  SalePrice = â‚¹<%= v.salePrice.toFixed(2) %></li>
                    <% }) %>
                  </ul>
                <% } else { %>
                  No Variants
                <% } %>
              </td>
              <td><%= product.productOffer ? product.productOffer + '%' : '0%' %></td>
              <td>
                <% if (!product.productOffer) { %>
                  <button class="btn btn-info text-white" onclick="addOffer('<%= product._id %>')">Add</button>
                <% } else { %>
                  <button class="btn btn-danger text-white" onclick="removeOffer('<%= product._id %>')">Remove</button>
                <% } %>
              </td>
              <td>
                <% if (product.isBlocked) { %>
                  <span class="badge bg-danger">Blocked</span>
                <% } else { %>
                  <span class="badge bg-success">Active</span>
                <% } %>
              </td>
              <td>
                <% if (product.isBlocked) { %>
                  <form action="/admin/unblockProduct/<%= product._id %>" method="post">
                    <button class="btn btn-success btn-sm">Unblock</button>
                  </form>
                <% } else { %>
                  <form action="/admin/blockProduct/<%= product._id %>" method="post">
                    <button class="btn btn-danger btn-sm">Block</button>
                  </form>
                <% } %>
              </td>
              <td>
                <form action="/admin/edit-product/<%= product._id %>" method="get">
                  <button class="btn edit-btn">Edit</button>
                </form>
              </td>
              <td><button class="btn btn-danger btn-sm" onclick="confirmDelete('<%= product._id %>')">Delete</button></td>
            </tr>
          <% }) %>
        <% } else { %>
          <tr><td colspan="10">No products found</td></tr>
        <% } %>
      </tbody>
    </table>
  </div>

  <!-- Pagination -->
  <nav class="mt-3">
    <ul class="pagination justify-content-center">
      <% if (totalPages > 0) { for (let i=1; i<=totalPages; i++) { %>
        <li class="page-item <%= currentPage == i ? 'active' : '' %>">
          <a class="page-link" href="?page=<%= i %>&search=<%= search || '' %>&category=<%= selectedCategory || '' %>&brand=<%= selectedBrand || '' %>"><%= i %></a>
        </li>
      <% } } %>
    </ul>
  </nav>
</div>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
  // Alerts auto-hide
  setTimeout(()=>document.querySelectorAll('.alert').forEach(a=>a.style.display='none'),3000);

  async function addOffer(id) {
    const { value: percent } = await Swal.fire({
      title:'Add Offer (%)', input:'number', inputPlaceholder:'Enter %',
      showCancelButton:true, confirmButtonText:'Apply',
      inputValidator: v => (!v || v<=0) ? 'Enter valid %' : null
    });
    if(percent){
      const res = await fetch('/admin/addProductOffer',{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({productId:id,percentage:percent})
      });
      const result = await res.json();
      result.status ? Swal.fire('Done','Offer added!','success').then(()=>location.reload()) : Swal.fire('Error',result.message,'error');
    }
  }

  function removeOffer(id){
    Swal.fire({title:'Remove Offer?',showCancelButton:true,confirmButtonText:'Yes'}).then(async r=>{
      if(r.isConfirmed){
        const res = await fetch('/admin/removeProductOffer',{
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body:JSON.stringify({productId:id})
        });
        const result = await res.json();
        result.status ? Swal.fire('Removed!','Offer deleted.','success').then(()=>location.reload()) : Swal.fire('Error',result.message,'error');
      }
    });
  }

  function confirmDelete(id){
    Swal.fire({
      title:'Delete product?',
      text:'This cannot be undone!',
      icon:'warning',
      showCancelButton:true,
      confirmButtonText:'Yes delete!'
    }).then(r=>{
      if(r.isConfirmed){
        fetch(`/admin/deleteProduct/${id}`,{method:'POST'})
          .then(res=>res.ok?Swal.fire('Deleted!','Product removed.','success').then(()=>location.reload()):Swal.fire('Error','Delete failed.','error'));
      }
    });
  }
</script>
